# AI摄影师小程序 - 腾讯云SCF官方文档架构

## 📋 关键发现

基于腾讯云SCF官方文档分析：

### 1. Function URL 是正确的选择
- ✅ API网关触发器已于2024年7月停用，2025年6月完全下线
- ✅ Function URL是官方推荐的替代方案
- ✅ Web函数类型支持直接HTTP请求透传，性能更好
- ✅ 无需API网关转换，降低延迟和成本

### 2. 函数间调用的正确方式
- ✅ SCF函数间调用需要使用Invoke API（不是直接内部调用）
- ✅ 可以通过腾讯云SDK或HTTP API调用其他函数
- ✅ 支持 同步调用 和异步调用

### 3. 原项目架构优势保持
- ✅ Action路由模式完全可以在SCF中实现
- ✅ 单一入口 + 内部路由的设计哲学依然有效
- ✅ 可以充分利用SCF的长时运行优势（15分钟超时）

## 🏗️ 重新设计的架构

### 架构原则
1. **保持原项目的简洁性** - 不过度拆分微服务
2. **充分利用SCF优势** - 长时运行、高内存、并发处理
3. **最小化函数间调用** - 减少Invoke API的使用，降低延迟
4. **智能合并功能** - 相关功能放在同一函数中

### 函数结构设计

```
AI摄影师小程序 (基于官方文档的SCF架构)
├── api-gateway (Web函数) - 统一HTTP入口
│   ├── Function URL: https://xxx.scf.tencentcloudapi.com
│   ├── 用户认证和上下文处理
│   ├── Action路由分发
│   └── 直接处理简单操作
│
├── photography-service (Web函数) - 摄影业务核心
│   ├── Function URL: https://xxx.scf.tencentcloudapi.com
│   ├── 服装摄影生成（包含状态机）
│   ├── 姿势变换功能
│   ├── 作品管理和收藏
│   └── 直接调用AI API（无需内部函数调用）
│
├── fitting-service (Web函数) - 试衣业务核心
│   ├── Function URL: https://xxx.scf.tencentcloudapi.com
│   ├── 虚拟试衣生成（包含状态机）
│   ├── 试衣作品管理
│   └── 直接调用AI API（无需内部函数调用）
│
├── user-service (Web函数) - 用户管理
│   ├── Function URL: https://xxx.scf.tencentcloudapi.com
│   ├── 用户注册登录
│   ├── 积分系统
│   └── 用户资料管理
│
├── storage-service (Web函数) - 文件管理
│   ├── Function URL: https://xxx.scf.tencentcloudapi.com
│   ├── 文件上传和去重
│   ├── 权限控制
│   └── 腾讯云COS集成
│
└── data-service (Web函数) - 数据管理
    ├── Function URL: https://xxx.scf.tencentcloudapi.com
    ├── 场景数据管理
    ├── 提示词模板管理
    ├── AI模型配置
    └── 任务状态查询
```

### 请求流程设计

#### 方案一：统一入口 + 智能路由（推荐）
```
用户请求 → api-gateway Function URL →
├─ 直接处理：用户操作、数据查询
├─ Invoke API调用：photography-service、fitting-service
└─ 内部HTTP调用：storage-service、data-service
```

#### 方案二：直接服务调用（高性能）
```
小程序直接调用对应服务的Function URL
├─ 摄影相关 → photography-service
├─ 试衣相关 → fitting-service
├─ 用户操作 → user-service
└─ 文件操作 → storage-service
```

## 🔧 技术实现要点

### 1. Web函数配置（基于官方文档）
```yaml
functions:
  api-gateway:
    handler: api-gateway.main_handler
    type: web  # Web函数类型，自动启用Function URL
    memorySize: 512
    timeout: 30
    environment:
      variables:
        FUNCTION_TYPE: api-gateway
```

### 2. 函数入口格式（官方标准）
```javascript
// 正确的SCF入口函数格式
exports.main_handler = async (event, context) => {
  // Web函数直接接收HTTP请求
  const { path, httpMethod, headers, body } = event

  // 返回标准HTTP响应
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*'
    },
    body: JSON.stringify({
      success: true,
      data: result
    })
  }
}
```

### 3. 函数间调用（官方Invoke API）
```javascript
// 使用腾讯云SDK调用其他函数
const scf = require('@tencentcloud/scf-sdk')

async function callOtherFunction(functionName, payload) {
  try {
    const result = await scf.invoke({
      FunctionName: functionName,
      InvocationType: 'RequestResponse', // 同步调用
      Payload: JSON.stringify(payload)
    })
    return JSON.parse(result.Payload)
  } catch (error) {
    console.error('函数调用失败:', error)
    throw error
  }
}
```

## 📊 架构优势

### 相比原微信云开发：
1. **更高性能** - 2GB内存，15分钟超时
2. **更强并发** - 无单实例限制
3. **更低成本** - 按实际使用付费
4. **更好的扩展性** - 可独立扩展每个服务

### 相比过度拆分的微服务：
1. **更低延迟** - 减少不必要的函数间调用
2. **更简单部署** - 相关功能聚合，部署更简单
3. **更好维护** - 功能集中，调试更容易
4. **更少成本** - 减少函数调用开销

## 🎯 实施计划

### 阶段一：核心服务迁移
1. 创建 api-gateway 统一入口
2. 迁移 user-service 用户管理
3. 迁移 photography-service 摄影业务

### 阶段二：完整功能迁移
1. 迁移 fitting-service 试衣业务
2. 迁移 storage-service 文件管理
3. 迁移 data-service 数据管理

### 阶段三：优化和测试
1. 性能测试和优化
2. 完整功能测试
3. 生产环境部署

## 📝 配置文件示例

基于官方文档的正确配置：

```yaml
service: ai-photography-scf-official

provider:
  name: tencent
  runtime: Nodejs18.15
  region: ap-guangzhou
  stage: dev

functions:
  api-gateway:
    handler: api-gateway.main_handler
    type: web
    memorySize: 512
    timeout: 30

  photography-service:
    handler: photography-service.main_handler
    type: web
    memorySize: 2048
    timeout: 900

  # ... 其他函数配置
```

**这个架构完全基于腾讯云SCF官方文档，确保可以直接部署并充分利用SCF的优势！**