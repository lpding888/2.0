# AI摄影师小程序 - 腾讯云SCF部署配置
# 使用Function URL替代API网关触发器

service: ai-photography-scf

provider:
  name: tencent
  runtime: Nodejs18.15
  region: ap-guangzhou
  stage: dev
  credentials: ~/.tencentcloud/credentials.ini

  # 环境变量
  environment:
    MONGODB_URI: ${env:MONGODB_URI}
    REDIS_URI: ${env:REDIS_URI}
    JWT_SECRET: ${env:JWT_SECRET}
    WECHAT_APP_ID: ${env:WECHAT_APP_ID}
    WECHAT_APP_SECRET: ${env:WECHAT_APP_SECRET}
    COS_SECRET_ID: ${env:COS_SECRET_ID}
    COS_SECRET_KEY: ${env:COS_SECRET_KEY}
    COS_BUCKET: ${env:COS_BUCKET}
    COS_REGION: ${env:COS_REGION}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    GEMINI_API_KEY: ${env:GEMINI_API_KEY}
    SEEDREAM_API_KEY: ${env:SEEDREAM_API_KEY}
    DEEPSEEK_API_KEY: ${env:DEEPSEEK_API_KEY}
    BUSINESS_MODE: ${env:BUSINESS_MODE, 'hybrid'}

# 函数定义 - 使用Web函数类型 + Function URL
functions:

  # 统一API网关 - Web函数类型
  api-gateway:
    handler: api-gateway.main_handler
    description: 统一API网关 - 路由所有请求
    memorySize: 512
    timeout: 30
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: api-gateway

  # 用户管理服务 - Web函数类型
  user-service:
    handler: user-service.main_handler
    description: 用户管理 - 注册登录、积分系统
    memorySize: 256
    timeout: 30
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: user-service

  # AI生成服务 - Web函数类型
  ai-generation:
    handler: backend/ai-generation.main_handler
    description: AI生成服务 - 摄影和试衣
    memorySize: 2048
    timeout: 900  # 15分钟
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: ai-generation

  # 商业摄影服务 - Web函数类型
  photography-service:
    handler: backend/photography-service.main_handler
    description: 商业服装摄影服务
    memorySize: 2048
    timeout: 900  # 15分钟
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: photography-service

  # 虚拟试衣服务 - Web函数类型
  fitting-service:
    handler: backend/fitting-service.main_handler
    description: 虚拟试衣服务
    memorySize: 2048
    timeout: 900  # 15分钟
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: fitting-service

  # 场景管理服务 - Web函数类型
  scene-service:
    handler: backend/scene-service.main_handler
    description: 场景管理服务
    memorySize: 256
    timeout: 30
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: scene-service

  # 提示词生成服务 - Web函数类型
  prompt-service:
    handler: backend/prompt-service.main_handler
    description: 提示词生成服务
    memorySize: 256
    timeout: 30
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: prompt-service

  # 任务处理器 - Web函数类型
  task-processor:
    handler: backend/task-processor.main_handler
    description: 任务状态机处理器
    memorySize: 512
    timeout: 300  # 5分钟
    type: web  # Web函数类型，自动启用Function URL
    environment:
      variables:
        FUNCTION_TYPE: task-processor

# 插件配置
plugins:
  - serverless-tencent-scf
  - serverless-dotenv-plugin

# 输出配置 - Function URL地址
outputs:
  ApiGatewayUrl:
    Description: API网关Function URL地址
    Value:
      Fn::GetAtt: [api-gateway, Url]

  UserServiceUrl:
    Description: 用户服务Function URL地址
    Value:
      Fn::GetAtt: [user-service, Url]

  AiGenerationUrl:
    Description: AI生成服务Function URL地址
    Value:
      Fn::GetAtt: [ai-generation, Url]

  PhotographyServiceUrl:
    Description: 商业摄影服务Function URL地址
    Value:
      Fn::GetAtt: [photography-service, Url]

  FittingServiceUrl:
    Description: 虚拟试衣服务Function URL地址
    Value:
      Fn::GetAtt: [fitting-service, Url]

  SceneServiceUrl:
    Description: 场景管理服务Function URL地址
    Value:
      Fn::GetAtt: [scene-service, Url]

  PromptServiceUrl:
    Description: 提示词生成服务Function URL地址
    Value:
      Fn::GetAtt: [prompt-service, Url]

  TaskProcessorUrl:
    Description: 任务处理器Function URL地址
    Value:
      Fn::GetAtt: [task-processor, Url]

  ServiceName:
    Description: 服务名称
    Value: ${self:service}

  DeploymentRegion:
    Description: 部署区域
    Value: ${self:provider.region}

# 打包配置
package:
  individually: true
  exclude:
    - .git/**
    - node_modules/**
    - README.md
    - .env*
    - logs/**
    - docs/**
    - scripts/**
    - serverless.yml