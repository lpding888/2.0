# AI摄影师小程序 - SCF部署指南

## 概述

本指南详细介绍如何将AI摄影师小程序从微信云开发迁移到腾讯云SCF（Serverless Cloud Function）。

## 部署前准备

### 1. 环境要求

- Node.js 18.15+
- Serverless Framework V3
- 腾讯云账号
- MongoDB数据库
- Redis缓存（可选）

### 2. 工具安装

```bash
# 安装Serverless Framework
npm install -g serverless@3

# 安装项目依赖
npm install --legacy-peer-deps
```

### 3. 腾讯云凭证配置

创建凭证文件 `~/.tencentcloud/credentials.ini`：

```ini
[default]
tencent_secret_id = 你的SecretId
tencent_secret_key = 你的SecretKey
```

## 配置环境变量

### 1. 复制环境变量模板

```bash
cp .env.example .env
```

### 2. 编辑环境变量

编辑 `.env` 文件，填入真实的配置值：

```bash
# 数据库配置
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/ai-photography
REDIS_URI=redis://username:password@redis-cluster:6379

# 认证配置
JWT_SECRET=your-super-secret-jwt-key-here-change-in-production
WECHAT_APP_ID=your-wechat-mini-program-app-id
WECHAT_APP_SECRET=your-wechat-mini-program-app-secret

# 腾讯云存储配置
COS_SECRET_ID=your-tencent-cloud-secret-id
COS_SECRET_KEY=your-tencent-cloud-secret-key
COS_BUCKET=ai-photography-prod-1379020062
COS_REGION=ap-guangzhou

# AI 服务配置
OPENAI_API_KEY=sk-your-openai-api-key
GEMINI_API_KEY=your-gemini-api-key
SEEDREAM_API_KEY=your-seedream-api-key
DEEPSEEK_API_KEY=sk-your-deepseek-api-key

# 业务模式
BUSINESS_MODE=hybrid  # personal, commercial, hybrid
ENABLE_CATALOG_INTEGRATION=true
ENABLE_SUBSCRIPTION=true
```

## 部署步骤

### 1. 验证配置

```bash
# 运行预部署检查
powershell -ExecutionPolicy Bypass -File "scripts\预部署检查.ps1"
```

### 2. 部署服务

```bash
# 部署所有服务
sls deploy --verbose

# 或分步部署
sls deploy -f api-gateway
sls deploy -f user-service
sls deploy -f ai-generation-service
sls deploy -f photography-service
sls deploy -f fitting-service
```

### 3. 验证部署

部署完成后，检查输出中的Function URL：

```bash
# 测试API网关
curl -X GET "https://your-api-gateway-url/api/health"

# 测试用户服务
curl -X POST "https://your-user-service-url/user/register" \
  -H "Content-Type: application/json" \
  -d '{"openid":"test_openid"}'
```

## 数据迁移

### 1. 导出微信云数据

```javascript
// 在微信云开发控制台运行
const db = cloud.database()
const collections = ['users', 'works', 'task_queue', 'orders', 'credit_records']

collections.forEach(async (collectionName) => {
  const data = await db.collection(collectionName).get()
  console.log(`${collectionName}:`, JSON.stringify(data, null, 2))
})
```

### 2. 导入MongoDB

```bash
# 使用mongosh导入数据
mongosh "mongodb://your-connection-string" --file export-data.js
```

## 前端适配

### 1. 修改API调用

将微信云开发的调用方式改为HTTP请求：

```javascript
// 原调用方式
wx.cloud.callFunction({
  name: 'photography',
  data: { action: 'generate', ...params }
})

// 新调用方式
wx.request({
  url: 'https://your-api-gateway-url/api/photography/generate',
  method: 'POST',
  header: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  data: params,
  success: (res) => {
    if (res.data.success) {
      // 处理成功结果
    }
  }
})
```

### 2. 更新小程序配置

在 `app.json` 中更新域名配置：

```json
{
  "networkTimeout": {
    "request": 60000
  }
}
```

在 `project.config.json` 中设置合法域名：

```json
{
  "setting": {
    "urlCheck": false,
    "es6": true,
    "minified": true
  }
}
```

## 监控和维护

### 1. 查看日志

```bash
# 查看函数日志
sls logs -f api-gateway -t

# 查看特定函数
sls logs -f photography-service -t
```

### 2. 监控指标

- 函数执行次数
- 执行时长
- 错误率
- 并发数

### 3. 告警配置

在腾讯云控制台配置：

- 函数执行失败告警
- 执行超时告警
- 错误率过高告警

## 常见问题

### Q1: 部署失败 - 函数入口点错误

**解决方案**: 确保所有函数文件都使用 `exports.main_handler` 而不是 `exports.main`

### Q2: 环境变量未生效

**解决方案**: 检查 `.env` 文件是否在项目根目录，并重新部署

### Q3: 数据库连接失败

**解决方案**:
1. 检查 MongoDB 连接字符串
2. 确认网络白名单配置
3. 验证用户名密码

### Q4: AI服务调用失败

**解决方案**:
1. 检查 API 密钥是否正确
2. 确认API密钥有足够的额度
3. 检查网络连接

## 性能优化

### 1. 函数配置优化

```yaml
# 增加内存和超时时间
functions:
  ai-generation-service:
    memorySize: 2048MB
    timeout: 900s
    reservedConcurrency: 20
    provisioned: 1  # 预留实例
```

### 2. 缓存策略

- Redis缓存热点数据
- 场景数据缓存
- 用户会话缓存

### 3. 数据库优化

- 设置合适的索引
- 使用连接池
- 定期清理过期数据

## 回滚方案

### 1. 快速回滚

```bash
# 回滚到上一个版本
sls rollback --timestamp 20241021T120000Z
```

### 2. 数据备份

```bash
# 备份MongoDB数据
mongodump --uri="mongodb://your-connection-string" --out=./backup
```

## 联系支持

如果在部署过程中遇到问题，请：

1. 查看腾讯云SCF文档
2. 检查Serverless Framework日志
3. 联系技术支持团队

---

**部署完成后，您的AI摄影师小程序将获得：**
- 更长的执行时间（15分钟 vs 60秒）
- 更强的计算能力（最大2GB内存）
- 更好的并发处理能力
- 更专业的监控和日志系统
- 更低的成本（按需计费）