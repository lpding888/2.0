# AIæ‘„å½±ç³»ç»Ÿ - ä»£ç é—®é¢˜æ¸…å•å’Œä¿®å¤æ–¹æ¡ˆ

## æ£€æŸ¥æ—¶é—´
2025-01-12

## ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 1. âš ï¸ æ•°æ®åº“å­—æ®µåä¸ä¸€è‡´ - usersè¡¨ä¸»é”®é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- æ•°æ®åº“ `users` è¡¨çš„ä¸»é”®å­—æ®µåä¸º `id`
- ä½†åç«¯ä»£ç ä¸­å¤§é‡ä½¿ç”¨ `user_id` æ¥æŸ¥è¯¢å’Œæ›´æ–°usersè¡¨
- å…¶ä»–è¡¨ï¼ˆworks, task_queue, ordersç­‰ï¼‰çš„å¤–é”®å­—æ®µåä¸º `user_id`

**å½±å“èŒƒå›´**ï¼š
- `backend/src/routes/authRoutes.js` ç¬¬51, 64, 69è¡Œ
- `backend/src/routes/creditsRoutes.js` ç¬¬16è¡Œ
- æ‰€æœ‰æ¶‰åŠusersè¡¨æŸ¥è¯¢çš„ä»£ç 

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
ä¿®æ”¹æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼Œå°†usersè¡¨çš„ä¸»é”®ä» `id` æ”¹ä¸º `user_id`

```sql
-- ä¿®æ”¹å‰
CREATE TABLE `users` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  ...
  PRIMARY KEY (`id`),
  ...
)

-- ä¿®å¤å
CREATE TABLE `users` (
  `user_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  ...
  PRIMARY KEY (`user_id`),
  ...
)
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `database/init.sql` - usersè¡¨å®šä¹‰

---

### 2. âš ï¸ æ•°æ®åº“å­—æ®µç¼ºå¤± - worksè¡¨

**é—®é¢˜æè¿°**ï¼š
- æ•°æ®åº“ `works` è¡¨ç¼ºå°‘ `ai_description` å­—æ®µ
- ä½†ä»£ç ä¸­å¤šå¤„ä½¿ç”¨è¯¥å­—æ®µï¼ˆç”¨äºå­˜å‚¨AIç”Ÿæˆçš„å›¾ç‰‡æè¿°ï¼‰

**å½±å“èŒƒå›´**ï¼š
- `backend/src/app.js` ç¬¬111, 123è¡Œ
- å‰ç«¯é¡µé¢æ˜¾ç¤ºä½œå“æè¿°

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
åœ¨worksè¡¨ä¸­æ·»åŠ  `ai_description` å­—æ®µ

```sql
ALTER TABLE `works`
ADD COLUMN `ai_description` text COMMENT 'AIç”Ÿæˆçš„æè¿°' AFTER `model_used`;
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `database/init.sql` - worksè¡¨å®šä¹‰

---

### 3. âš ï¸ æ•°æ®åº“å­—æ®µç¼ºå¤± - usersè¡¨

**é—®é¢˜æè¿°**ï¼š
- æ•°æ®åº“ `users` è¡¨ç¼ºå°‘ä»¥ä¸‹å­—æ®µï¼š
  - `avatar_url` (ä»£ç ä¸­ä½¿ç”¨ `avatar_url`ï¼Œä½†è¡¨ä¸­æ˜¯ `avatar`)
  - `register_source` (æ³¨å†Œæ¥æº)
  - `status` (ä½¿ç”¨ENUMç±»å‹)

**å½±å“èŒƒå›´**ï¼š
- `backend/src/routes/authRoutes.js` ç¬¬38-46, 64è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
ä¿®æ”¹usersè¡¨å­—æ®µåå’Œæ·»åŠ ç¼ºå¤±å­—æ®µ

```sql
-- 1. é‡å‘½åå­—æ®µ
ALTER TABLE `users`
CHANGE COLUMN `avatar` `avatar_url` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL';

-- 2. æ·»åŠ ç¼ºå¤±å­—æ®µ
ALTER TABLE `users`
ADD COLUMN `register_source` varchar(50) DEFAULT NULL COMMENT 'æ³¨å†Œæ¥æº' AFTER `email`;

-- 3. ä¿®æ”¹statuså­—æ®µä¸ºENUMï¼ˆå¦‚æœå½“å‰ä¸æ˜¯ï¼‰
ALTER TABLE `users`
MODIFY COLUMN `status` enum('active','inactive') NOT NULL DEFAULT 'active' COMMENT 'çŠ¶æ€';
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `database/init.sql` - usersè¡¨å®šä¹‰

---

### 4. âš ï¸ æ•°æ®åº“å­—æ®µç¼ºå¤± - worksè¡¨

**é—®é¢˜æè¿°**ï¼š
- worksè¡¨ç¼ºå°‘ `work_id` å­—æ®µï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºå‰ç«¯å±•ç¤ºï¼‰
- ä»£ç ä¸­å¤šå¤„ä½¿ç”¨ work_id ä½œä¸ºä½œå“çš„å”¯ä¸€æ ‡è¯†

**å½±å“èŒƒå›´**ï¼š
- `backend/src/routes/worksRoutes.js` å¤šå¤„æŸ¥è¯¢
- å‰ç«¯æ‰€æœ‰ä½œå“ç›¸å…³é¡µé¢

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
æ·»åŠ  work_id å­—æ®µå¹¶è®¾ç½®ä¸º UUID

```sql
ALTER TABLE `works`
ADD COLUMN `work_id` varchar(50) NOT NULL COMMENT 'ä½œå“å”¯ä¸€æ ‡è¯†' AFTER `id`,
ADD UNIQUE KEY `uk_work_id` (`work_id`);

-- ä¸ºç°æœ‰æ•°æ®ç”Ÿæˆwork_id
UPDATE `works` SET `work_id` = UUID() WHERE `work_id` IS NULL OR `work_id` = '';
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `database/init.sql` - worksè¡¨å®šä¹‰

---

### 5. âš ï¸ æ•°æ®åº“å­—æ®µç±»å‹ä¸åŒ¹é… - usersè¡¨

**é—®é¢˜æè¿°**ï¼š
- usersè¡¨çš„ `role` å­—æ®µåœ¨æ•°æ®åº“ä¸­æ˜¯ varchar(20)
- ä½†ä»£ç ä¸­å°†å…¶ä½œä¸º ENUM ä½¿ç”¨ï¼ŒæœŸæœ›å€¼ä¸º 'user', 'vip', 'admin'

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
å°†roleå­—æ®µæ”¹ä¸ºENUMç±»å‹

```sql
ALTER TABLE `users`
MODIFY COLUMN `role` enum('user','vip','admin') NOT NULL DEFAULT 'user' COMMENT 'è§’è‰²';
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `database/init.sql` - usersè¡¨å®šä¹‰

---

## ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### 6. ğŸ“¦ å‰ç«¯ä¾èµ–ç¼ºå¤± - TypeScriptç±»å‹å®šä¹‰

**é—®é¢˜æè¿°**ï¼š
- `web/package.json` ç¼ºå°‘å¿…è¦çš„ @types åŒ…
- ä¼šå¯¼è‡´ TypeScript ç¼–è¯‘è­¦å‘Šæˆ–é”™è¯¯

**ç¼ºå¤±çš„åŒ…**ï¼š
- `@types/file-saver`
- `@types/jszip`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
åœ¨ `web/package.json` çš„ devDependencies ä¸­æ·»åŠ ï¼š

```json
{
  "devDependencies": {
    "@types/file-saver": "^2.0.5",
    "@types/jszip": "^3.4.1",
    ...
  }
}
```

**ä¿®å¤å‘½ä»¤**ï¼š
```bash
cd web
npm install --save-dev @types/file-saver @types/jszip
```

---

### 7. ğŸ”§ æ•°æ®åº“å­—æ®µç¼ºå¤± - credit_recordsè¡¨

**é—®é¢˜æè¿°**ï¼š
- credit_recordsè¡¨ç¼ºå°‘ `record_id` å­—æ®µ
- ä»£ç ä¸­ä½¿ç”¨ record_id ä½œä¸ºè®°å½•çš„æ ‡è¯†ç¬¦

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```sql
ALTER TABLE `credit_records`
CHANGE COLUMN `id` `record_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT;
```

---

### 8. ğŸ”§ æ•°æ®åº“å­—æ®µç¼ºå¤± - ordersè¡¨

**é—®é¢˜æè¿°**ï¼š
- ordersè¡¨ç¼ºå°‘ `paid_at` å­—æ®µï¼ˆæ”¯ä»˜æ—¶é—´ï¼‰
- adminé¡µé¢çš„orders.htmlä¸­éœ€è¦æ˜¾ç¤ºæ”¯ä»˜æ—¶é—´

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```sql
ALTER TABLE `orders`
ADD COLUMN `paid_at` datetime DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´' AFTER `status`;
```

---

### 9. ğŸ”§ æ•°æ®åº“å­—æ®µç¼ºå¤± - adminsè¡¨

**é—®é¢˜æè¿°**ï¼š
- adminsè¡¨å­—æ®µå‘½åéœ€è¦ç»Ÿä¸€
- ä¸»é”®åº”è¯¥æ˜¯ admin_id è€Œä¸æ˜¯ id

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```sql
ALTER TABLE `admins`
CHANGE COLUMN `id` `admin_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT;
```

---

### 10. ğŸ”§ ç¯å¢ƒå˜é‡ç¼ºå¤±

**é—®é¢˜æè¿°**ï¼š
- `.env.example` æ–‡ä»¶å¯èƒ½ç¼ºå°‘æŸäº›å¿…éœ€çš„ç¯å¢ƒå˜é‡

**éœ€è¦çš„ç¯å¢ƒå˜é‡**ï¼š
```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=ai_photo
DB_PASSWORD=Canbp3dFb5yPG28w
DB_NAME=ai_photo

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWTé…ç½®
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=7d

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APPID=your_appid
WECHAT_SECRET=your_secret

# n8né…ç½®
N8N_BASE_URL=http://localhost:5678/webhook

# AI APIé…ç½®
AI_API_URL=https://kuai.host
AI_API_KEY=sk-RG8U9pINNX8KTWhZxxxyfPzwTRUfRtXYtmdscR5ePPkhS2vq

# é»˜è®¤é…ç½®
DEFAULT_USER_CREDITS=10
```

---

## è½»å¾®é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

### 11. ğŸ’¡ ç®¡ç†åå°common.js - API Base URL

**é—®é¢˜æè¿°**ï¼š
- admin/assets/js/common.js ä¸­çš„ API_BASE_URL ç¡¬ç¼–ç 

**å»ºè®®**ï¼š
å¯ä»¥æ”¹ä¸ºä»é…ç½®æ–‡ä»¶è¯»å–æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡

---

### 12. ğŸ’¡ WebSocketè¿æ¥åœ°å€

**é—®é¢˜æè¿°**ï¼š
- web/lib/websocket.ts ä¸­ WebSocket åœ°å€å¯èƒ½éœ€è¦æ ¹æ®ç¯å¢ƒåŠ¨æ€é…ç½®

**å½“å‰ä»£ç **ï¼š
```typescript
const WS_URL = process.env.NEXT_PUBLIC_WS_URL || 'http://localhost:3000';
```

**å»ºè®®**ï¼š
åœ¨ `.env.example` ä¸­æ·»åŠ ï¼š
```env
NEXT_PUBLIC_API_URL=http://localhost:3000
NEXT_PUBLIC_WS_URL=http://localhost:3000
```

---

### 13. ğŸ’¡ å›¾ç‰‡ä¸Šä¼ è·¯å¾„é…ç½®

**é—®é¢˜æè¿°**ï¼š
- ä¸Šä¼ è·¯å¾„åœ¨ä»£ç ä¸­å¯èƒ½ç¡¬ç¼–ç 

**å»ºè®®**ï¼š
ç¡®ä¿æ‰€æœ‰æ–‡ä»¶è·¯å¾„é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®

---

## æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬å®Œæ•´ä¿®å¤ç‰ˆ

ç”±äºæ•°æ®åº“é—®é¢˜è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨ä¿®å¤åçš„å®Œæ•´SQLè„šæœ¬ã€‚ä¸»è¦ä¿®æ”¹ï¼š

### usersè¡¨ä¿®æ”¹ï¼š
```sql
CREATE TABLE `users` (
  `user_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,  -- æ”¹ä¸ºuser_id
  `openid` varchar(100) NOT NULL COMMENT 'å¾®ä¿¡OpenID',
  `nickname` varchar(100) DEFAULT NULL COMMENT 'æ˜µç§°',
  `avatar_url` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL',  -- æ”¹ä¸ºavatar_url
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `register_source` varchar(50) DEFAULT NULL COMMENT 'æ³¨å†Œæ¥æº',  -- æ–°å¢
  `credits` int(11) NOT NULL DEFAULT '0' COMMENT 'å‰©ä½™ç§¯åˆ†',
  `role` enum('user','vip','admin') NOT NULL DEFAULT 'user' COMMENT 'è§’è‰²',  -- æ”¹ä¸ºENUM
  `status` enum('active','inactive') NOT NULL DEFAULT 'active' COMMENT 'çŠ¶æ€',  -- æ”¹ä¸ºENUM
  `last_login_at` datetime DEFAULT NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `uk_openid` (`openid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

### worksè¡¨ä¿®æ”¹ï¼š
```sql
CREATE TABLE `works` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `work_id` varchar(50) NOT NULL COMMENT 'ä½œå“å”¯ä¸€æ ‡è¯†',  -- æ–°å¢
  `user_id` bigint(20) unsigned NOT NULL COMMENT 'ç”¨æˆ·ID',
  `task_id` varchar(100) NOT NULL COMMENT 'ä»»åŠ¡ID',
  `type` varchar(20) NOT NULL COMMENT 'ç±»å‹',
  `status` varchar(20) NOT NULL DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  `images` json DEFAULT NULL COMMENT 'ç”Ÿæˆçš„å›¾ç‰‡',
  `ai_description` text COMMENT 'AIç”Ÿæˆçš„æè¿°',  -- æ–°å¢
  `scene_id` varchar(50) DEFAULT NULL COMMENT 'åœºæ™¯ID',
  `error` text COMMENT 'é”™è¯¯ä¿¡æ¯',  -- æ”¹åä»error_message
  `is_favorite` tinyint(4) NOT NULL DEFAULT '0' COMMENT 'æ˜¯å¦æ”¶è—',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_work_id` (`work_id`),  -- æ–°å¢
  UNIQUE KEY `uk_task_id` (`task_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä½œå“è¡¨';
```

### ordersè¡¨ä¿®æ”¹ï¼š
```sql
ALTER TABLE `orders`
ADD COLUMN `paid_at` datetime DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´' AFTER `status`;
```

### credit_recordsè¡¨ä¿®æ”¹ï¼š
```sql
ALTER TABLE `credit_records`
CHANGE COLUMN `id` `record_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT;
```

### adminsè¡¨ä¿®æ”¹ï¼š
```sql
ALTER TABLE `admins`
CHANGE COLUMN `id` `admin_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT;
```

---

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ ç«‹å³ä¿®å¤ï¼ˆå½±å“ç³»ç»Ÿè¿è¡Œï¼‰ï¼š
1. æ•°æ®åº“å­—æ®µåä¸ä¸€è‡´ - usersè¡¨ä¸»é”®
2. æ•°æ®åº“å­—æ®µç¼ºå¤± - worksè¡¨ (work_id, ai_description)
3. æ•°æ®åº“å­—æ®µç¼ºå¤± - usersè¡¨ (avatar_url, register_source, status ENUM)

### ğŸŸ¡ å°½å¿«ä¿®å¤ï¼ˆå½±å“åŠŸèƒ½å®Œæ•´æ€§ï¼‰ï¼š
4. å‰ç«¯TypeScriptç±»å‹å®šä¹‰ç¼ºå¤±
5. credit_recordsè¡¨å­—æ®µå
6. ordersè¡¨paid_atå­—æ®µ
7. adminsè¡¨å­—æ®µå
8. ç¯å¢ƒå˜é‡é…ç½®

### ğŸŸ¢ ä¼˜åŒ–æ”¹è¿›ï¼ˆæå‡ä»£ç è´¨é‡ï¼‰ï¼š
9. API Base URLé…ç½®åŒ–
10. WebSocketåœ°å€ç¯å¢ƒå˜é‡
11. æ–‡ä»¶è·¯å¾„é…ç½®

---

## ä¿®å¤æ­¥éª¤

### 1. æ•°æ®åº“ä¿®å¤
```bash
# å¤‡ä»½ç°æœ‰æ•°æ®åº“
mysqldump -u ai_photo -p ai_photo > backup_$(date +%Y%m%d).sql

# æ‰§è¡Œä¿®å¤SQL
mysql -u ai_photo -p ai_photo < database/init_fixed.sql
```

### 2. å‰ç«¯ä¾èµ–å®‰è£…
```bash
cd web
npm install --save-dev @types/file-saver @types/jszip
```

### 3. ç¯å¢ƒå˜é‡é…ç½®
```bash
# åç«¯
cp backend/.env.example backend/.env
# ç¼–è¾‘ .env å¡«å…¥å®é™…é…ç½®

# å‰ç«¯
cp web/.env.example web/.env.local
# ç¼–è¾‘ .env.local å¡«å…¥å®é™…é…ç½®
```

### 4. éªŒè¯ä¿®å¤
```bash
# å¯åŠ¨åç«¯
cd backend
npm install
npm run dev

# å¯åŠ¨å‰ç«¯
cd web
npm install
npm run dev

# è®¿é—®æµ‹è¯•
# åç«¯: http://localhost:3000
# å‰ç«¯: http://localhost:3001
# ç®¡ç†åå°: http://localhost/admin (Nginx)
```

---

## æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“å­—æ®µä¿®å¤å®Œæˆ
- [ ] å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ
- [ ] åç«¯å¯åŠ¨æˆåŠŸ
- [ ] å‰ç«¯å¯åŠ¨æˆåŠŸ
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ä½œå“åˆ›å»ºåŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ç®¡ç†åå°è®¿é—®æ­£å¸¸
- [ ] WebSocketè¿æ¥æ­£å¸¸

---

## å¤‡æ³¨

1. æ‰€æœ‰æ•°æ®åº“ä¿®æ”¹è¯·åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯
2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰åŠ¡å¿…å¤‡ä»½æ•°æ®
3. å»ºè®®ä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·ç®¡ç†schemaå˜æ›´
4. TypeScriptç±»å‹é”™è¯¯ä¸å½±å“è¿è¡Œï¼Œä½†å»ºè®®ä¿®å¤ä»¥æå‡å¼€å‘ä½“éªŒ

---

**æ£€æŸ¥äººå‘˜**: Claude Code
**æ£€æŸ¥æ—¥æœŸ**: 2025-01-12
**ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0
