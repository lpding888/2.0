# 智能衣柜系统 - 开发文档

## 📋 目录

1. [项目概述](#项目概述)
2. [技术架构](#技术架构)
3. [目录结构](#目录结构)
4. [核心模块](#核心模块)
5. [数据管理](#数据管理)
6. [云函数](#云函数)
7. [开发指南](#开发指南)
8. [部署说明](#部署说明)

---

## 项目概述

### 项目简介
智能衣柜系统是一个基于微信小程序的数字衣柜管理工具，集成了AI造型建议功能。

### 技术栈
- **前端框架**：微信小程序原生框架
- **后端服务**：微信云开发（云函数 + 云存储）
- **数据存储**：本地存储（wx.storage）+ 云数据库
- **AI服务**：云函数集成（可对接OpenAI/通义千问等）

### 核心功能模块
1. **我的衣柜** (Phase 1)
2. **造型规划器** (Phase 2)
3. **AI造型师** (Phase 3)
4. **模块集成** (Phase 4)

---

## 技术架构

### 整体架构图

```
┌─────────────────────────────────────────┐
│           微信小程序客户端              │
│  ┌────────┐  ┌────────┐  ┌────────┐    │
│  │ 衣柜   │  │ 规划器 │  │ 回忆   │    │
│  └────────┘  └────────┘  └────────┘    │
│         │           │           │       │
│         └───────────┴───────────┘       │
│                    │                    │
│            ┌───────▼───────┐           │
│            │  DataManager  │           │
│            └───────┬───────┘           │
└────────────────────┼────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
   ┌────▼─────┐           ┌──────▼───────┐
   │ 本地存储 │           │  云函数服务  │
   └──────────┘           └──────────────┘
                                  │
                          ┌───────┴───────┐
                          │   AI Service  │
                          └───────────────┘
```

### 数据流向

```
用户操作 → 页面组件 → DataManager → 本地存储
                              ↓
                         云函数服务 → 云存储/数据库
```

---

## 目录结构

```
2.0/
├── miniprogram/                    # 小程序前端代码
│   ├── pages/                      # 页面目录
│   │   ├── wardrobe/              # 我的衣柜
│   │   ├── styling-planner/       # 造型规划器
│   │   ├── memories/              # 造型回忆
│   │   ├── profile/               # 个人中心
│   │   └── work-detail/           # 作品详情
│   ├── utils/                      # 工具类
│   │   ├── data-manager.js        # 数据管理器
│   │   └── ai-stylist.js          # AI造型师工具
│   ├── components/                 # 组件
│   ├── images/                     # 图片资源
│   ├── app.js                      # 应用入口
│   ├── app.json                    # 应用配置
│   └── app.wxss                    # 全局样式
│
├── cloudfunctions/                 # 云函数目录
│   ├── ai-stylist/                # AI造型师云函数
│   │   ├── index.js
│   │   └── package.json
│   ├── user/                       # 用户管理
│   ├── photography/                # AI摄影
│   └── ...                         # 其他云函数
│
├── 测试指南.md                     # 测试文档
├── 用户使用手册.md                 # 用户手册
└── 开发文档.md                     # 本文档
```

---

## 核心模块

### Phase 1: 我的衣柜

#### 文件结构
```
pages/wardrobe/
├── wardrobe.wxml      # 视图层
├── wardrobe.wxss      # 样式
├── wardrobe.js        # 逻辑层
└── wardrobe.json      # 配置
```

#### 核心功能
1. **衣物CRUD**：创建、读取、更新、删除
2. **分类管理**：上装、下装、连衣裙、鞋子、配饰
3. **搜索筛选**：关键词搜索 + 分类筛选
4. **图片上传**：拍照/相册 → 云存储

#### 关键代码
```javascript
// 添加衣物
onSaveItem() {
  const item = {
    id: Date.now(),
    name: this.data.itemForm.name,
    category: this.data.itemForm.category,
    tags: this.data.itemForm.tags,
    url: this.data.uploadedImageUrl,
    createTime: new Date().toISOString()
  }

  const result = dataManager.addWardrobeItem(item)
  if (result.success) {
    this.loadItems()
  }
}
```

### Phase 2: 造型规划器

#### 文件结构
```
pages/styling-planner/
├── styling-planner.wxml
├── styling-planner.wxss
├── styling-planner.js
└── styling-planner.json

pages/memories/
├── memories.wxml
├── memories.wxss
├── memories.js
└── memories.json
```

#### 核心功能
1. **日历视图**：月份切换、日期选择
2. **事件管理**：创建/编辑/删除事件
3. **造型选择**：从衣柜选择衣物
4. **回忆记录**：多图上传、心情标记

#### 日历生成算法
```javascript
loadCalendar() {
  const year = this.data.currentYear
  const month = this.data.currentMonth

  // 计算日历网格 (42格: 上月+当月+下月)
  const firstDay = new Date(year, month - 1, 1)
  const firstDayWeek = firstDay.getDay()  // 第一天星期几
  const daysInMonth = new Date(year, month, 0).getDate()

  // 需要显示的上月天数
  const prevMonthDays = firstDayWeek

  // 需要显示的下月天数
  const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7
  const nextMonthDays = totalCells - prevMonthDays - daysInMonth

  // 生成日历数组...
}
```

### Phase 3: AI造型师

#### 文件结构
```
cloudfunctions/ai-stylist/
├── index.js           # 云函数主文件
└── package.json

miniprogram/utils/
└── ai-stylist.js      # 前端工具类
```

#### AI匹配算法
```javascript
function smartMatch(eventInfo, weatherInfo, wardrobe) {
  const matched = { items: [], reasons: [] }

  // 相关标签
  const relevantTags = [...eventInfo.keywords, ...weatherInfo.items]

  // 选择连衣裙或上装+下装
  if (wardrobe.dresses.length > 0 && Math.random() > 0.5) {
    const dress = findBestMatch(wardrobe.dresses, relevantTags)
    if (dress) matched.items.push(dress)
  } else {
    const top = findBestMatch(wardrobe.tops, relevantTags)
    const bottom = findBestMatch(wardrobe.bottoms, relevantTags)
    if (top) matched.items.push(top)
    if (bottom) matched.items.push(bottom)
  }

  // 选择鞋子和配饰
  const shoe = findBestMatch(wardrobe.shoes, relevantTags)
  if (shoe) matched.items.push(shoe)

  return matched
}

// 评分算法
function findBestMatch(items, tags) {
  const scored = items.map(item => {
    let score = 0

    // 标签匹配 +2分
    if (item.tags) {
      item.tags.forEach(tag => {
        if (tags.some(t => tag.includes(t))) score += 2
      })
    }

    // 喜爱 +1分
    if (item.isFavorite) score += 1

    // 使用次数少 +0.1分（鼓励利用率）
    score += (10 - (item.useCount || 0)) * 0.1

    return { item, score }
  })

  scored.sort((a, b) => b.score - a.score)
  return scored[0]?.item
}
```

### Phase 4: 模块集成

#### 集成点
1. **Profile入口**：统一入口页面
2. **数据共享**：DataManager单例
3. **跨页面传参**：全局数据 + URL参数

#### 数据传递方式

##### 方式1：URL参数（短数据）
```javascript
// work-detail.js
wx.navigateTo({
  url: `/pages/memories/memories?from=work`
})

// memories.js onLoad
if (options.from === 'work') {
  // 处理逻辑
}
```

##### 方式2：全局数据（长数据）
```javascript
// work-detail.js
const app = getApp()
app.globalData.tempMemoryImage = imageUrl
wx.navigateTo({ url: '/pages/memories/memories?from=work' })

// memories.js onLoad
const app = getApp()
const imageUrl = app.globalData.tempMemoryImage
delete app.globalData.tempMemoryImage  // 用后即删
```

---

## 数据管理

### DataManager 设计

#### 单例模式
```javascript
// data-manager.js
class DataManager {
  constructor() {
    this.KEYS = {
      WARDROBE_ITEMS: 'wardrobe_items',
      PLANNER_EVENTS: 'styling_planner_events',
      PLANNER_MEMORIES: 'styling_planner_memories',
      SEARCH_HISTORY: 'wardrobe_search_history'
    }
  }

  // 衣柜管理
  getWardrobeItems() { }
  addWardrobeItem(item) { }
  updateWardrobeItem(id, updates) { }
  deleteWardrobeItem(id) { }

  // 事件管理
  getPlannerEvents() { }
  addPlannerEvent(event) { }
  updatePlannerEvent(id, updates) { }
  deletePlannerEvent(id) { }

  // 回忆管理
  getMemories() { }
  addMemory(memory) { }
  updateMemory(id, updates) { }
  deleteMemory(id) { }
}

const dataManager = new DataManager()
module.exports = dataManager
```

#### 数据结构

**衣物对象**
```javascript
{
  id: 1234567890,
  name: "白色T恤",
  category: "top",
  tags: ["白色", "休闲", "夏季"],
  url: "cloud://xxx.jpg",
  processedImage: "cloud://xxx_processed.jpg",
  isFavorite: false,
  useCount: 0,
  createTime: "2025-01-01T00:00:00Z"
}
```

**事件对象**
```javascript
{
  id: 1234567890,
  date: "2025-01-15",
  time: "09:00",
  title: "客户见面会",
  type: "work",
  weather: "sunny",
  selectedItems: [...],  // 衣物数组
  note: "重要客户",
  createTime: "2025-01-01T00:00:00Z"
}
```

**回忆对象**
```javascript
{
  id: 1234567890,
  date: "2025-01-15",
  time: "14:30",
  title: "春游穿搭",
  images: ["cloud://xxx1.jpg", "cloud://xxx2.jpg"],
  mood: "happy",
  items: [...],  // 衣物数组
  location: "公园",
  note: "天气真好",
  createTime: "2025-01-01T00:00:00Z"
}
```

---

## 云函数

### ai-stylist 云函数

#### 部署
```bash
# 在云函数目录
cd cloudfunctions/ai-stylist
npm install
# 右键上传并部署
```

#### 调用方式
```javascript
// 前端调用
const result = await wx.cloud.callFunction({
  name: 'ai-stylist',
  data: {
    eventType: 'work',
    weather: 'sunny',
    wardrobeItems: items
  }
})

// 返回格式
{
  success: true,
  suggestion: {
    eventType: 'work',
    weather: 'sunny',
    style: '专业商务风格',
    advice: '详细建议文案...',
    recommendedItems: [...],
    reasons: [...]
  }
}
```

#### 集成真实AI服务

替换 `index.js` 中的模拟逻辑：

```javascript
// 集成OpenAI示例
const { Configuration, OpenAIApi } = require('openai')

const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY
})
const openai = new OpenAIApi(configuration)

async function getAISuggestion(eventType, weather, wardrobeItems) {
  const prompt = `作为专业造型师，为${eventType}场合在${weather}天气下推荐穿搭...`

  const response = await openai.createChatCompletion({
    model: "gpt-3.5-turbo",
    messages: [{ role: "user", content: prompt }]
  })

  return parseAIResponse(response.data.choices[0].message.content)
}
```

---

## 开发指南

### 环境配置

#### 必需工具
- 微信开发者工具 最新稳定版
- Node.js 14+
- 微信云开发账号

#### 初始化项目
```bash
# 1. 克隆项目
git clone <repo-url>

# 2. 安装依赖（云函数）
cd cloudfunctions/ai-stylist
npm install

# 3. 配置云开发环境ID
# 在 app.js 中配置 env: 'your-env-id'
```

### 开发规范

#### 命名规范
- **文件名**：小写字母 + 连字符（如 `data-manager.js`）
- **变量名**：驼峰命名（如 `wardrobeItems`）
- **常量名**：大写 + 下划线（如 `STORAGE_KEY`）
- **组件名**：大写驼峰（如 `WardrobeItem`）

#### 代码风格
```javascript
// ✅ 推荐
async function loadData() {
  try {
    const items = await dataManager.getWardrobeItems()
    this.setData({ items })
  } catch (error) {
    console.error('加载失败:', error)
    wx.showToast({ title: '加载失败', icon: 'none' })
  }
}

// ❌ 不推荐
function loadData() {
  let items = dataManager.getWardrobeItems()
  this.setData({ items: items })
}
```

#### 错误处理
```javascript
// 统一错误处理模式
async function someAction() {
  try {
    // 业务逻辑
    const result = await apiCall()

    if (result.success) {
      // 成功处理
      wx.showToast({ title: '操作成功', icon: 'success' })
    } else {
      throw new Error(result.message)
    }
  } catch (error) {
    console.error('操作失败:', error)
    wx.showToast({
      title: error.message || '操作失败，请重试',
      icon: 'none',
      duration: 2000
    })
  }
}
```

### 性能优化

#### 1. 图片优化
```javascript
// 压缩上传
wx.chooseMedia({
  sizeType: ['compressed'],  // 压缩图片
  success: (res) => {
    // 上传处理
  }
})
```

#### 2. 数据缓存
```javascript
// 使用缓存减少重复加载
loadItems() {
  // 先显示缓存数据
  const cached = this.data.items
  if (cached.length > 0) {
    this.setData({ items: cached })
  }

  // 再加载最新数据
  const items = dataManager.getWardrobeItems()
  this.setData({ items, loading: false })
}
```

#### 3. 按需加载
```javascript
// 分页加载
loadMore() {
  const { page, items } = this.data
  const newItems = dataManager.getWardrobeItems({
    offset: page * 20,
    limit: 20
  })

  this.setData({
    items: [...items, ...newItems],
    page: page + 1
  })
}
```

### 调试技巧

#### 1. 使用console分组
```javascript
console.group('衣物管理')
console.log('当前衣物数:', items.length)
console.log('选中分类:', category)
console.groupEnd()
```

#### 2. 性能监控
```javascript
console.time('加载衣柜')
const items = dataManager.getWardrobeItems()
console.timeEnd('加载衣柜')
```

#### 3. 数据mock
```javascript
// 开发环境使用mock数据
const USE_MOCK = true

async function loadData() {
  if (USE_MOCK) {
    return mockData
  }
  return await realApiCall()
}
```

---

## 部署说明

### 云函数部署

#### 1. 配置环境变量
```javascript
// 在云开发控制台设置
OPENAI_API_KEY=sk-xxx
AI_SERVICE_URL=https://xxx
```

#### 2. 上传部署
```bash
# 方式1: 微信开发者工具
右键云函数文件夹 → 上传并部署：云端安装依赖

# 方式2: 命令行
npm run deploy:ai-stylist
```

#### 3. 版本管理
```bash
# 部署前标记版本
git tag v1.0.0
git push origin v1.0.0

# 部署时选择对应版本
```

### 小程序发布

#### 1. 代码审查
```bash
# 运行eslint检查
npm run lint

# 性能分析
使用微信开发者工具 → 性能分析
```

#### 2. 体验版测试
```
1. 点击"上传" → 填写版本号和描述
2. 登录mp.weixin.qq.com
3. 版本管理 → 选择体验版 → 设置体验者
4. 扫码测试
```

#### 3. 正式发布
```
1. 体验版测试通过
2. 提交审核
3. 审核通过后发布
4. 监控线上数据
```

### 环境配置

#### development（开发环境）
```javascript
const config = {
  env: 'dev-xxx',
  useMock: true,
  debugMode: true
}
```

#### production（生产环境）
```javascript
const config = {
  env: 'prod-xxx',
  useMock: false,
  debugMode: false
}
```

---

## 常见问题

### Q1: 云函数调用失败？
**A:** 检查云开发环境ID配置，确认云函数已部署且权限正确。

### Q2: 图片上传失败？
**A:** 检查云存储配置，确认文件大小未超限（10MB）。

### Q3: 数据不同步？
**A:** 检查DataManager的存储键，确保各模块使用相同的key。

### Q4: 性能卡顿？
**A:** 使用分页加载，优化图片大小，减少setData频率。

### Q5: AI建议不准确？
**A:**
- 检查衣柜数据完整性（标签、分类）
- 调整评分算法权重
- 集成真实AI服务提升准确度

---

## 更新日志

### v1.0.0 (2025-01-XX)
- ✨ 实现我的衣柜功能
- ✨ 实现造型规划器
- ✨ 实现AI造型师
- ✨ 实现造型回忆
- ✨ 完成模块集成

### 待开发功能
- [ ] AI造型师接入真实AI服务
- [ ] 数据云端同步
- [ ] 社交分享功能
- [ ] 穿搭推荐算法优化
- [ ] 批量导出功能

---

## 贡献指南

欢迎贡献代码！请遵循以下流程：

1. Fork项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 提交Pull Request

---

## 许可证

MIT License

---

**开发团队** | 技术支持: support@example.com
