# 微信小程序云函数本地测试指南

## 🎯 测试目标
验证优化后的函数流程：
- photography-worker → aimodels.createGenerationTask
- fitting-worker → aimodels.createGenerationTask
- 数据传输优化效果（fileId vs Base64）
- 水印处理流程

## 🛠️ 环境准备

### 1. 微信开发者工具
- 下载最新版微信开发者工具（建议1.06.x+）
- 导入项目：选择 `C:\Users\qq100\Desktop\新建文件夹 (4)`
- 确认项目配置：
  ```json
  {
    "cloudfunctionRoot": "cloudfunctions/",
    "miniprogramRoot": "miniprogram/"
  }
  ```

### 2. 云开发环境
- 打开微信开发者工具
- 点击工具栏 "云开发" 按钮
- 确认环境ID：`cloudbase-0gu1afji26f514d2`

## 🔧 云函数调试设置

### 步骤1: 启用本地调试
1. 在开发者工具中右键点击 `cloudfunctions` 目录
2. 选择 "启用云函数本地调试"
3. 勾选需要调试的函数：
   - ✅ photography
   - ✅ photography-worker
   - ✅ fitting
   - ✅ fitting-worker
   - ✅ aimodels

### 步骤2: 安装依赖
```bash
# 进入每个云函数目录安装依赖
cd cloudfunctions/aimodels
npm install

cd ../photography-worker
npm install

cd ../fitting-worker
npm install
```

## 📱 测试流程

### 测试1: Photography流程
1. **模拟器中操作**：
   - 打开小程序
   - 进入摄影页面
   - 上传服装图片
   - 设置参数并点击生成

2. **监控云函数调用**：
   ```
   photography → photography-worker → aimodels.createGenerationTask
   ```

3. **关键检查点**：
   - photography-worker 是否传递 `imageIds[]` 而非 base64
   - aimodels 是否收到 `action: 'createGenerationTask'`
   - WorkflowOrchestrator 是否正常执行

### 测试2: Fitting流程
1. **模拟器中操作**：
   - 进入试衣页面
   - 上传人物和服装图片
   - 点击开始试衣

2. **监控调用链**：
   ```
   fitting → fitting-worker → aimodels.createGenerationTask
   ```

## 🔍 调试技巧

### 1. 控制台监控
在开发者工具中打开 "调试器" → "Console"，观察日志：

```javascript
// photography-worker 优化日志
'🔥 启动AI异步任务（优化版：只传fileId）...'

// fitting-worker 优化日志
'🔥 启动AI异步任务（优化版：只传fileId）...'

// aimodels 处理日志
'🚀 开始执行photography工作流'
'📥 步骤1: 处理输入图片...'
'🎨 步骤4: 添加水印...'
```

### 2. Network面板
查看云函数调用：
- 请求类型显示为 "cloud"
- 查看传输数据大小对比
- 验证 imageIds vs reference_images

### 3. 断点调试
在关键函数设置断点：
- `photography-worker/index.js:246` (createGenerationTask调用)
- `fitting-worker/index.js:392` (createGenerationTask调用)
- `aimodels/index.js:23` (createGenerationTask处理)

## 📊 验证指标

### 数据传输优化
- **原始**: Base64数组传输 (~2.66MB)
- **优化**: fileId数组传输 (~100字节)
- **减少**: 99.996%

### 功能完整性
- ✅ 图片正常上传和处理
- ✅ AI模型正常调用
- ✅ 水印100%添加
- ✅ 结果正常返回

### 性能指标
- 云函数执行时间
- 内存使用情况
- 错误率统计

## 🚨 常见问题

### 1. 依赖缺失
```bash
Error: Cannot find module 'jimp'
解决: cd cloudfunctions/aimodels && npm install
```

### 2. 环境变量
确保云环境中配置了必要的API密钥

### 3. 权限问题
检查云函数权限和数据库访问权限

## 🎯 测试清单

- [ ] photography 完整流程测试
- [ ] fitting 完整流程测试
- [ ] 数据传输大小验证
- [ ] 水印添加验证
- [ ] 错误处理测试
- [ ] 性能指标记录

完成测试后，可以安全部署到生产环境。