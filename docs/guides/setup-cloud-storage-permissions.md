# 云存储权限配置指南

## 问题分析

根据日志分析，虽然 `aimodels` 云函数成功返回了base64图片数据，但 `photography` 云函数的异步任务没有执行，可能的原因：

1. **云函数部署缓存问题** - 新代码没有真正部署到云端
2. **云存储权限问题** - 异步任务尝试上传文件时权限被拒绝
3. **异步执行限制** - 云函数环境对setTimeout有限制

## 解决方案

### 1. 配置云存储权限

在微信开发者工具的云开发控制台中：

#### 步骤1：打开云存储设置
1. 打开微信开发者工具
2. 点击"云开发" → "存储"
3. 点击右上角"设置"按钮

#### 步骤2：配置存储权限
设置以下权限规则：

```json
{
  "read": true,
  "write": "auth.openid != null"
}
```

这样配置的含义：
- 所有人都可以读取文件（read: true）
- 只有已登录用户可以写入文件（write: auth.openid != null）

#### 步骤3：创建必要的文件夹结构
在云存储中手动创建以下目录结构：
```
/generated/
/generated/tmp/
/uploads/
/temp/
```

### 2. 强制重新部署云函数

运行以下PowerShell脚本强制重新部署：

```powershell
.\force-redeploy-photography.ps1
```

### 3. 验证部署是否成功

部署完成后，检查以下几点：

1. **查看云函数日志**
   - 应该能看到 `🚀 开始异步处理任务` 日志
   - 应该能看到 `📸 processPhotographyTask 开始执行` 日志

2. **检查异步任务执行**
   - 任务创建后5-10秒内应该有后续日志
   - 如果只有快速返回的100ms日志，说明异步任务没有执行

3. **验证云存储上传**
   - 在云存储中应该能看到 `/generated/` 目录下的文件
   - 文件命名格式：`generated_[taskId]_[index]_[timestamp].png`

### 4. 调试步骤

如果问题仍然存在，按以下步骤调试：

#### 步骤1：检查云函数版本
在云函数开头会有版本时间戳注释，确认是最新版本。

#### 步骤2：检查权限错误
查看云函数日志中是否有权限相关的错误信息：
- `Permission denied`
- `Storage access denied`
- `Upload failed`

#### 步骤3：简化测试
创建一个简单的测试任务：
- 不使用真实图片，只测试存储上传
- 直接调用 `cloud.uploadFile` 看是否成功

### 5. 常见错误及解决方案

#### 错误1：云存储权限被拒绝
```
Error: Permission denied when uploading to cloud storage
```
**解决方案：** 按步骤1-2配置云存储权限

#### 错误2：异步任务超时
```
Function execution timeout
```
**解决方案：**
- 增加云函数超时时间（在云开发控制台设置）
- 优化异步任务逻辑，减少执行时间

#### 错误3：setTimeout不生效
```
异步任务没有任何日志输出
```
**解决方案：**
- 改用 `setImmediate()` 或 `process.nextTick()`
- 或者改为同步处理（去掉异步）

### 6. 备选方案

如果异步处理仍有问题，可以考虑：

1. **改为同步处理** - 直接在主函数中处理图片上传
2. **使用队列机制** - 通过数据库队列+定时触发器处理
3. **分离上传逻辑** - 创建独立的上传云函数

## 执行清单

- [ ] 配置云存储权限规则
- [ ] 创建必要的存储目录结构
- [ ] 运行强制重新部署脚本
- [ ] 验证部署版本时间戳
- [ ] 测试异步任务执行
- [ ] 检查云存储文件上传
- [ ] 查看完整的云函数执行日志

完成以上步骤后，AI图片生成功能应该能正常工作。