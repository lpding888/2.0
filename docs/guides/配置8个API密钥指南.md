# 配置8个API密钥指南

## 📊 配置效果

配置8个API密钥后，系统支持：
- **60-80个并发用户**（考虑重试）
- **120次/分钟** API调用能力
- **自动负载均衡**（随机分配密钥）

## 🔧 配置步骤

### 1. 获取8个API密钥

从你的API供应商获取8个密钥，例如：
```
密钥1: AIzaSyAbc123...
密钥2: AIzaSyDef456...
密钥3: AIzaSyGhi789...
...
密钥8: AIzaSyXyz999...
```

### 2. 在云开发控制台配置环境变量

#### 方法A：微信开发者工具
1. 打开**微信开发者工具**
2. 点击**云开发控制台**
3. 进入**设置** → **环境变量**
4. 添加以下8个环境变量：

| 变量名 | 值 |
|--------|-----|
| `GEMINI_API_KEY_1` | 你的密钥1 |
| `GEMINI_API_KEY_2` | 你的密钥2 |
| `GEMINI_API_KEY_3` | 你的密钥3 |
| `GEMINI_API_KEY_4` | 你的密钥4 |
| `GEMINI_API_KEY_5` | 你的密钥5 |
| `GEMINI_API_KEY_6` | 你的密钥6 |
| `GEMINI_API_KEY_7` | 你的密钥7 |
| `GEMINI_API_KEY_8` | 你的密钥8 |

#### 方法B：云开发控制台网页
1. 访问 https://console.cloud.tencent.com/tcb
2. 选择你的环境
3. 进入**云函数** → **环境配置** → **环境变量**
4. 添加上述8个变量

### 3. 重新部署云函数

配置环境变量后，必须重新部署云函数才能生效：

#### 使用微信开发者工具：
1. 右键点击 `photography-worker` → **上传并部署：云端安装依赖**
2. 右键点击 `fitting-worker` → **上传并部署：云端安装依赖**

#### 使用命令行（PowerShell）：
```powershell
# 进入项目目录
cd "C:\Users\qq100\Desktop\迭代目录\2.0"

# 部署photography-worker
tcb fn deploy photography-worker --force

# 部署fitting-worker
tcb fn deploy fitting-worker --force
```

### 4. 验证配置

部署完成后，查看云函数日志：

1. 触发一次AI生成
2. 打开云开发控制台 → **云函数** → **日志**
3. 查看是否出现：
   ```
   🔑 使用API密钥池 (1/8)
   ```
   或
   ```
   🔑 使用API密钥池 (3/8)
   ```

如果看到这个日志，说明多密钥轮询已生效 ✅

## 🎯 工作原理

### 负载均衡机制
- 每次AI调用时，随机从8个密钥中选择1个
- 均匀分散请求到不同密钥
- 避免单个密钥被限流

### 示例：
```
用户A生成 → 使用密钥3 (随机选择)
用户B生成 → 使用密钥7 (随机选择)
用户C生成 → 使用密钥1 (随机选择)
```

### 兜底机制
- 如果8个密钥都未配置，会尝试使用原有的单密钥配置
- 如果某个密钥失效，会在重试时自动换用另一个密钥

## 📈 并发能力计算

### 理论值
```
8个密钥 × 15 RPM = 120次/分钟
```

### 考虑重试（50%超时率）
```
120次 ÷ 1.5 = 80个并发用户
```

### 保留安全余量（20%）
```
80 × 0.8 = 64个实际并发用户 ✅
```

## ⚠️ 注意事项

1. **密钥安全**
   - 不要将密钥写入代码
   - 只通过环境变量配置
   - 定期轮换密钥

2. **部署顺序**
   - 先配置环境变量
   - 再部署云函数
   - 否则密钥不生效

3. **监控建议**
   - 定期查看云函数日志
   - 监控API错误率
   - 如果频繁429错误，说明密钥不够

## 🔄 扩容方案

如果未来需要支持更多用户：

| 目标并发 | 需要密钥数 | API能力 |
|---------|----------|---------|
| 80人 | 8个 | 120 RPM |
| 100人 | 10个 | 150 RPM |
| 120人 | 12个 | 180 RPM |
| 150人 | 15个 | 225 RPM |

只需：
1. 在环境变量中添加 `GEMINI_API_KEY_9`、`GEMINI_API_KEY_10` 等
2. 修改代码中的密钥池（增加到对应数量）
3. 重新部署

## ✅ 完成检查清单

- [ ] 从API供应商获取8个密钥
- [ ] 在云开发控制台配置8个环境变量
- [ ] 重新部署 photography-worker
- [ ] 重新部署 fitting-worker
- [ ] 查看日志验证密钥池生效
- [ ] 测试AI生成功能正常

---

**配置完成后，你的系统将支持60-80个用户同时生成AI图片！** 🚀
