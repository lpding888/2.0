# AI图片水印功能配置说明

## 📋 功能概述

AI摄影师小程序已集成AI生成图片水印功能，符合《人工智能生成合成内容标识办法》监管要求。

## 🎯 水印特性

### 盲水印标识
- **内容**：`"AI生成"`（符合国家标准要求）
- **类型**：隐式盲水印，不影响图片视觉效果
- **位置**：嵌入图片数据中，用户不可见但可提取验证
- **监管合规**：满足2025年9月1日起的强制标识要求

### 技术实现
- **扩展**：微信云开发图像处理扩展 `@cloudbase/extension-ci`
- **方式**：盲水印技术，在AI图片生成后自动添加
- **兼容性**：支持所有AI生成的图片格式（JPEG、PNG、WebP等）

## ⚙️ 环境配置

### 云函数环境变量

在微信开发者工具的云函数设置中添加以下环境变量：

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `WATERMARK_ENABLED` | `true` | 控制水印功能开关 |

### 配置方法

1. **开发者工具配置**：
   - 右键 `ai-callback` 云函数
   - 选择"云函数设置"
   - 在"环境变量"中添加配置

2. **微信云开发控制台配置**：
   - 登录 [云开发控制台](https://console.cloud.tencent.com/tcb)
   - 选择对应环境
   - 云函数 → ai-callback → 函数配置 → 环境变量

## 🎮 功能控制

### 启用水印（默认）
```
WATERMARK_ENABLED = true  （或不设置此变量）
```

### 禁用水印
```
WATERMARK_ENABLED = false
```

## 📦 部署步骤

### 1. 安装依赖
```bash
# 在 ai-callback 目录下
npm install @cloudbase/extension-ci
```

### 2. 部署云函数
```bash
# 右键 ai-callback 云函数选择"上传并部署"
# 或使用开发者工具的"云开发"面板部署
```

### 3. 激活图像处理扩展

在微信云开发控制台中：
1. 进入"扩展能力"
2. 找到"图像处理"扩展
3. 点击"启用"（有3000次免费额度）

## 🔧 故障排查

### 常见问题

1. **水印功能不生效**
   - 检查环境变量 `WATERMARK_ENABLED` 是否为 `true`
   - 确认图像处理扩展已启用
   - 查看云函数日志中的水印处理信息

2. **依赖安装失败**
   - 使用"云端安装依赖"选项重新部署
   - 检查 package.json 中的依赖版本

3. **处理超时**
   - 检查云函数内存配置（建议512MB以上）
   - 查看云函数超时设置（建议60秒以上）

### 日志关键字
```
🎨 开始添加AI生成水印    - 水印处理开始
✅ AI水印添加成功        - 水印添加成功
⚠️ AI水印添加失败        - 水印添加失败（会降级使用原图）
```

## 💰 费用说明

- **免费额度**：每账户3000次图像处理额度
- **超额计费**：按腾讯云图像处理标准收费
- **监控方式**：云开发控制台 → 资源使用情况

## 🔒 安全特性

### 降级保护
- 水印功能失败时自动使用原图，不影响用户体验
- 所有错误都有详细日志记录

### 开关控制
- 可通过环境变量实时开关水印功能
- 无需修改代码即可调整配置

## 📞 技术支持

如遇问题，请查看：
1. 云函数日志（微信开发者工具 → 云开发 → 云函数 → 日志）
2. 图像处理扩展使用量（云开发控制台 → 扩展能力）
3. 项目技术文档

---

✅ **配置完成后，所有AI生成的图片将自动添加符合监管要求的"AI生成"盲水印标识**