# 场景数据问题排查和修复指南

## 问题现象
服装摄影页和试衣间页显示的场景选择不是数据库中配置的场景，而是硬编码的默认场景。

## 问题原因分析

### 可能的原因：
1. **数据库权限问题** - scenes集合权限设置不正确
2. **数据结构问题** - scenes集合中数据格式不匹配
3. **云函数部署问题** - scene云函数未正确部署
4. **数据库集合为空** - scenes集合中没有数据

## 快速排查步骤

### 第一步：检查云函数部署
1. 在微信开发者工具中打开云开发控制台
2. 检查是否已部署 `scene` 云函数
3. 检查是否已部署 `debug-scenes` 云函数（新增的调试工具）

### 第二步：检查数据库权限
1. 打开数据库控制台
2. 找到 `scenes` 集合
3. 确认权限设置为：**所有用户可读，仅管理端可写**

### 第三步：使用调试工具
1. 访问调试页面：
   ```
   /pages/debug-scenes/debug-scenes
   ```
2. 点击"检查场景数据"按钮
3. 查看场景数据统计信息

## 修复方案

### 方案一：使用调试工具自动修复
1. 访问调试页面：`/pages/debug-scenes/debug-scenes`
2. 按顺序执行：
   - **检查场景数据** - 查看当前状态
   - **修复场景数据** - 自动修复数据结构问题
   - **添加测试场景** - 如果没有场景数据，添加测试场景
   - **测试场景API** - 验证API是否正常工作

### 方案二：手动检查和修复

#### 2.1 检查数据库集合
```sql
-- 在数据库控制台执行查询
db.collection('scenes').where({}).get()
```

#### 2.2 检查数据结构
确保每个场景记录包含以下字段：
```json
{
  "_id": "scene_id",
  "name": "场景名称",
  "category": "场景分类",
  "description": "场景描述",
  "thumbnail_url": "缩略图URL",
  "is_active": true,
  "sort_order": 1,
  "parameters": {
    "background": "背景类型",
    "lighting": "光线类型",
    "mood": "氛围类型"
  },
  "created_at": "创建时间",
  "updated_at": "更新时间"
}
```

#### 2.3 手动添加测试场景
在数据库控制台的scenes集合中添加：

```json
{
  "name": "白色工作室",
  "category": "studio",
  "description": "简约白色背景，专业摄影工作室风格",
  "thumbnail_url": "/images/scenes/studio-white.jpg",
  "is_active": true,
  "sort_order": 1,
  "parameters": {
    "background": "white",
    "lighting": "studio",
    "mood": "professional"
  },
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-01T00:00:00.000Z"
}
```

### 方案三：云函数调试
如果场景API仍然不工作，检查云函数日志：

1. 在云开发控制台选择"云函数"
2. 找到 `scene` 云函数
3. 查看"运行日志"
4. 查找错误信息

## 验证修复结果

### 1. 检查场景加载
在服装摄影或试衣间页面：
- 查看开发者工具控制台
- 应该看到类似日志：
  ```
  photography.js loadScenes: 场景加载结果 {success: true, data: [...]}
  photography.js loadScenes: 场景数据: [...]
  ```

### 2. 检查场景显示
- 场景选择区域应该显示您在数据库中配置的场景
- 不再是硬编码的"户外花园"、"室内工作室"、"城市街道"

### 3. 使用管理中心验证
- 进入管理中心（连续点击头像10次）
- 查看场景管理功能
- 确认能正确显示和管理场景

## 常见问题解决

### Q1: 调试页面显示"集合不存在"
**解决方案：**
```bash
# 在数据库控制台手动创建scenes集合
# 或点击调试页面的"添加测试场景"按钮
```

### Q2: 场景数据存在但API返回空
**解决方案：**
1. 检查scenes集合权限设置
2. 确保is_active字段为true
3. 重新部署scene云函数

### Q3: 修复后仍显示默认场景
**解决方案：**
1. 清除小程序缓存
2. 重新启动小程序
3. 检查浏览器控制台错误信息

## 联系支持

如果以上方案都无法解决问题，请提供：
1. 调试工具的完整日志
2. 数据库scenes集合的截图
3. 云函数运行日志
4. 具体的错误信息

## 预防措施

1. **定期备份** - 定期导出scenes集合数据
2. **权限监控** - 定期检查数据库权限设置
3. **版本控制** - 云函数代码使用版本控制
4. **测试验证** - 每次更新后进行功能测试

---

**注意：** 调试页面仅用于开发调试，生产环境中请移除或限制访问权限。