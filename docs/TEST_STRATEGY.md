# 测试策略

## 覆盖范围
- 单元测试：
  - 云函数 action 路由与参数校验
  - 工具函数（如 `utils/*`）与数据整形
- 集成测试：
  - `api` 与 `user/payment` 常用路径（登录→扣/退积分→状态）
  - 生成流程：photography/fitting → worker → 状态与结果
- 端到端（E2E，按需）：
  - 小程序关键路径：发起生成/查看进度/查看作品

## 关键路径
- 支付与积分：订单创建、回调幂等、扣/退积分一致性
- 作品生成：任务排队、失败重试、最终一致性
- 队列与并发：并发安全、原子加减、重复消费防护

## Fixtures/Mocks
- OPENID/用户信息 Mock；作品与任务集合样本数据
- 外部 AI 服务 Mock（延迟/失败/超时场景）
- 支付回调签名与重放用例

## 边界与异常
- 上传图片类型/尺寸边界；超大/非法文件
- 超时/重试/幂等：worker 超时不退款；真实失败退款
- 缓存：TTL 失效、主动失效后的命中率恢复

