# 状态机架构部署设置指南

## 📋 部署信息
- **创建时间**: 2025-10-01
- **架构版本**: 状态机 v2.0
- **预计部署时间**: 30分钟

---

## 🎯 部署目标

将状态机架构的代码部署到微信云开发环境，配置好触发器，确保生图功能正常运行。

---

## 📦 部署前准备

### 1. 环境要求

- ✅ 微信开发者工具（最新版）
- ✅ 云开发环境已开通
- ✅ Node.js 14+ 已安装（用于本地测试）

### 2. 代码确认

确认以下文件已存在：

**task-processor** (10个文件):
```
cloudfunctions/task-processor/
  ├─ index.js (重写后)
  ├─ config.json (已修改)
  ├─ package.json (已修改)
  └─ states/
      ├─ base.js
      ├─ pending.js
      ├─ downloading.js
      ├─ downloaded.js
      ├─ ai_calling.js
      ├─ ai_processing.js
      ├─ ai_completed.js
      ├─ watermarking.js
      └─ uploading.js
```

**aimodels** (已添加4个新action):
```
cloudfunctions/aimodels/
  └─ index.js (已添加startAIGeneration等)
```

**photography & fitting** (已添加state字段):
```
cloudfunctions/photography/index.js
cloudfunctions/fitting/index.js
```

---

## 🚀 部署步骤

### 步骤1: 删除旧的canvas依赖

**操作位置**: `cloudfunctions/task-processor`

```bash
cd cloudfunctions/task-processor
npm uninstall canvas
```

或直接删除 `package.json` 中的 `"canvas": "^2.11.2"` 行。

**验证**: 打开 `package.json`，确认只有：
```json
{
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

---

### 步骤2: 安装依赖（如需要）

```bash
cd cloudfunctions/task-processor
npm install

cd ../aimodels
npm install

cd ../photography
npm install

cd ../fitting
npm install
```

---

### 步骤3: 上传云函数

#### 方法1: 使用微信开发者工具（推荐）

1. 打开**微信开发者工具**
2. 打开你的小程序项目
3. 在左侧文件树中，依次右键点击以下云函数文件夹，选择"上传并部署：云端安装依赖"：

**上传顺序**:
```
1. cloudfunctions/aimodels/        (先上传，因为其他函数依赖它)
2. cloudfunctions/task-processor/  (核心状态机)
3. cloudfunctions/photography/     (前端入口)
4. cloudfunctions/fitting/         (前端入口)
```

**每个函数上传后，等待部署完成（约1-2分钟）**

---

#### 方法2: 使用命令行工具

```bash
# 安装腾讯云CLI（如果还没安装）
npm install -g @cloudbase/cli

# 登录
tcb login

# 部署函数
tcb fn deploy task-processor
tcb fn deploy aimodels
tcb fn deploy photography
tcb fn deploy fitting
```

---

### 步骤4: 配置定时触发器 ⭐ 关键步骤

#### 4.1 进入云函数管理

1. 在微信开发者工具中，点击顶部"云开发"按钮
2. 在弹出窗口中，点击"前往控制台"（会在浏览器中打开）
3. 在左侧菜单选择"云函数"

#### 4.2 找到task-processor函数

在云函数列表中，找到并点击 `task-processor`

#### 4.3 配置触发器

1. 点击"触发器"标签页
2. 点击"创建触发器"按钮

**填写配置**:
```
触发器名称: stateProcessor
触发周期: 自定义
Cron表达式: 0 */30 * * * * *
```

**Cron表达式说明**:
- `0 */30 * * * * *` = 每30秒执行一次
- 格式：`秒 分 时 日 月 星期 年`
- 示例：
  - `0 */15 * * * * *` - 每15秒（高并发时可用）
  - `0 */1 * * * * *` - 每分钟

3. 点击"确定"保存

**验证**:
- 触发器状态显示为"启用"
- 记录下触发器ID

---

### 步骤5: 创建数据库集合

#### 5.1 创建 ai_tasks 集合

1. 在云开发控制台，选择"数据库"
2. 点击"创建集合"
3. 集合名称：`ai_tasks`
4. 权限：选择"仅创建者可读写"

**字段说明**（无需手动创建，代码会自动写入）:
```javascript
{
  _id: String,           // ai_photo_xxx_timestamp
  task_id: String,       // 关联的任务ID
  status: String,        // processing, completed, failed
  model: String,         // AI模型名称
  provider: String,      // AI提供商
  result: Object,        // AI返回结果
  error: String,         // 错误信息
  created_at: Date,      // 创建时间
  completed_at: Date     // 完成时间
}
```

#### 5.2 更新 task_queue 集合字段（如需要）

如果是全新部署，代码会自动创建正确字段。

如果有老数据，需要批量更新：

1. 在云开发控制台 → 数据库 → task_queue
2. 点击"查询"
3. 输入条件：`{ status: "pending" }`
4. 点击"批量更新"
5. 输入更新内容：
```json
{
  "state": "pending",
  "state_data": {},
  "retry_count": 0
}
```

---

### 步骤6: 设置数据库权限（可选）

如果需要前端直接访问works集合：

1. 在数据库 → works 集合
2. 点击"权限设置"
3. 选择"自定义安全规则"
4. 输入：
```json
{
  "read": "doc.user_openid == auth.openid",
  "write": false
}
```

这样用户只能读取自己的作品，不能直接写入。

---

## ✅ 验证部署

### 验证1: 定时触发器是否运行

**方法1: 查看日志**

1. 云开发控制台 → 云函数 → task-processor
2. 点击"日志"标签
3. 等待30-60秒
4. 查看是否有新日志
5. 搜索关键字：`🚀 task-processor (状态机模式) 运行`

**预期输出**:
```
🚀 task-processor (状态机模式) 运行
📥 处理状态: pending
📥 处理状态: downloading
...
✅ 处理完成，共处理 0 个任务
```

---

**方法2: 手动触发测试**

1. 云开发控制台 → 云函数 → task-processor
2. 点击"测试"标签
3. 输入测试参数：`{}`（空对象）
4. 点击"云端测试"
5. 查看返回结果

**预期返回**:
```json
{
  "success": true,
  "processed": 0,
  "results": []
}
```

---

### 验证2: 生图功能是否正常

#### 2.1 提交测试任务

在小程序端：

1. 进入"AI摄影"页面
2. 上传一张服装图片
3. 点击"开始生成"

**预期**:
- 提示"任务已提交，正在生成中..."
- 返回task_id

#### 2.2 检查任务状态

**方式1: 查看数据库**

1. 云开发控制台 → 数据库 → task_queue
2. 找到刚才创建的任务
3. 观察state字段的变化

**预期状态流转**:
```
pending (0秒)
  ↓
downloading (30秒后)
  ↓
downloaded (60秒后)
  ↓
ai_calling (90秒后)
  ↓
ai_processing (120秒后, 开始轮询)
  ↓
ai_processing (150秒, 还在轮询)
  ↓
... (AI完成)
  ↓
ai_completed
  ↓
watermarking
  ↓
uploading
  ↓
completed
```

---

**方式2: 查看works集合**

1. 云开发控制台 → 数据库 → works
2. 找到对应的作品记录
3. 观察status字段

**预期状态**:
```
pending → processing → completed
```

---

**方式3: 前端轮询**

在小程序端代码中添加：

```javascript
// pages/photography/photography.js

// 提交任务后
const { task_id } = result.data

// 轮询检查
const timer = setInterval(async () => {
  const res = await wx.cloud.callFunction({
    name: 'photography',
    data: { action: 'getProgress', task_id }
  })

  const work = res.result.data
  console.log('任务状态:', work.status, '详细状态:', work.state)

  if (work.status === 'completed') {
    clearInterval(timer)
    console.log('生图完成!', work.images)
  } else if (work.status === 'failed') {
    clearInterval(timer)
    console.log('生图失败:', work.error)
  }
}, 5000)  // 每5秒查询一次
```

---

### 验证3: 失败重试机制

#### 模拟AI失败

1. 临时修改aimodels云函数，让AI调用抛出错误
2. 提交生图任务
3. 观察task_queue中的retry_count字段

**预期行为**:
- retry_count从0 → 1 → 2 → 3
- 3次失败后，state变为'failed'
- 积分已退还（检查users集合）

---

## 🔧 故障排查

### 问题1: 定时触发器没有运行

**可能原因**:
1. Cron表达式配置错误
2. 触发器未启用
3. 云函数有错误

**解决方法**:
1. 检查Cron表达式：`0 */30 * * * * *`
2. 确认触发器状态为"启用"
3. 查看云函数日志，检查是否有错误

---

### 问题2: 任务一直卡在某个状态

**可能原因**:
1. 状态处理器代码有错误
2. AI任务记录丢失
3. 数据库字段缺失

**解决方法**:
1. 查看task-processor日志，找到错误信息
2. 检查ai_tasks集合是否有对应记录
3. 手动更新任务状态：
```javascript
// 在云开发控制台执行
db.collection('task_queue').doc('任务ID').update({
  data: {
    state: 'pending',  // 重置为pending
    retry_count: 0
  }
})
```

---

### 问题3: AI生成失败

**可能原因**:
1. AI API密钥未配置
2. AI服务不可用
3. 图片格式错误

**解决方法**:
1. 检查api_configs集合中的AI模型配置
2. 查看aimodels云函数日志
3. 验证上传的图片是否为base64格式

---

### 问题4: 积分未退还

**可能原因**:
1. refundCredits函数未执行
2. user_openid字段缺失

**解决方法**:
1. 查看task-processor日志，搜索"退还积分"
2. 手动退还积分：
```javascript
// 在云开发控制台执行
db.collection('users')
  .where({ openid: '用户openid' })
  .update({
    data: {
      credits: _.inc(退还数量),
      total_consumed_credits: _.inc(-退还数量)
    }
  })
```

---

## 📊 性能优化

### 1. 调整触发器频率

根据实际并发量调整：

**低并发（<10任务/天）**:
```
Cron: 0 */1 * * * * *  (每分钟)
```

**中并发（10-100任务/天）**:
```
Cron: 0 */30 * * * * *  (每30秒，当前配置)
```

**高并发（>100任务/天）**:
```
Cron: 0 */15 * * * * *  (每15秒)
```

---

### 2. 调整每次处理数量

修改 `task-processor/index.js` Line 57:

```javascript
.limit(10)  // 每次处理10个任务
```

根据服务器性能调整：
- 低性能：`limit(5)`
- 中性能：`limit(10)`（默认）
- 高性能：`limit(20)`

---

### 3. 调整超时判断

修改 `ai_processing.js` Line 41:

```javascript
if (elapsed > 10 * 60 * 1000) {  // 10分钟超时
  throw new Error('AI处理超时（10分钟）')
}
```

根据AI服务响应时间调整：
- AI快（<2分钟）：5分钟超时
- AI中等（2-5分钟）：10分钟超时（默认）
- AI慢（>5分钟）：15分钟超时

---

## 📋 部署检查清单

使用此清单确认所有步骤已完成：

### 代码部署
- [ ] task-processor云函数已上传
- [ ] aimodels云函数已上传
- [ ] photography云函数已上传
- [ ] fitting云函数已上传
- [ ] 所有云函数部署成功（无错误）

### 触发器配置
- [ ] 定时触发器已创建
- [ ] 触发器名称为"stateProcessor"
- [ ] Cron表达式为"0 */30 * * * * *"
- [ ] 触发器状态为"启用"
- [ ] 定时触发器验证通过（查看日志）

### 数据库配置
- [ ] ai_tasks集合已创建
- [ ] task_queue字段已更新（state, state_data, retry_count）
- [ ] works集合权限已设置
- [ ] 数据库触发器已配置（如使用）

### 功能测试
- [ ] 生图功能测试通过
- [ ] 任务状态正常流转
- [ ] 失败重试机制正常
- [ ] 积分退还正常
- [ ] 前端进度查询正常

---

## 🎯 部署后监控

### 日常监控指标

1. **任务状态分布**
   - 定期检查各状态的任务数量
   - 关注是否有任务长时间卡在某个状态

2. **成功率**
   - 计算completed / (completed + failed)
   - 目标：>95%

3. **重试次数**
   - 统计retry_count分布
   - 分析哪些环节失败最多

4. **平均完成时间**
   - 计算completed_at - created_at
   - 目标：<5分钟

---

### 异常告警

建议设置以下告警：

1. **任务失败率过高**
   - 条件：1小时内失败率 > 10%
   - 动作：发送通知

2. **任务卡住**
   - 条件：某状态的任务 > 100个
   - 动作：检查该状态处理器

3. **AI超时频繁**
   - 条件：AI处理超时 > 5次/小时
   - 动作：检查AI服务

---

## 📚 相关文档

- `状态机架构生图流程详解.md` - 完整流程说明
- `状态机架构实施进度报告.md` - 实施总结
- `触发器配置手动操作指南.md` - 旧版触发器配置（已过时）

---

## 🆘 寻求帮助

如遇到问题：

1. 查看云函数日志
2. 检查本文档的"故障排查"部分
3. 查看详细流程文档
4. 联系技术支持

---

**部署指南完成**

祝部署顺利！🎉
