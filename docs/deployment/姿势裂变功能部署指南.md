# 🎭 姿势裂变功能部署指南

## 修改内容概览

本次更新为AI摄影师小程序添加了"姿势裂变"功能，允许用户基于已生成的作品，保持相同的模特和环境，生成不同姿势的新作品。

### 修改的文件：

#### 云函数
1. `cloudfunctions/photography/index.js` - 添加pose_variation模式处理
2. `cloudfunctions/photography-worker/index.js` - 保存scene_info用于裂变
3. `cloudfunctions/fitting/index.js` - 添加pose_variation模式处理
4. `cloudfunctions/fitting-worker/index.js` - 保存scene_info用于裂变
5. `cloudfunctions/prompt/index.js` - 添加姿势裂变提示词模板

#### 前端
1. `miniprogram/pages/work-detail/work-detail.wxml` - 添加姿势裂变UI
2. `miniprogram/pages/work-detail/work-detail.js` - 添加姿势裂变逻辑（支持photography和fitting）
3. `miniprogram/pages/work-detail/work-detail.wxss` - 姿势裂变样式

#### 数据库初始化
1. `init-pose-presets.js` - 初始化8个预设姿势

---

## 部署步骤

### 第一步：部署云函数

#### 方法1：使用PowerShell脚本（推荐）

```powershell
# 部署核心云函数
.\deploy-cloudfunctions.ps1

# 部署Worker函数
.\deploy-workers.ps1
```

#### 方法2：手动部署

在微信开发者工具中：

1. 右键点击 `cloudfunctions/photography` → 上传并部署：云端安装依赖
2. 右键点击 `cloudfunctions/photography-worker` → 上传并部署：云端安装依赖
3. 右键点击 `cloudfunctions/fitting` → 上传并部署：云端安装依赖
4. 右键点击 `cloudfunctions/fitting-worker` → 上传并部署：云端安装依赖
5. 右键点击 `cloudfunctions/prompt` → 上传并部署：云端安装依赖

### 第二步：初始化pose_presets数据库集合

#### 方法1：通过云开发控制台（推荐）

1. 打开微信开发者工具
2. 进入"云开发"控制台
3. 点击"数据库" → "集合管理"
4. 如果没有`pose_presets`集合，点击"添加集合"创建
5. 点击"云函数" → "新建云函数"
6. 将 `init-pose-presets.js` 的内容复制到新建的云函数中
7. 保存并部署该云函数
8. 在云函数列表中右键点击该函数 → "云端测试"
9. 执行成功后会看到 `✅ 成功初始化8个姿势预设`

#### 方法2：本地运行（需要配置云开发环境）

```bash
node init-pose-presets.js
```

### 第三步：验证部署

#### 1. 验证云函数部署
在云开发控制台 → 云函数，检查以下函数状态为"正常"：
- ✅ photography
- ✅ photography-worker
- ✅ fitting
- ✅ fitting-worker
- ✅ prompt

#### 2. 验证数据库集合
在云开发控制台 → 数据库 → pose_presets，应该看到8条记录：

| _id | name | category | icon_emoji |
|-----|------|----------|------------|
| pose_001 | 标准站姿 | standing | 👤 |
| pose_002 | S型曲线 | dynamic | 💃 |
| pose_003 | 优雅坐姿 | sitting | 🪑 |
| pose_004 | 45度侧身 | side | ↗️ |
| pose_005 | 回眸展示 | back | 👀 |
| pose_006 | 行走动态 | walking | 🚶 |
| pose_007 | 双手叉腰 | power | 💪 |
| pose_008 | 手托下巴 | elegant | 🤔 |

#### 3. 验证前端功能
1. 打开小程序
2. 进入"我的作品"页面
3. 打开任意已完成的AI摄影或AI试衣作品
4. 应该能看到三个操作按钮：【同款再生】【姿势裂变】【保存图片】
5. 点击【姿势裂变】按钮，弹出姿势选择弹窗
6. 可以选择预设姿势或输入自定义姿势描述
7. 点击"开始裂变"提交任务

---

## 功能说明

### 姿势裂变工作流程

1. **用户操作**：在作品详情页点击"姿势裂变"按钮
2. **选择姿势**：
   - 预设模式：从8个预设姿势中选择
   - 自定义模式：输入自定义姿势描述（最多500字）
3. **提交任务**：消耗1积分，创建新的生成任务
4. **AI处理**：
   - 读取原作品的场景信息（scene_info）
   - 提取第一张生成的图片作为模特参考
   - 提取原始上传的服装图片
   - 组合图片数组：`[模特图片, 服装图片1, 服装图片2, ...]`
   - 使用特殊提示词模板，强调保持模特和环境一致
   - 调用Gemini 2.5 Flash Image生成新姿势
5. **结果保存**：新作品标记为`variation_type: 'pose'`和`reference_work_id`

### 关键技术特性

- ✅ 支持AI摄影（photography）和AI试衣（fitting）两种类型
- ✅ 保持模特外观一致性
- ✅ 保持场景环境一致性
- ✅ 创建独立的新作品，不修改原作品
- ✅ 支持多张服装图片的情况
- ✅ 通过数据库管理姿势预设，便于扩展

### 提示词模板（pose_variation模式）

```
这是一组专业服装摄影的续拍任务。

参考图片说明：
- 第一张图片：展示了模特和拍摄场景（作为视觉基准参考）
- 之后的图片：需要展示的服装款式

请生成新的摄影作品，严格要求：
✅ 必须使用与第一张参考图片完全相同的模特
✅ 必须保持与第一张参考图片完全相同的场景环境
✅ 采用以下新姿势：{pose_description}

场景信息：{scene_name}
环境特点：{scene_description}
...
```

---

## 数据库字段更新

### works集合新增字段

```javascript
{
  scene_id: String,           // 场景ID（用于姿势裂变时查询场景信息）
  scene_info: Object,         // 完整场景信息（包含name, description等）
  reference_work_id: String,  // 如果是裂变作品，记录原作品ID
  variation_type: String      // 裂变类型：'pose'
}
```

---

## 常见问题

### Q: 为什么需要保存scene_info？
A: 姿势裂变时需要获取原作品的场景信息，但由于并发限制无法在worker中查询数据库，因此直接保存完整的scene_info对象，避免额外的数据库查询。

### Q: 姿势裂变消耗多少积分？
A: 1积分，与普通生成相同。

### Q: 可以对裂变后的作品再次裂变吗？
A: 可以。每个作品都保存了完整的场景信息，支持多次裂变。

### Q: 支持哪些作品类型？
A: 目前支持AI摄影（photography）和AI试衣（fitting）两种类型。

### Q: 如何添加新的预设姿势？
A: 在云开发控制台的pose_presets集合中直接添加记录即可，无需修改代码。

---

## 部署检查清单

- [ ] photography云函数部署成功
- [ ] photography-worker云函数部署成功
- [ ] fitting云函数部署成功
- [ ] fitting-worker云函数部署成功
- [ ] prompt云函数部署成功
- [ ] pose_presets集合已创建
- [ ] pose_presets集合有8条预设数据
- [ ] 小程序前端能看到"姿势裂变"按钮
- [ ] 点击按钮能弹出姿势选择弹窗
- [ ] 能加载到8个预设姿势
- [ ] 能输入自定义姿势描述
- [ ] 提交任务成功并跳转到进度页面

---

## 技术支持

如有问题，请查看：
- 云函数日志：云开发控制台 → 云函数 → 日志
- 数据库记录：云开发控制台 → 数据库 → pose_presets / works
- 前端控制台：微信开发者工具 → Console

部署完成日期：2025-10-04
