# AI摄影师小程序 - 手动部署指南

由于自动部署脚本有编码问题，请手动按以下步骤部署：

## 🔧 已修复的问题
✅ API文件语法错误已修复
✅ 项目配置文件已更新
✅ 所有模拟数据已清理

## 🚀 手动部署步骤

### 第一步：在微信开发者工具中部署云函数

1. **打开微信开发者工具**
2. **确保项目已正确加载** - 项目目录：`c:\Users\qq100\Desktop\新建文件夹 (4)`
3. **点击工具栏中的"云开发"按钮**
4. **在云开发控制台中，逐个部署以下云函数**：

#### 必须部署的云函数列表：
- [ ] `api` - 通用API接口
- [ ] `user` - 用户管理  
- [ ] `photography` - 摄影功能
- [ ] `fitting` - 试衣功能
- [ ] `payment` - 支付功能
- [ ] `scene` - 场景管理
- [ ] `storage` - 存储管理
- [ ] `prompt` - 提示词管理（新增）
- [ ] `aimodels` - AI模型管理（新增）

#### 部署方法：
1. 在云开发控制台选择"云函数"
2. 点击"创建云函数"
3. 选择对应的文件夹进行部署
4. 等待部署完成

### 第二步：初始化数据库

1. **在云开发控制台中选择"数据库"**
2. **运行初始化脚本**：
   - 可以直接在控制台中创建集合
   - 或运行 `database-init.js` 脚本

#### 需要创建的数据库集合：
- [x] `api_configs` - AI模型配置（已存在）
- [x] `prompt_templates` - 提示词模板（已存在）
- [x] `scenes` - 摄影场景（已存在）
- [ ] `users` - 用户信息
- [ ] `works` - 用户作品
- [ ] `admin_users` - 管理员用户
- [ ] `packages` - 充值套餐

### 第三步：设置数据库权限

#### 重要：必须正确设置数据库权限以确保数据安全

详细的权限设置步骤请参考：`SETUP_DATABASE_PERMISSIONS.md`

**快速权限设置：**
1. **admin_users** - 仅管理端可读写
2. **users** - 仅创建者可读写 (`doc._openid == auth.openid`)
3. **works** - 仅创建者可读写 (`doc._openid == auth.openid`)
4. **api_configs** - 所有用户可读，仅管理端可写
5. **prompt_templates** - 所有用户可读，仅管理端可写
6. **scenes** - 所有用户可读，仅管理端可写

### 第四步：配置管理员权限

在 `admin_users` 集合中添加管理员记录：

```json
{
  "openid": "你的微信openid",
  "nickname": "管理员名称", 
  "is_active": true,
  "permissions": ["admin"],
  "created_at": "当前时间"
}
```

**获取你的openid方法**：
1. 在小程序中登录
2. 在云开发控制台查看 `users` 集合
3. 找到你的用户记录，复制 `openid`

### 第五步：配置云存储

1. **设置云存储安全规则**
2. **创建必要的文件夹结构**：
   - `images/` - 图片存储
   - `works/` - 作品文件
   - `temp/` - 临时文件

### 第六步：测试验证

1. **测试用户登录功能**
2. **测试管理中心访问**：
   - 在个人中心页面连续点击头像10次
   - 验证是否能够进入管理中心
3. **测试基础功能**：
   - 场景列表加载
   - 拍照上传功能
   - 作品展示功能

## ⚠️ 重要提醒

### API密钥配置
- 🔴 **不要在代码中硬编码真实的API密钥**
- 🟢 **在管理中心中配置AI模型的API密钥**
- 🔵 **使用环境变量管理敏感信息**

### 环境变量设置
在云开发控制台设置以下环境变量：
```
ADMIN_USERS=openid1,openid2,openid3
AI_MODEL_TIMEOUT=30000
MAX_UPLOAD_SIZE=10485760
```

## 🎉 部署完成检查清单

部署完成后，请验证以下功能：

### 用户端功能
- [ ] 微信登录注册
- [ ] 拍照上传功能
- [ ] 作品列表展示
- [ ] 个人中心信息

### 管理端功能  
- [ ] 管理中心隐藏入口正常
- [ ] AI模型管理功能
- [ ] 提示词管理功能
- [ ] 场景管理功能
- [ ] 权限控制有效

### 系统功能
- [ ] 云函数响应正常
- [ ] 数据库读写正常
- [ ] 文件上传正常
- [ ] 错误处理正常

## 📞 如有问题

如果遇到部署问题，请检查：

1. **微信开发者工具版本** - 使用最新稳定版
2. **基础库版本** - 设置为2.2.3或以上
3. **云开发环境** - 确保已开通并选择正确
4. **网络连接** - 确保网络畅通
5. **项目权限** - 确保有云开发操作权限

祝您部署顺利！🎊