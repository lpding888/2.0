# 触发器配置手动操作指南

## 📋 前置条件

1. ✅ 已完成代码改造
2. ✅ 已部署 `task-processor` 云函数
3. ✅ 已部署 `photography` 云函数（简化版）
4. ✅ 已部署 `fitting` 云函数（简化版）

---

## 🚀 配置步骤

### 步骤 1：打开云开发控制台

1. 打开**微信开发者工具**
2. 打开你的小程序项目
3. 点击顶部菜单栏的 **"云开发"** 按钮
4. 在弹出的页面中，点击 **"前往控制台"** （会在浏览器中打开）

---

### 步骤 2：配置定时触发器

#### 2.1 进入云函数管理

1. 在云开发控制台左侧菜单，点击 **"云函数"**
2. 找到 `task-processor` 云函数，点击进入详情

#### 2.2 配置定时触发器

1. 点击 **"触发器"** 标签
2. 点击 **"创建触发器"** 按钮

配置信息：
- **触发器名称**：`taskCleanup`
- **触发周期**：自定义
- **Cron 表达式**：`0 */3 * * * * *`

说明：
- `0 */3 * * * * *` 表示每3分钟执行一次
- Cron格式：`秒 分 时 日 月 星期 年`
- 例如：
  - `0 */1 * * * * *` - 每分钟执行
  - `0 */5 * * * * *` - 每5分钟执行
  - `0 0 * * * * *` - 每小时执行

#### 2.3 保存配置

1. 点击 **"确定"** 保存
2. 确认触发器状态为 **"启用"**
3. 记录触发器ID（用于后续验证）

---

### 步骤 3：配置数据库触发器

#### 3.1 进入数据库管理

1. 在云开发控制台左侧菜单，点击 **"数据库"**
2. 找到 `task_queue` 集合
3. 点击 `task_queue` 进入详情页

#### 3.2 创建数据库触发器

1. 点击 **"触发器"** 标签（位于顶部）
2. 点击 **"添加触发器"** 按钮

配置信息：
- **触发器名称**：`taskQueueCreate`
- **监听集合**：`task_queue`
- **触发事件**：选择 **"写入"** → 只勾选 **"创建"**
- **目标云函数**：选择 `task-processor`

注意事项：
- ⚠️ **微信云开发不支持触发条件过滤**（例如 `status === 'pending'`）
- 触发器会在每次文档创建时都触发
- 代码中已经添加了状态判断逻辑，自动过滤非pending任务

#### 3.3 保存配置

1. 点击 **"确定"** 保存
2. 确认触发器状态为 **"启用"**

---

## ✅ 验证配置

### 验证 1：定时触发器

#### 方法 1：查看云函数日志

1. 进入 `task-processor` 云函数详情
2. 点击 **"日志"** 标签
3. 等待 3 分钟
4. 查看是否有新的日志记录
5. 搜索关键字：`⏰ 定时触发器运行`

预期输出：
```
⏰ 定时触发器运行 - 检查卡住的任务
🔍 发现 0 个卡住的任务
```

#### 方法 2：手动触发测试

1. 进入 `task-processor` 云函数详情
2. 点击 **"测试"** 标签
3. 输入测试参数：
```json
{
  "triggerName": "taskCleanup"
}
```
4. 点击 **"云端测试"**
5. 查看返回结果

预期返回：
```json
{
  "success": true,
  "message": "没有卡住的任务"
}
```

---

### 验证 2：数据库触发器

#### 方法 1：创建测试任务

1. 在小程序端提交一次生图任务
2. 立即查看 `task-processor` 云函数日志
3. 搜索关键字：`📥 数据库触发器运行`

预期日志流程：
```
🚀 task-processor 被触发
📥 数据库触发器运行
📥 数据库触发器事件: create
🎯 开始处理任务: photo_xxxxx
📝 生成的提示词: 专业时尚摄影...
🚀 调用 aimodels 云函数...
✅ aimodels 调用完成
```

#### 方法 2：手动创建测试记录

1. 进入云开发控制台 → 数据库
2. 选择 `task_queue` 集合
3. 点击 **"添加记录"**
4. 输入测试数据：
```json
{
  "_id": "test_task_001",
  "user_openid": "测试用户openid",
  "type": "photography",
  "status": "pending",
  "params": {
    "images": [],
    "parameters": {},
    "sceneId": null,
    "count": 1
  },
  "created_at": {
    "$date": "2025-10-01T00:00:00.000Z"
  },
  "updated_at": {
    "$date": "2025-10-01T00:00:00.000Z"
  }
}
```
5. 点击 **"确定"** 创建
6. 立即查看 `task-processor` 日志

预期行为：
- ✅ 触发器自动调用 `task-processor`
- ✅ 日志显示处理流程
- ✅ 任务状态变为 `processing` 或 `failed`

---

## 🔍 故障排查

### 问题 1：定时触发器没有运行

**可能原因**：
1. Cron 表达式配置错误
2. 触发器未启用
3. 云函数有错误

**解决方法**：
1. 检查 Cron 表达式格式是否正确
2. 确认触发器状态为 **"启用"**
3. 查看云函数日志是否有报错

---

### 问题 2：数据库触发器没有触发

**可能原因**：
1. 触发器配置错误
2. 集合名称不匹配
3. 触发事件选择错误

**解决方法**：
1. 确认触发器监听的集合是 `task_queue`
2. 确认触发事件选择了 **"创建"**
3. 确认目标云函数是 `task-processor`
4. 手动创建测试记录验证

---

### 问题 3：任务一直是 pending 状态

**可能原因**：
1. 触发器未配置或未生效
2. `task-processor` 云函数有错误
3. `aimodels` 云函数调用失败

**排查步骤**：
1. 查看 `task-processor` 日志
2. 查看 `aimodels` 日志
3. 检查任务记录的 `error` 字段

---

### 问题 4：AI 生成失败

**可能原因**：
1. AI API 密钥未配置
2. AI 服务超时
3. 图片处理失败

**解决方法**：
1. 检查环境变量中的 AI API 密钥
2. 查看 `aimodels` 云函数日志
3. 检查图片上传是否成功

---

## 📊 监控和维护

### 日常监控

#### 1. 查看触发器运行次数

1. 进入云开发控制台 → 统计分析
2. 选择 **"云函数"**
3. 查看 `task-processor` 的调用次数
4. 正常情况：
   - 定时触发：每小时约 20 次（每3分钟1次）
   - 数据库触发：根据实际任务数

#### 2. 查看任务处理成功率

定期执行数据库查询：
```javascript
// 在云开发控制台 → 数据库 → 查询
db.collection('task_queue')
  .aggregate()
  .group({
    _id: '$status',
    count: $.sum(1)
  })
  .end()
```

预期结果：
```json
{
  "data": [
    { "_id": "completed", "count": 95 },
    { "_id": "failed", "count": 5 },
    { "_id": "processing", "count": 0 }
  ]
}
```

#### 3. 处理卡住的任务

如果发现任务长时间处于 `processing` 状态：

1. 查看任务创建时间
2. 如果超过 10 分钟，定时触发器会自动重试
3. 如果仍然失败，查看日志排查原因

---

## 🎯 性能优化建议

### 1. 调整定时触发器频率

根据实际任务量调整：

- **低流量**（每天 < 10 个任务）：每 5 分钟
  ```
  0 */5 * * * * *
  ```

- **中流量**（每天 10-100 个任务）：每 3 分钟（当前配置）
  ```
  0 */3 * * * * *
  ```

- **高流量**（每天 > 100 个任务）：每 1 分钟
  ```
  0 */1 * * * * *
  ```

### 2. 优化任务重试次数

修改 `task-processor/index.js` 中的限制：
```javascript
// 第 141 行
.limit(5)  // 每次处理 5 个卡住的任务
```

根据服务器性能调整：
- 低性能：`limit(3)`
- 中性能：`limit(5)`（默认）
- 高性能：`limit(10)`

### 3. 调整任务超时判断

修改 `task-processor/index.js` 中的时间：
```javascript
// 第 132 行
const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000)
```

根据 AI 服务响应时间调整：
- AI 服务快（< 30 秒）：5 分钟
- AI 服务中等（30-60 秒）：10 分钟（默认）
- AI 服务慢（> 60 秒）：15 分钟

---

## 📚 相关文档

- [微信云开发 - 定时触发器](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)
- [微信云开发 - 数据库触发器](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/triggers.html)
- [生图流程分析和改造计划](./生图流程分析和改造计划.md)

---

## ✅ 配置完成检查清单

使用此清单确认所有配置已完成：

- [ ] ✅ 定时触发器已创建并启用
- [ ] ✅ 数据库触发器已创建并启用
- [ ] ✅ 定时触发器验证通过（查看日志）
- [ ] ✅ 数据库触发器验证通过（创建测试任务）
- [ ] ✅ 生图功能测试通过
- [ ] ✅ 任务状态正常流转（pending → processing → completed）
- [ ] ✅ 失败任务能够退还积分
- [ ] ✅ 卡住任务能够自动重试

---

**配置完成后，新架构即刻生效！**

🎉 **架构优势**：
- ⚡ 任务提交立即返回
- 🚀 数据库触发器自动处理
- 🛡️ 定时触发器兜底保障
- 📱 前端实时监听更新（可选）
