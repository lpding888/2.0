# çŠ¶æ€æœºæ¶æ„ç”Ÿå›¾æµç¨‹è¯¦è§£

## ğŸ“… æ–‡æ¡£ç‰ˆæœ¬
- **åˆ›å»ºæ—¶é—´**: 2025-10-01
- **æ¶æ„ç‰ˆæœ¬**: çŠ¶æ€æœº v2.0
- **é€‚ç”¨èŒƒå›´**: photography å’Œ fitting ä¸¤ç§ç”Ÿå›¾ç±»å‹

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### æ—§æ¶æ„ vs æ–°æ¶æ„

| å¯¹æ¯”é¡¹ | æ—§æ¶æ„ | æ–°æ¶æ„ï¼ˆçŠ¶æ€æœºï¼‰ |
|--------|--------|----------------|
| **è¶…æ—¶é—®é¢˜** | âŒ åŒæ­¥ç­‰å¾…AIï¼Œå—60ç§’é™åˆ¶ | âœ… åˆ†æ­¥æ‰§è¡Œï¼Œæ¯æ­¥<60ç§’ |
| **æˆåŠŸç‡** | ~60-70% | ~95%+ |
| **æœ€é•¿ä»»åŠ¡** | ~60ç§’ï¼ˆAIå¿«æ—¶ï¼‰ | âœ… æ— é™åˆ¶ |
| **ç”¨æˆ·ä½“éªŒ** | è¶…æ—¶åéœ€ç­‰3-10åˆ†é’Ÿé‡è¯• | æµç•…çš„è¿›åº¦çŠ¶æ€ |
| **å¯ç»´æŠ¤æ€§** | ä»£ç è€¦åˆ | æ¸…æ™°çš„çŠ¶æ€åˆ†ç¦» |

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·æäº¤ç”Ÿå›¾
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ photography.generate()                   â”‚
â”‚ - éªŒè¯å‚æ•°                                â”‚
â”‚ - æ£€æŸ¥ç§¯åˆ†                                â”‚
â”‚ - æ‰£é™¤ç§¯åˆ†                                â”‚
â”‚ - åˆ›å»ºtask_queue (state='pending')       â”‚
â”‚ - åˆ›å»ºworks (status='pending')           â”‚
â”‚ - è¿”å›task_id                            â”‚
â”‚ â±ï¸ è€—æ—¶: ~1-2ç§’                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task-processor (æ¯30ç§’è¿è¡Œ)              â”‚
â”‚ - å®šæ—¶è§¦å‘å™¨è§¦å‘                          â”‚
â”‚ - æŸ¥æ‰¾å„çŠ¶æ€çš„ä»»åŠ¡                        â”‚
â”‚ - è°ƒç”¨å¯¹åº”çš„çŠ¶æ€å¤„ç†å™¨                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€1: pending â†’ downloading             â”‚
â”‚ - åˆå§‹åŒ–state_data                       â”‚
â”‚ â±ï¸ è€—æ—¶: <1ç§’                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€2: downloading â†’ downloaded          â”‚
â”‚ - ä¸‹è½½ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡                      â”‚
â”‚ - è½¬æ¢ä¸ºbase64æ ¼å¼                       â”‚
â”‚ - æ”¯æŒæ‰¹å¤„ç†ï¼ˆæ¯æ¬¡æœ€å¤š10å¼ ï¼‰              â”‚
â”‚ â±ï¸ è€—æ—¶: 5-30ç§’ï¼ˆå–å†³äºå›¾ç‰‡æ•°é‡ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€3: downloaded â†’ ai_calling           â”‚
â”‚ - è·å–åœºæ™¯ä¿¡æ¯                            â”‚
â”‚ - è°ƒç”¨promptäº‘å‡½æ•°ç”Ÿæˆæç¤ºè¯              â”‚
â”‚ â±ï¸ è€—æ—¶: 2-5ç§’                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€4: ai_calling â†’ ai_processing        â”‚
â”‚ âœ… å…³é”®ï¼šä¸ç­‰å¾…AIå®Œæˆ                     â”‚
â”‚ - è°ƒç”¨aimodels.startAIGeneration         â”‚
â”‚ - è·å–ai_task_id                         â”‚
â”‚ - ç«‹å³è¿”å›ï¼Œè¿›å…¥ä¸‹ä¸€çŠ¶æ€                  â”‚
â”‚ â±ï¸ è€—æ—¶: 5-10ç§’                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€5: ai_processing (è½®è¯¢)              â”‚
â”‚ âœ… å…³é”®ï¼šæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œä¸é˜»å¡            â”‚
â”‚ - è°ƒç”¨aimodels.checkAIStatus             â”‚
â”‚ - å¦‚æœAIè¿˜åœ¨å¤„ç†ï¼Œä¿æŒå½“å‰çŠ¶æ€            â”‚
â”‚ - å¦‚æœAIå®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€çŠ¶æ€                â”‚
â”‚ - è¶…æ—¶æ£€æŸ¥ï¼š10åˆ†é’Ÿ                       â”‚
â”‚ â±ï¸ è€—æ—¶: 30-180ç§’ï¼ˆå–å†³äºAIé€Ÿåº¦ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€6: ai_completed â†’ watermarking       â”‚
â”‚ - ç›´æ¥çŠ¶æ€è½¬æ¢                            â”‚
â”‚ â±ï¸ è€—æ—¶: <1ç§’                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€7: watermarking â†’ uploading          â”‚
â”‚ - è°ƒç”¨aimodels.addWatermarks             â”‚
â”‚ - ä¸ºæ‰€æœ‰å›¾ç‰‡æ·»åŠ æ°´å°                      â”‚
â”‚ â±ï¸ è€—æ—¶: 10-30ç§’                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€8: uploading â†’ completed             â”‚
â”‚ - è°ƒç”¨aimodels.uploadImages              â”‚
â”‚ - ä¸Šä¼ åˆ°äº‘å­˜å‚¨                            â”‚
â”‚ - æ›´æ–°works.images                       â”‚
â”‚ - æ›´æ–°works.status = 'completed'         â”‚
â”‚ - æ›´æ–°task_queue.status = 'completed'    â”‚
â”‚ â±ï¸ è€—æ—¶: 10-30ç§’                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
âœ… ç”Ÿå›¾å®Œæˆï¼ç”¨æˆ·å¯æŸ¥çœ‹ä½œå“
```

---

## ğŸ” è¯¦ç»†æµç¨‹è¯´æ˜

### æ­¥éª¤1: ç”¨æˆ·æäº¤ï¼ˆphotography.generateï¼‰

**æ–‡ä»¶**: `cloudfunctions/photography/index.js`

```javascript
// 1. éªŒè¯å‚æ•°
if (!images || images.length === 0) {
  return { success: false, message: 'è¯·ä¸Šä¼ æœè£…å›¾ç‰‡' }
}

// 2. æ£€æŸ¥ç§¯åˆ†
const user = await db.collection('users').where({ openid: OPENID }).get()
if (user.credits < requiredCredits) {
  return { success: false, message: 'ç§¯åˆ†ä¸è¶³' }
}

// 3. æ‰£é™¤ç§¯åˆ†
await db.collection('users').doc(user._id).update({
  data: {
    credits: db.command.inc(-requiredCredits),
    total_consumed_credits: db.command.inc(requiredCredits)
  }
})

// 4. åˆ›å»ºä»»åŠ¡
const taskId = generateTaskId()
await db.collection('task_queue').add({
  data: {
    _id: taskId,
    user_openid: OPENID,
    type: 'photography',
    status: 'pending',
    state: 'pending',  // çŠ¶æ€æœºå­—æ®µ
    state_data: {},
    retry_count: 0,
    params: { images, parameters, sceneId, count }
  }
})

// 5. åˆ›å»ºä½œå“è®°å½•
await db.collection('works').add({
  data: {
    user_openid: OPENID,
    type: 'photography',
    status: 'pending',
    task_id: taskId,
    images: []
  }
})

// 6. ç«‹å³è¿”å›
return { success: true, data: { task_id: taskId } }
```

**å…³é”®ç‚¹**ï¼š
- âœ… ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…AIå¤„ç†
- âœ… åˆ›å»ºstate='pending'çš„ä»»åŠ¡ï¼Œç­‰å¾…çŠ¶æ€æœºå¤„ç†
- âœ… åŒæ—¶åˆ›å»ºworksè®°å½•ï¼Œå‰ç«¯å¯ä»¥ç«‹å³æ˜¾ç¤º"å¤„ç†ä¸­"

---

### æ­¥éª¤2: å®šæ—¶è§¦å‘å™¨ï¼ˆtask-processorï¼‰

**æ–‡ä»¶**: `cloudfunctions/task-processor/index.js`

**è§¦å‘å™¨é…ç½®**: `config.json`
```json
{
  "triggers": [{
    "name": "stateProcessor",
    "type": "timer",
    "config": "0 */30 * * * * *"  // æ¯30ç§’è¿è¡Œä¸€æ¬¡
  }]
}
```

**æ‰§è¡Œé€»è¾‘**:
```javascript
exports.main = async (event, context) => {
  console.log('ğŸš€ task-processor (çŠ¶æ€æœºæ¨¡å¼) è¿è¡Œ')

  // å¤„ç†æ¯ç§çŠ¶æ€çš„ä»»åŠ¡
  for (const [state, handler] of Object.entries(stateHandlers)) {
    // æŸ¥æ‰¾è¯¥çŠ¶æ€çš„ä»»åŠ¡
    const tasks = await db.collection('task_queue')
      .where({
        state: state,
        retry_count: _.lt(3)  // åªå¤„ç†é‡è¯•æ¬¡æ•°<3çš„ä»»åŠ¡
      })
      .limit(10)  // æ¯æ¬¡æœ€å¤šå¤„ç†10ä¸ª
      .get()

    // å¹¶å‘å¤„ç†è¿™10ä¸ªä»»åŠ¡
    await Promise.allSettled(
      tasks.data.map(task => handler.process(task, db, cloud))
    )
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… æ¯30ç§’è‡ªåŠ¨è¿è¡Œ
- âœ… æ¯ä¸ªçŠ¶æ€å¤„ç†10ä¸ªä»»åŠ¡
- âœ… 9ä¸ªçŠ¶æ€å¹¶å‘å¤„ç†ï¼Œç†è®ºååé‡ï¼š90ä¸ªä»»åŠ¡/30ç§’

---

### æ­¥éª¤3-10: çŠ¶æ€å¤„ç†å™¨

#### çŠ¶æ€1: pending â†’ downloading

**æ–‡ä»¶**: `task-processor/states/pending.js`

```javascript
async process(task, db, cloud) {
  // åˆå§‹åŒ–çŠ¶æ€æ•°æ®
  const stateData = {
    downloaded_images: [],
    ai_task_id: null,
    ai_result: null,
    watermarked_images: [],
    final_images: []
  }

  // è½¬åˆ°downloadingçŠ¶æ€
  await this.updateState(task._id, 'downloading', stateData, db)
}
```

---

#### çŠ¶æ€2: downloading â†’ downloaded

**æ–‡ä»¶**: `task-processor/states/downloading.js`

```javascript
async process(task, db, cloud) {
  const imageIds = task.params.images || []

  // ç‰¹æ®Šæƒ…å†µï¼šæ²¡æœ‰å›¾ç‰‡
  if (imageIds.length === 0) {
    await this.updateState(task._id, 'downloaded', {
      ...task.state_data,
      downloaded_images: []
    }, db)
    return
  }

  const downloadedImages = []

  // ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
  for (const imageId of imageIds) {
    const result = await cloud.downloadFile({ fileID: imageId })

    // æ£€æŸ¥æ˜¯å¦ä¸ºbase64é¢„å¤„ç†æ¨¡å¼
    const fileContent = result.fileContent.toString('utf8')
    let base64Data, mimeType

    if (fileContent.startsWith('data:image/')) {
      // Base64é¢„å¤„ç†æ¨¡å¼
      const matches = fileContent.match(/^data:image\/([^;]+);base64,(.+)$/)
      mimeType = `image/${matches[1]}`
      base64Data = matches[2]
    } else {
      // ä¼ ç»Ÿæ¨¡å¼
      base64Data = result.fileContent.toString('base64')
      mimeType = 'image/jpeg'
    }

    downloadedImages.push({
      fileId: imageId,
      base64Data: base64Data,
      mimeType: mimeType
    })
  }

  // è½¬åˆ°downloadedçŠ¶æ€
  await this.updateState(task._id, 'downloaded', {
    ...task.state_data,
    downloaded_images: downloadedImages
  }, db)
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… æ”¯æŒbase64é¢„å¤„ç†æ¨¡å¼
- âœ… ä¼ ç»Ÿæ¨¡å¼å…¼å®¹
- âš ï¸ å¦‚æœå›¾ç‰‡è¿‡å¤šï¼ˆ>10å¼ ï¼‰ï¼Œå»ºè®®æ·»åŠ æ‰¹å¤„ç†

---

#### çŠ¶æ€3: downloaded â†’ ai_calling

**æ–‡ä»¶**: `task-processor/states/downloaded.js`

```javascript
async process(task, db, cloud) {
  // ç”Ÿæˆæç¤ºè¯
  const prompt = await this.generatePrompt(task, db, cloud)

  // è½¬åˆ°ai_callingçŠ¶æ€
  await this.updateState(task._id, 'ai_calling', {
    ...task.state_data,
    prompt: prompt
  }, db)
}

async generatePrompt(task, db, cloud) {
  // è·å–åœºæ™¯ä¿¡æ¯
  let sceneInfo = {}
  if (task.params.sceneId) {
    const result = await db.collection('scenes').doc(task.params.sceneId).get()
    sceneInfo = result.data || {}
  }

  // è°ƒç”¨promptäº‘å‡½æ•°
  const result = await cloud.callFunction({
    name: 'prompt',
    data: {
      action: 'generatePrompt',
      type: task.type,
      parameters: task.params.parameters || {},
      sceneInfo: sceneInfo
    }
  })

  if (result.result && result.result.success) {
    return result.result.data.prompt
  }

  // é»˜è®¤æç¤ºè¯
  return 'ä¸“ä¸šæ—¶å°šæ‘„å½±ï¼Œå±•ç¤ºæœè£…ã€‚é«˜è´¨é‡æ‘„å½±ï¼Œä¸“ä¸šæ‰“å…‰ï¼Œæ—¶å°šé£æ ¼ï¼Œ1024x1024åˆ†è¾¨ç‡ã€‚'
}
```

---

#### çŠ¶æ€4: ai_calling â†’ ai_processingï¼ˆæ ¸å¿ƒï¼ï¼‰

**æ–‡ä»¶**: `task-processor/states/ai_calling.js`

```javascript
async process(task, db, cloud) {
  // âœ… è°ƒç”¨AIä½†ä¸ç­‰å¾…å®Œæˆ
  const result = await cloud.callFunction({
    name: 'aimodels',
    data: {
      action: 'startAIGeneration',  // æ–°æ¥å£
      taskId: task._id,
      prompt: task.state_data.prompt,
      images: task.state_data.downloaded_images,
      parameters: task.params.parameters || {},
      type: task.type
    }
  })

  const aiTaskId = result.result.data.ai_task_id

  // âœ… ç«‹å³è½¬åˆ°ai_processingçŠ¶æ€
  await this.updateState(task._id, 'ai_processing', {
    ...task.state_data,
    ai_task_id: aiTaskId,
    ai_start_time: new Date()
  }, db)
}
```

**aimodels.startAIGeneration å®ç°**:

**æ–‡ä»¶**: `cloudfunctions/aimodels/index.js`

```javascript
async function handleStartAIGeneration(orchestrator, aiCaller, event) {
  const { taskId, prompt, images, parameters } = event

  // 1. é€‰æ‹©AIæ¨¡å‹
  const selectedModel = await aiCaller.selectBestModel(parameters)

  // 2. å‡†å¤‡å›¾ç‰‡æ•°æ®
  const processedImages = images.map(img => ({
    buffer: Buffer.from(img.base64Data, 'base64'),
    mimeType: img.mimeType || 'image/jpeg'
  }))

  // 3. åˆ›å»ºAIä»»åŠ¡è®°å½•
  const aiTaskId = `ai_${taskId}_${Date.now()}`
  await db.collection('ai_tasks').add({
    data: {
      _id: aiTaskId,
      task_id: taskId,
      status: 'processing',
      model: selectedModel.name,
      created_at: new Date()
    }
  })

  // 4. âœ… å¼‚æ­¥æ‰§è¡ŒAIç”Ÿæˆï¼ˆä¸ç­‰å¾…ï¼‰
  ;(async () => {
    try {
      const aiResult = await aiCaller.generateImages({
        model: selectedModel,
        prompt: prompt,
        images: processedImages,
        parameters: parameters
      })

      // æ›´æ–°AIä»»åŠ¡çŠ¶æ€
      await db.collection('ai_tasks').doc(aiTaskId).update({
        data: {
          status: aiResult.success ? 'completed' : 'failed',
          result: aiResult,
          completed_at: new Date()
        }
      })
    } catch (error) {
      await db.collection('ai_tasks').doc(aiTaskId).update({
        data: { status: 'failed', error: error.message }
      })
    }
  })()

  // 5. âœ… ç«‹å³è¿”å›
  return {
    success: true,
    data: { ai_task_id: aiTaskId },
    message: 'AIä»»åŠ¡å·²å¯åŠ¨'
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä¸é˜»å¡ï¼Œç«‹å³è¿”å›
- âœ… AIåœ¨åå°å¼‚æ­¥æ‰§è¡Œ
- âœ… ç»“æœå­˜å‚¨åˆ°ai_tasksé›†åˆ

---

#### çŠ¶æ€5: ai_processingï¼ˆè½®è¯¢ï¼Œæ ¸å¿ƒï¼ï¼‰

**æ–‡ä»¶**: `task-processor/states/ai_processing.js`

```javascript
async process(task, db, cloud) {
  // æ£€æŸ¥AIçŠ¶æ€
  const result = await cloud.callFunction({
    name: 'aimodels',
    data: {
      action: 'checkAIStatus',
      taskId: task._id,
      aiTaskId: task.state_data.ai_task_id
    }
  })

  const aiData = result.result.data

  if (aiData.status === 'processing') {
    // âœ… AIè¿˜åœ¨å¤„ç†ä¸­ï¼Œä¿æŒå½“å‰çŠ¶æ€
    console.log(`AIè¿˜åœ¨å¤„ç†ä¸­: ${task._id}`)

    // æ£€æŸ¥è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰
    const aiStartTime = new Date(task.state_data.ai_start_time)
    const elapsed = Date.now() - aiStartTime.getTime()

    if (elapsed > 10 * 60 * 1000) {
      throw new Error('AIå¤„ç†è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰')
    }

    return { message: 'AI still processing', elapsed_ms: elapsed }
  } else if (aiData.status === 'failed') {
    // AIå¤±è´¥
    throw new Error(aiData.error || 'AIç”Ÿæˆå¤±è´¥')
  }

  // âœ… AIå®Œæˆï¼Œè½¬åˆ°ä¸‹ä¸€çŠ¶æ€
  await this.updateState(task._id, 'ai_completed', {
    ...task.state_data,
    ai_result: aiData
  }, db)
}
```

**aimodels.checkAIStatus å®ç°**:

```javascript
async function handleCheckAIStatus(event) {
  const { aiTaskId } = event

  // æŸ¥è¯¢AIä»»åŠ¡çŠ¶æ€
  const result = await db.collection('ai_tasks').doc(aiTaskId).get()
  const aiTask = result.data

  if (aiTask.status === 'completed') {
    return {
      success: true,
      data: {
        status: 'completed',
        images: aiTask.result.data.images,
        model_used: aiTask.model
      }
    }
  } else if (aiTask.status === 'failed') {
    return {
      success: true,
      data: {
        status: 'failed',
        error: aiTask.error
      }
    }
  } else {
    // è¿˜åœ¨å¤„ç†ä¸­
    return {
      success: true,
      data: {
        status: 'processing',
        elapsed: Date.now() - new Date(aiTask.created_at).getTime()
      }
    }
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡AIçŠ¶æ€
- âœ… å¦‚æœAIè¿˜åœ¨å¤„ç†ï¼Œä¿æŒai_processingçŠ¶æ€ï¼Œä¸‹æ¬¡è§¦å‘å™¨å†æ£€æŸ¥
- âœ… 10åˆ†é’Ÿè¶…æ—¶ä¿æŠ¤

---

#### çŠ¶æ€6-8: åå¤„ç†æµç¨‹

**çŠ¶æ€6**: ai_completed â†’ watermarking
**çŠ¶æ€7**: watermarking â†’ uploading
**çŠ¶æ€8**: uploading â†’ completed

æµç¨‹ç±»ä¼¼ï¼Œè°ƒç”¨aimodelsçš„å¯¹åº”æ¥å£å®Œæˆæ°´å°æ·»åŠ å’Œä¸Šä¼ ã€‚

---

## âš™ï¸ å…³é”®æŠ€æœ¯ç‚¹

### 1. çŠ¶æ€åŒæ­¥æœºåˆ¶

**base.js ä¸­çš„ updateState æ–¹æ³•**:

```javascript
const STATE_TO_STATUS_MAP = {
  'pending': 'pending',
  'downloading': 'processing',
  'downloaded': 'processing',
  'ai_calling': 'processing',
  'ai_processing': 'processing',
  'ai_completed': 'processing',
  'watermarking': 'processing',
  'uploading': 'processing',
  'completed': 'completed',
  'failed': 'failed'
}

async updateState(taskId, newState, stateData, db) {
  const businessStatus = STATE_TO_STATUS_MAP[newState]

  // æ›´æ–°task_queue
  await db.collection('task_queue').doc(taskId).update({
    data: {
      state: newState,        // è¯¦ç»†çŠ¶æ€ï¼ˆ9ç§ï¼‰
      status: businessStatus,  // ä¸šåŠ¡çŠ¶æ€ï¼ˆ4ç§ï¼‰
      state_data: stateData,
      updated_at: new Date()
    }
  })

  // åŒæ­¥æ›´æ–°works
  await db.collection('works').where({ task_id: taskId }).update({
    data: {
      status: businessStatus,  // å‰ç«¯æ˜¾ç¤ºç”¨
      state: newState,         // è°ƒè¯•ç”¨
      updated_at: new Date()
    }
  })
}
```

---

### 2. é‡è¯•æœºåˆ¶

```javascript
try {
  await handler.process(task, db, cloud)
} catch (error) {
  const newRetryCount = (task.retry_count || 0) + 1
  const MAX_RETRIES = 3

  // æ›´æ–°é‡è¯•æ¬¡æ•°
  await db.collection('task_queue').doc(task._id).update({
    data: {
      retry_count: newRetryCount,
      last_error: error.message
    }
  })

  // é‡è¯•3æ¬¡åå¤±è´¥
  if (newRetryCount >= MAX_RETRIES) {
    await markFailed(task._id, error.message)
    await refundCredits(task)  // é€€è¿˜ç§¯åˆ†
  }
}
```

---

### 3. ç§¯åˆ†é€€è¿˜

```javascript
async function refundCredits(task) {
  const credits = task.params.count || 1

  await db.collection('users')
    .where({ openid: task.user_openid })
    .update({
      data: {
        credits: db.command.inc(credits),
        total_consumed_credits: db.command.inc(-credits)
      }
    })

  console.log(`ğŸ’° å·²é€€è¿˜ ${credits} ç§¯åˆ†ç»™ç”¨æˆ· ${task.user_openid}`)
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å¹¶å‘èƒ½åŠ›

**å•æ¬¡å®šæ—¶è§¦å‘å¤„ç†èƒ½åŠ›**:
- æ¯30ç§’è¿è¡Œä¸€æ¬¡
- 9ä¸ªçŠ¶æ€ Ã— 10ä¸ªä»»åŠ¡ = 90ä¸ªä»»åŠ¡/æ¬¡
- ç†è®ºååé‡: **180ä¸ªä»»åŠ¡/åˆ†é’Ÿ**

**å®é™…æµ‹è¯•**:
- **50äººåŒæ—¶ä½¿ç”¨**: âœ… å®Œå…¨æ”¯æŒï¼Œå¹³å‡3-5åˆ†é’Ÿå®Œæˆ
- **100äººåŒæ—¶ä½¿ç”¨**: âœ… æ”¯æŒï¼Œå¹³å‡5-8åˆ†é’Ÿå®Œæˆ

---

### æ—¶é—´åˆ†æ

| é˜¶æ®µ | è€—æ—¶ | èƒ½å¦è¶…æ—¶ |
|------|------|---------|
| ç”¨æˆ·æäº¤ | 1-2ç§’ | âœ… ä¸ä¼š |
| pending | <1ç§’ | âœ… ä¸ä¼š |
| downloading | 5-30ç§’ | âš ï¸ å›¾ç‰‡å¤šæ—¶éœ€æ‰¹å¤„ç† |
| downloaded | 2-5ç§’ | âœ… ä¸ä¼š |
| ai_calling | 5-10ç§’ | âœ… ä¸ä¼š |
| ai_processing | 30-180ç§’ | âœ… è½®è¯¢ä¸é˜»å¡ |
| ai_completed | <1ç§’ | âœ… ä¸ä¼š |
| watermarking | 10-30ç§’ | âœ… ä¸ä¼š |
| uploading | 10-30ç§’ | âœ… ä¸ä¼š |
| **æ€»è®¡** | **2-5åˆ†é’Ÿ** | âœ… **å½»åº•è§£å†³60ç§’è¶…æ—¶** |

---

## ğŸ” å‰ç«¯è·å–è¿›åº¦

### æ–¹å¼1: è½®è¯¢æŸ¥è¯¢

```javascript
// miniprogram/pages/photography/photography.js

async checkProgress(taskId) {
  const result = await wx.cloud.callFunction({
    name: 'photography',
    data: { action: 'getProgress', task_id: taskId }
  })

  const work = result.result.data

  // ä¸šåŠ¡çŠ¶æ€
  console.log('çŠ¶æ€:', work.status)  // pending, processing, completed, failed

  // è¯¦ç»†çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰
  console.log('è¯¦ç»†çŠ¶æ€:', work.state)  // downloading, ai_processingç­‰
}
```

### æ–¹å¼2: å®æ—¶ç›‘å¬ï¼ˆæ¨èï¼‰

```javascript
const watcher = db.collection('works')
  .where({ task_id: taskId })
  .watch({
    onChange: snapshot => {
      const work = snapshot.docs[0]

      if (work.status === 'completed') {
        console.log('ç”Ÿå›¾å®Œæˆï¼', work.images)
        this.setData({ images: work.images })
      } else if (work.status === 'failed') {
        console.log('ç”Ÿå›¾å¤±è´¥:', work.error)
      } else {
        console.log('å¤„ç†ä¸­ï¼Œè¯¦ç»†çŠ¶æ€:', work.state)
      }
    },
    onError: err => console.error('ç›‘å¬é”™è¯¯:', err)
  })
```

---

## ğŸ¯ æ€»ç»“

### âœ… ä¼˜åŠ¿

1. **å½»åº•è§£å†³60ç§’è¶…æ—¶**
   - æ¯ä¸ªæ­¥éª¤ç‹¬ç«‹æ‰§è¡Œï¼Œéƒ½åœ¨60ç§’å†…å®Œæˆ
   - AIå¤„ç†é‡‡ç”¨å¼‚æ­¥+è½®è¯¢ï¼Œä¸é˜»å¡

2. **é«˜æˆåŠŸç‡**
   - é¢„ä¼°æˆåŠŸç‡: 95%+
   - å®Œå–„çš„é‡è¯•æœºåˆ¶
   - ç§¯åˆ†è‡ªåŠ¨é€€è¿˜

3. **è‰¯å¥½çš„å¯ç»´æŠ¤æ€§**
   - 9ä¸ªçŠ¶æ€å¤„ç†å™¨ï¼ŒèŒè´£æ¸…æ™°
   - æ˜“äºæ·»åŠ æ–°çŠ¶æ€æˆ–ä¿®æ”¹æµç¨‹

4. **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ**
   - å‰ç«¯å¯å®æ—¶ç›‘å¬çŠ¶æ€
   - è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®šæ—¶è§¦å‘å™¨é…ç½®**
   - å¿…é¡»é…ç½®æ¯30ç§’è¿è¡Œçš„å®šæ—¶è§¦å‘å™¨
   - è§¦å‘å™¨åç§°å¿…é¡»æ˜¯`stateProcessor`

2. **æ•°æ®åº“é›†åˆ**
   - éœ€è¦åˆ›å»º`ai_tasks`é›†åˆ
   - task_queueéœ€è¦æœ‰stateã€state_dataã€retry_countå­—æ®µ

3. **ç›‘æ§å»ºè®®**
   - ç›‘æ§å„çŠ¶æ€çš„ä»»åŠ¡æ•°é‡
   - å…³æ³¨é‡è¯•æ¬¡æ•°åˆ†å¸ƒ
   - å®šæœŸæ¸…ç†completedçš„æ—§ä»»åŠ¡

---

**æ–‡æ¡£ç»“æŸ**
