# AI摄影师小程序 - 云函数架构设计和部署指南

## 概述

本文档详细描述了AI摄影师微信小程序的云函数架构设计和完整部署方案。该架构基于微信云开发，采用模块化设计，支持高并发和可扩展性。

## 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    微信小程序前端层                          │
├─────────────────────────────────────────────────────────────┤
│                    微信云开发平台                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │
│  │   云函数层   │  │   云数据库   │  │     云存储服务       │   │
│  └─────────────┘  └─────────────┘  └─────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                    外部AI服务层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │
│  │  图像生成API │  │  消息推送   │  │     微信支付API      │   │
│  └─────────────┘  └─────────────┘  └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 云函数列表

### 1. 核心业务函数

#### api (统一API入口)
- **功能**: 作品管理、用户数据查询
- **主要接口**:
  - `listWorks`: 分页获取作品列表
  - `getWorkDetail`: 获取作品详情
  - `deleteWork`: 删除作品
  - `toggleFavorite`: 切换收藏状态
  - `cancelTask`: 取消生成任务

#### user (用户管理)
- **功能**: 用户注册、登录、信息管理
- **主要接口**:
  - `register`: 用户注册
  - `getUserInfo`: 获取用户信息
  - `updateUserInfo`: 更新用户信息

#### photography (服装摄影)
- **功能**: AI服装摄影生成
- **主要接口**:
  - `generate`: 生成服装摄影作品
  - `getProgress`: 查询生成进度

#### fitting (虚拟试衣)
- **功能**: AI虚拟试衣生成
- **主要接口**:
  - `generate`: 生成试衣效果

#### payment (支付系统)
- **功能**: 积分充值、订单管理
- **主要接口**:
  - `getPackages`: 获取充值套餐
  - `createOrder`: 创建充值订单
  - `dailyCheckin`: 每日签到
  - `listRechargeRecords`: 充值记录
  - `listConsumeRecords`: 消费记录

### 2. 辅助服务函数

#### scene (场景管理)
- **功能**: 拍摄场景数据管理
- **主要接口**:
  - `getScenes`: 获取场景列表

#### prompt (提示词管理)
- **功能**: AI提示词模板管理
- **主要接口**:
  - `generatePrompt`: 生成AI提示词

#### storage (文件管理)
- **功能**: 云存储文件管理和查重
- **主要接口**:
  - `resolveAsset`: 文件查重
  - `registerAsset`: 文件登记

#### queue (任务队列)
- **功能**: 异步任务处理
- **主要接口**:
  - `addTask`: 添加任务
  - `processTask`: 处理任务

#### notify (消息通知)
- **功能**: 消息推送服务
- **主要接口**:
  - `sendMessage`: 发送通知消息

## 数据库设计

### 核心集合

#### users (用户表)
```javascript
{
  _id: ObjectId,
  openid: String,           // 微信用户唯一标识
  nickname: String,         // 用户昵称
  avatar_url: String,       // 头像URL
  credits: Number,          // 积分余额
  invite_code: String,      // 邀请码
  created_at: Date,         // 创建时间
  updated_at: Date          // 更新时间
}
```

#### works (作品表)
```javascript
{
  _id: ObjectId,
  user_openid: String,      // 用户openid
  type: String,             // 类型: "photography" | "fitting"
  status: String,           // 状态: "pending" | "processing" | "completed" | "failed"
  task_id: String,          // 任务ID
  images: Array,            // 生成的图片URLs
  parameters: Object,       // 生成参数
  scene_id: String,         // 场景ID
  is_favorite: Boolean,     // 是否收藏
  created_at: Date          // 创建时间
}
```

#### task_queue (任务队列表)
```javascript
{
  _id: ObjectId,
  user_openid: String,      // 用户openid
  type: String,             // 任务类型
  status: String,           // 状态
  params: Object,           // 任务参数
  result: String,           // 结果
  created_at: Date,         // 创建时间
  updated_at: Date          // 更新时间
}
```

#### scenes (场景表)
```javascript
{
  _id: ObjectId,
  name: String,             // 场景名称
  category: String,         // 分类
  thumbnail_url: String,    // 缩略图URL
  parameters: Object,       // 场景参数
  is_active: Boolean,       // 是否启用
  created_at: Date          // 创建时间
}
```

#### orders (订单表)
```javascript
{
  _id: ObjectId,
  user_openid: String,      // 用户openid
  type: String,             // 订单类型
  amount: Number,           // 金额
  credits: Number,          // 积分数
  status: String,           // 状态
  created_at: Date          // 创建时间
}
```

## 部署指南

### 环境准备

1. **微信开发者工具**
   - 下载并安装最新版微信开发者工具
   - 创建小程序项目并开通云开发

2. **云开发环境配置**
   ```javascript
   // app.js
   wx.cloud.init({
     env: 'your-cloud-env-id',  // 替换为你的云环境ID
     traceUser: true,
   })
   ```

### 云函数部署步骤

#### 1. 创建云函数目录结构
```
cloudfunctions/
├── api/
│   ├── index.js
│   └── package.json
├── user/
│   ├── index.js
│   └── package.json
├── photography/
│   ├── index.js
│   └── package.json
├── fitting/
│   ├── index.js
│   └── package.json
├── payment/
│   ├── index.js
│   └── package.json
├── scene/
│   ├── index.js
│   └── package.json
├── prompt/
│   ├── index.js
│   └── package.json
├── storage/
│   ├── index.js
│   └── package.json
├── queue/
│   ├── index.js
│   └── package.json
└── notify/
    ├── index.js
    └── package.json
```

#### 2. 云函数基础代码模板

**api/index.js** (示例)
```javascript
const cloud = require('wx-server-sdk')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

exports.main = async (event, context) => {
  const { action } = event
  
  try {
    switch (action) {
      case 'listWorks':
        return await listWorks(event)
      case 'getWorkDetail':
        return await getWorkDetail(event)
      case 'deleteWork':
        return await deleteWork(event)
      case 'toggleFavorite':
        return await toggleFavorite(event)
      default:
        return {
          success: false,
          message: '未知操作'
        }
    }
  } catch (error) {
    console.error('API函数执行错误:', error)
    return {
      success: false,
      message: error.message || '服务器错误'
    }
  }
}

async function listWorks(event) {
  const { tab = 'all', pageSize = 12, last_id = null } = event
  const { OPENID } = cloud.getWXContext()
  
  // 构建查询条件
  let query = { user_openid: OPENID }
  
  if (tab === 'photography') query.type = 'photography'
  else if (tab === 'fitting') query.type = 'fitting'
  else if (tab === 'favorite') query.is_favorite = true
  
  if (last_id) {
    query._id = db.command.lt(last_id)
  }
  
  const result = await db.collection('works')
    .where(query)
    .orderBy('_id', 'desc')
    .limit(pageSize)
    .get()
  
  return {
    success: true,
    data: result.data
  }
}
```

#### 3. 依赖包配置

**package.json** (通用模板)
```json
{
  "name": "cloud-function",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3",
    "axios": "^0.24.0",
    "crypto": "^1.0.1"
  }
}
```

### 数据库初始化

#### 1. 创建数据库集合
```javascript
// 在云开发控制台中创建以下集合
// users, works, task_queue, scenes, orders, logs, api_configs, prompt_templates
```

#### 2. 初始化场景数据
```javascript
// scenes 集合初始数据
const initialScenes = [
  {
    name: "户外花园",
    category: "outdoor",
    thumbnail_url: "/images/scenes/garden.jpg",
    parameters: {
      lighting: "natural",
      background: "garden"
    },
    is_active: true,
    created_at: new Date()
  },
  {
    name: "室内工作室",
    category: "indoor",
    thumbnail_url: "/images/scenes/studio.jpg",
    parameters: {
      lighting: "studio",
      background: "white"
    },
    is_active: true,
    created_at: new Date()
  }
]
```

#### 3. 配置数据库权限
```javascript
// 在云开发控制台设置数据库权限
// users: 仅创建者可读写
// works: 仅创建者可读写
// scenes: 所有用户可读，仅管理员可写
// orders: 仅创建者可读写
```

### 外部API配置

#### 1. AI图像生成API配置
```javascript
// api_configs 集合示例数据
{
  provider: "stability-ai",
  api_name: "text-to-image",
  endpoint: "https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image",
  headers: {
    "Authorization": "Bearer YOUR_API_KEY",
    "Content-Type": "application/json"
  },
  default_params: {
    width: 1024,
    height: 1024,
    steps: 30,
    cfg_scale: 7
  },
  priority: 1,
  weight: 10,
  is_active: true
}
```

#### 2. 微信支付配置
```javascript
// 在云函数中配置微信支付参数
const paymentConfig = {
  appId: 'your-app-id',
  mchId: 'your-mch-id',
  key: 'your-api-key',
  certPath: './cert/apiclient_cert.pem',
  keyPath: './cert/apiclient_key.pem'
}
```

### 安全配置

#### 1. 云函数权限控制
```javascript
// 在每个云函数中添加用户身份验证
const { OPENID } = cloud.getWXContext()
if (!OPENID) {
  return {
    success: false,
    message: '用户未登录'
  }
}
```

#### 2. 敏感数据加密
```javascript
const crypto = require('crypto')

// 敏感信息加密存储
function encrypt(text) {
  const cipher = crypto.createCipher('aes192', 'your-secret-key')
  let encrypted = cipher.update(text, 'utf8', 'hex')
  encrypted += cipher.final('hex')
  return encrypted
}
```

### 性能优化

#### 1. 数据库索引配置
```javascript
// 在云开发控制台为以下字段创建索引
// users: openid (唯一索引)
// works: user_openid, type, status, created_at (复合索引)
// task_queue: status, created_at (复合索引)
```

#### 2. 云函数并发优化
```javascript
// 在云函数中使用连接池和缓存
const connectionPool = new Map()

exports.main = async (event, context) => {
  // 复用数据库连接
  let connection = connectionPool.get(context.requestId)
  if (!connection) {
    connection = cloud.database()
    connectionPool.set(context.requestId, connection)
  }
  // ... 业务逻辑
}
```

### 监控和日志

#### 1. 错误监控
```javascript
// 统一错误处理和上报
function handleError(error, context) {
  console.error('函数执行错误:', {
    error: error.message,
    stack: error.stack,
    context
  })
  
  // 可以集成第三方监控服务
  // 如腾讯云监控、阿里云监控等
}
```

#### 2. 性能监控
```javascript
// 函数执行时间监控
const startTime = Date.now()
// ... 业务逻辑
const endTime = Date.now()
console.log('函数执行耗时:', endTime - startTime, 'ms')
```

### 部署清单

#### 部署前检查
- [ ] 云开发环境已创建
- [ ] 云函数代码已完成
- [ ] 数据库集合已创建
- [ ] 索引已配置
- [ ] 外部API已配置
- [ ] 支付配置已完成
- [ ] 权限控制已设置

#### 部署步骤
1. 在微信开发者工具中右键云函数目录
2. 选择"创建并部署云函数"
3. 等待部署完成
4. 在云开发控制台验证函数状态
5. 运行测试用例验证功能

#### 部署后验证
- [ ] 用户注册登录功能正常
- [ ] 图片上传功能正常
- [ ] AI生成功能正常
- [ ] 支付功能正常
- [ ] 消息推送功能正常

### 故障排查

#### 常见问题
1. **云函数调用失败**
   - 检查函数名称是否正确
   - 验证参数格式是否正确
   - 查看云函数日志

2. **数据库操作失败**
   - 检查集合权限设置
   - 验证数据格式
   - 查看数据库操作日志

3. **外部API调用失败**
   - 检查API密钥配置
   - 验证网络连通性
   - 查看API调用日志

#### 日志查看
- 在云开发控制台 -> 云函数 -> 日志查询
- 使用console.log记录关键信息
- 设置不同级别的日志记录

### 维护和更新

#### 版本管理
- 使用Git管理云函数代码
- 为每次更新创建版本标签
- 保留回滚方案

#### 定期维护
- 定期清理过期日志
- 监控函数性能指标
- 更新依赖包版本
- 备份重要数据

## 总结

本云函数架构设计采用微服务模式，具有良好的可扩展性和维护性。通过合理的数据库设计和API设计，能够支持大规模用户访问和高并发场景。部署时请严格按照指南执行，确保系统的稳定性和安全性。