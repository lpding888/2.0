# é«˜å¹¶å‘æ‰©å®¹æ–¹æ¡ˆï¼ˆæ”¯æŒ60+ç”¨æˆ·ï¼‰

## å½“å‰æ¶æ„å®¹é‡

### ç†è®ºä¸Šé™
- âœ… æ¶æ„è®¾è®¡ï¼šæ”¯æŒæ— é™å¹¶å‘ï¼ˆæ¯ç”¨æˆ·ç‹¬ç«‹å®¹å™¨ï¼‰
- âœ… æ•°æ®åº“ï¼šæ”¯æŒå‡ ç™¾å¹¶å‘è¿æ¥

### å®é™…ç“¶é¢ˆ
1. **äº‘å‡½æ•°å¹¶å‘é…é¢**ï¼šé»˜è®¤20-50å®ä¾‹/å‡½æ•°
2. **AI APIé€Ÿç‡é™åˆ¶**ï¼šå…è´¹ç‰ˆ15 RPMï¼Œä»˜è´¹ç‰ˆ360 RPM

---

## æ–¹æ¡ˆ1ï¼šå‡çº§é…é¢ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

### 1.1 å‡çº§äº‘å‡½æ•°é…é¢
**æ“ä½œè·¯å¾„**ï¼šäº‘å¼€å‘æ§åˆ¶å° â†’ ç¯å¢ƒè®¾ç½® â†’ é…é¢ç®¡ç†

**é…ç½®é¡¹**ï¼š
```
photography-worker:
  - å¹¶å‘å®ä¾‹æ•°ï¼š100ï¼ˆä»é»˜è®¤20æå‡ï¼‰
  - å†…å­˜ï¼š256MBï¼ˆä¿æŒï¼‰
  - è¶…æ—¶æ—¶é—´ï¼š60sï¼ˆä¿æŒï¼‰

fitting-worker:
  - å¹¶å‘å®ä¾‹æ•°ï¼š100ï¼ˆä»é»˜è®¤20æå‡ï¼‰
  - å†…å­˜ï¼š256MBï¼ˆä¿æŒï¼‰
  - è¶…æ—¶æ—¶é—´ï¼š60sï¼ˆä¿æŒï¼‰
```

**æˆæœ¬**ï¼šçº¦ Â¥0.000110/GBÂ·ç§’ï¼ˆæŒ‰å®é™…ä½¿ç”¨è®¡è´¹ï¼‰

**æ•ˆæœ**ï¼š
- æ”¯æŒ100ä¸ªç”¨æˆ·åŒæ—¶ç”Ÿæˆ
- è¶…å‡º100ä¼šæ’é˜Ÿç­‰å¾…

---

### 1.2 å‡çº§AI APIé…é¢
**Gemini APIä»˜è´¹ç‰ˆ**ï¼š
- 360 RPMï¼ˆæ”¯æŒ60å¹¶å‘ï¼‰
- $7/æœˆ æˆ–æŒ‰é‡è®¡è´¹

**æˆ–ä½¿ç”¨å¤šä¸ªAPIå¯†é’¥è½®è¯¢**ï¼š
```javascript
// cloudfunctions/photography-worker/modules/aiCaller.js
// æ·»åŠ APIå¯†é’¥æ± 
const API_KEYS = [
  process.env.GEMINI_API_KEY_1,
  process.env.GEMINI_API_KEY_2,
  process.env.GEMINI_API_KEY_3,
  // 3ä¸ªå…è´¹APIå¯†é’¥ = 45 RPM
]

// è½®è¯¢é€‰æ‹©
const key = API_KEYS[Math.floor(Math.random() * API_KEYS.length)]
```

**æ•ˆæœ**ï¼š
- 3ä¸ªå…è´¹å¯†é’¥ = 45 RPMï¼ˆæ”¯æŒ45å¹¶å‘ï¼‰
- 10ä¸ªå…è´¹å¯†é’¥ = 150 RPMï¼ˆæ”¯æŒ150å¹¶å‘ï¼‰

---

## æ–¹æ¡ˆ2ï¼šä»»åŠ¡é˜Ÿåˆ— + é™æµï¼ˆæ¨èï¼Œæ›´ç¨³å®šï¼‰

### æ¶æ„æ”¹é€ 

#### å½“å‰æµç¨‹ï¼ˆå¯èƒ½å¤±è´¥ï¼‰ï¼š
```
60ä¸ªç”¨æˆ·åŒæ—¶ç‚¹å‡» â†’ 60ä¸ªworkeråŒæ—¶å¯åŠ¨ â†’ éƒ¨åˆ†å¤±è´¥
```

#### æ”¹é€ åæµç¨‹ï¼ˆæ’é˜Ÿå¤„ç†ï¼‰ï¼š
```
60ä¸ªç”¨æˆ·åŒæ—¶ç‚¹å‡» â†’ å…¨éƒ¨ç«‹å³è¿”å›task_id âœ…
  â†“
ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
  â†“
é˜Ÿåˆ—å¤„ç†å™¨ï¼ˆé™åˆ¶åŒæ—¶å¤„ç†æ•°=20ï¼‰
  â†“ å¯åŠ¨20ä¸ªworker
  â†“ å®Œæˆåç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹20ä¸ª
  â†“ æ‰€æœ‰ä»»åŠ¡æœ€ç»ˆéƒ½ä¼šå®Œæˆ âœ…
```

### å®ç°æ­¥éª¤

#### 2.1 ä¿æŒç°æœ‰å…¥å£ï¼ˆå·²å®Œæˆï¼‰
```javascript
// cloudfunctions/photography/index.js
// ä¸éœ€è¦ä¿®æ”¹ï¼Œç”¨æˆ·ç«‹å³æ”¶åˆ°task_id
return {
  success: true,
  data: { task_id: taskId },
  message: 'ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨æ’é˜Ÿå¤„ç†...'
}
```

#### 2.2 åˆ›å»ºé˜Ÿåˆ—å¤„ç†å™¨
**æ–°å»ºäº‘å‡½æ•°**ï¼š`cloudfunctions/queue-manager/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

// é…ç½®ï¼šåŒæ—¶å¤„ç†çš„æœ€å¤§ä»»åŠ¡æ•°
const MAX_CONCURRENT_TASKS = 20

exports.main = async (event, context) => {
  console.log('ğŸ”„ é˜Ÿåˆ—ç®¡ç†å™¨å¯åŠ¨')

  // 1. æŸ¥è¯¢pendingçŠ¶æ€çš„ä»»åŠ¡ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰
  const pendingTasks = await db.collection('task_queue')
    .where({
      status: 'pending',
      state: 'pending'
    })
    .orderBy('created_at', 'asc')
    .limit(100)
    .get()

  console.log(`ğŸ“Š é˜Ÿåˆ—ä¸­ä»»åŠ¡æ•°: ${pendingTasks.data.length}`)

  // 2. æŸ¥è¯¢å½“å‰æ­£åœ¨å¤„ç†çš„ä»»åŠ¡æ•°
  const processingTasks = await db.collection('task_queue')
    .where({
      status: 'processing'
    })
    .count()

  const currentProcessing = processingTasks.total
  const availableSlots = MAX_CONCURRENT_TASKS - currentProcessing

  console.log(`ğŸ° å½“å‰å¤„ç†ä¸­: ${currentProcessing}, å¯ç”¨æ§½ä½: ${availableSlots}`)

  if (availableSlots <= 0) {
    console.log('â¸ï¸ å·²è¾¾åˆ°å¹¶å‘ä¸Šé™ï¼Œç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œ')
    return { message: 'Queue full, waiting...' }
  }

  // 3. å¯åŠ¨å¯ç”¨æ•°é‡çš„ä»»åŠ¡
  const tasksToStart = pendingTasks.data.slice(0, availableSlots)

  for (const task of tasksToStart) {
    try {
      // æ›´æ–°ä¸ºprocessingçŠ¶æ€
      await db.collection('task_queue')
        .doc(task._id)
        .update({
          data: {
            status: 'processing',
            state: 'ai_calling',
            updated_at: new Date()
          }
        })

      // å¯åŠ¨å¯¹åº”çš„worker
      const workerName = task.type === 'photography' ? 'photography-worker' : 'fitting-worker'

      await cloud.callFunction({
        name: workerName,
        data: {
          taskId: task._id,
          originalEvent: task.params,
          wxContext: { OPENID: task.user_openid }
        }
      })

      console.log(`âœ… å·²å¯åŠ¨ä»»åŠ¡: ${task._id} (${workerName})`)

    } catch (error) {
      console.error(`âŒ å¯åŠ¨ä»»åŠ¡å¤±è´¥: ${task._id}`, error)

      // æ ‡è®°å¤±è´¥å¹¶é€€è¿˜ç§¯åˆ†
      await db.collection('task_queue')
        .doc(task._id)
        .update({
          data: {
            status: 'failed',
            error: error.message,
            updated_at: new Date()
          }
        })
    }
  }

  return {
    success: true,
    started: tasksToStart.length,
    remaining: pendingTasks.data.length - tasksToStart.length
  }
}
```

#### 2.3 å®šæ—¶è§¦å‘é˜Ÿåˆ—å¤„ç†å™¨
**é…ç½®å®šæ—¶è§¦å‘å™¨**ï¼š
- äº‘å¼€å‘æ§åˆ¶å° â†’ queue-manager â†’ è§¦å‘å™¨
- ç±»å‹ï¼šå®šæ—¶è§¦å‘å™¨
- Cronè¡¨è¾¾å¼ï¼š`0/30 * * * * * *`ï¼ˆæ¯30ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰

**æˆ–ä½¿ç”¨äº‘å‡½æ•°äº’ç›¸è°ƒç”¨**ï¼š
```javascript
// cloudfunctions/photography-worker/index.js
// åœ¨ä»»åŠ¡å®Œæˆåè§¦å‘é˜Ÿåˆ—å¤„ç†å™¨
await cloud.callFunction({
  name: 'queue-manager',
  data: {}
})
```

#### 2.4 ä¿®æ”¹photography.generate()ï¼ˆå¯é€‰ï¼‰
å¦‚æœæƒ³ç›´æ¥ä½¿ç”¨é˜Ÿåˆ—ï¼Œä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œå› ä¸ºï¼š
- ä»»åŠ¡å·²ç»åˆ›å»ºåˆ°task_queue
- queue-managerä¼šè‡ªåŠ¨å¤„ç†pendingä»»åŠ¡
- ç”¨æˆ·ä½“éªŒä¸å˜ï¼ˆç«‹å³æ”¶åˆ°task_idï¼Œè½®è¯¢è¿›åº¦ï¼‰

---

## æ–¹æ¡ˆ3ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

### é…ç½®
1. å‡çº§äº‘å‡½æ•°é…é¢åˆ°50å¹¶å‘
2. é…ç½®é˜Ÿåˆ—ç®¡ç†å™¨ï¼ˆMAX_CONCURRENT_TASKS = 40ï¼‰
3. ä½¿ç”¨3ä¸ªAI APIå¯†é’¥è½®è¯¢

### æ•ˆæœ
```
0-40ç”¨æˆ·: ç«‹å³å¤„ç† âœ…ï¼ˆ40å¹¶å‘æ§½ä½ï¼‰
41-60ç”¨æˆ·: æ’é˜Ÿ30ç§’å†…å¯åŠ¨ â³ï¼ˆé˜Ÿåˆ—è‡ªåŠ¨å¤„ç†ï¼‰
60+ç”¨æˆ·: æ’é˜Ÿ1-2åˆ†é’Ÿå¯åŠ¨ â³ï¼ˆç­‰å¾…å‰é¢ä»»åŠ¡å®Œæˆï¼‰
```

### ç”¨æˆ·ä½“éªŒ
- âœ… æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½ç«‹å³æäº¤ï¼ˆç§’çº§å“åº”ï¼‰
- âœ… å‰40äººå‡ ä¹ç«‹å³å¼€å§‹ç”Ÿæˆ
- âœ… å20äººç­‰å¾…30ç§’-1åˆ†é’Ÿ
- âœ… æ²¡æœ‰"è¯·æ±‚å¤±è´¥"é”™è¯¯
- âœ… å‰ç«¯è¿›åº¦æ¡æ˜¾ç¤º"æ’é˜Ÿä¸­..."

---

## æ¨èå®æ–½é¡ºåº

### é˜¶æ®µ1ï¼šå¿«é€ŸéªŒè¯ï¼ˆæ— éœ€ä¿®æ”¹ä»£ç ï¼‰
1. æµ‹è¯•å½“å‰æ¶æ„çš„å®é™…å¹¶å‘èƒ½åŠ›
2. æ¨¡æ‹Ÿ10-20ä¸ªå¹¶å‘ç”¨æˆ·
3. è§‚å¯Ÿæ˜¯å¦æœ‰å¤±è´¥

### é˜¶æ®µ2ï¼šå‡çº§é…é¢ï¼ˆ1å°æ—¶ï¼‰
1. äº‘å¼€å‘æ§åˆ¶å°æå‡å¹¶å‘é…é¢åˆ°50-100
2. é…ç½®å¤šä¸ªAI APIå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. é‡æ–°æµ‹è¯•å¹¶å‘èƒ½åŠ›

### é˜¶æ®µ3ï¼šé˜Ÿåˆ—ç®¡ç†å™¨ï¼ˆ2-3å°æ—¶ï¼‰
å¦‚æœé˜¶æ®µ2ä»ä¸å¤Ÿï¼š
1. åˆ›å»ºqueue-manageräº‘å‡½æ•°
2. é…ç½®å®šæ—¶è§¦å‘å™¨
3. æµ‹è¯•æ’é˜Ÿé€»è¾‘

---

## æˆæœ¬ä¼°ç®—

### 60äººåŒæ—¶ä½¿ç”¨ï¼Œæ¯å¤©è¿è¡Œ1æ¬¡

**äº‘å‡½æ•°è´¹ç”¨**ï¼š
```
60æ¬¡ Ã— 60ç§’ Ã— 256MB = 921,600 MBÂ·ç§’
921,600 Ã— 0.000110å…ƒ/GBÂ·ç§’ Ã· 1024 = Â¥0.99/å¤©
```

**AI APIè´¹ç”¨**ï¼ˆGeminiå…è´¹ç‰ˆï¼‰ï¼š
```
60æ¬¡ç”Ÿæˆ/å¤© < 1500æ¬¡/å¤© = å…è´¹ âœ…
```

**æ€»æˆæœ¬**ï¼šçº¦ Â¥30/æœˆ

### å¦‚æœä½¿ç”¨ä»˜è´¹AI API
```
Gemini Pro: $0.005/æ¬¡
60æ¬¡/å¤© Ã— 30å¤© = 1800æ¬¡
1800 Ã— $0.005 = $9/æœˆï¼ˆçº¦Â¥65ï¼‰
```

---

## ç›‘æ§å’Œå‘Šè­¦

### å…³é”®æŒ‡æ ‡
1. äº‘å‡½æ•°å¹¶å‘å®ä¾‹æ•°
2. AI APIé”™è¯¯ç‡ï¼ˆ429é”™è¯¯ï¼‰
3. task_queue pendingä»»åŠ¡æ•°é‡
4. å¹³å‡ä»»åŠ¡å®Œæˆæ—¶é—´

### å‘Šè­¦è§„åˆ™
```
IF pending_tasks > 50: å‘é€å‘Šè­¦ï¼ˆé˜Ÿåˆ—ç§¯å‹ï¼‰
IF error_rate > 10%: å‘é€å‘Šè­¦ï¼ˆAPIé™æµï¼‰
IF processing_time > 180s: å‘é€å‘Šè­¦ï¼ˆå¤„ç†è¶…æ—¶ï¼‰
```

---

## æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… æ¶æ„æ”¯æŒï¼šæ— é™å¹¶å‘ï¼ˆç†è®ºä¸Šï¼‰
- âš ï¸ é…é¢é™åˆ¶ï¼š20-50å¹¶å‘ï¼ˆå®é™…ï¼‰

### å¿«é€Ÿæ–¹æ¡ˆï¼ˆæ”¯æŒ60äººï¼‰
1. **ç«‹å³å¯åš**ï¼šå‡çº§äº‘å‡½æ•°é…é¢åˆ°100ï¼ˆäº‘å¼€å‘æ§åˆ¶å°æ“ä½œï¼‰
2. **15åˆ†é’Ÿ**ï¼šé…ç½®3ä¸ªAI APIå¯†é’¥è½®è¯¢ï¼ˆç¯å¢ƒå˜é‡ï¼‰
3. **é¢„æœŸæ•ˆæœ**ï¼šæ”¯æŒ60äººå¹¶å‘ï¼Œæˆæœ¬çº¦Â¥30/æœˆ

### ç¨³å®šæ–¹æ¡ˆï¼ˆæ”¯æŒ100+äººï¼‰
1. **2-3å°æ—¶**ï¼šå®ç°queue-manager + å®šæ—¶è§¦å‘å™¨
2. **é¢„æœŸæ•ˆæœ**ï¼šæ”¯æŒæ— é™æ’é˜Ÿï¼Œæ‰€æœ‰ä»»åŠ¡æœ€ç»ˆå®Œæˆ
3. **ç”¨æˆ·ä½“éªŒ**ï¼šå‰40äººç«‹å³å¤„ç†ï¼Œå…¶ä»–æ’é˜Ÿï¼ˆæ˜¾ç¤ºè¿›åº¦ï¼‰

éœ€è¦æˆ‘å¸®ä½ å®ç°å“ªä¸ªæ–¹æ¡ˆï¼Ÿ
