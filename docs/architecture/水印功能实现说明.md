# 水印功能实现说明

## 实现方案

使用**小程序前端Canvas**添加水印（官方推荐方案）

### 为什么不用 imageMogr2？

1. imageMogr2 需要开通**腾讯云数据万象CI服务**（付费服务）
2. 需要配置图片处理样式
3. 仅支持按量计费环境

### 为什么不在云函数中添加水印？

1. 需要安装 `canvas` npm包（体积较大）
2. 云函数执行时间更长
3. 增加云存储容量消耗

### 前端Canvas方案优势

✅ 无需额外付费服务
✅ 灵活控制水印样式
✅ 不增加云函数负担
✅ 不占用云存储空间
✅ 实时生成，即时显示

---

## 实现细节

### 1. 水印工具类

**文件**: `miniprogram/utils/watermark.js`

**功能**:
- 使用小程序原生 `wx.createOffscreenCanvas` API
- 支持自定义水印文字、字体大小、颜色、位置、透明度
- 支持批量处理

**核心代码**:
```javascript
const canvas = wx.createOffscreenCanvas({ type: '2d', width, height })
const ctx = canvas.getContext('2d')

// 绘制原图
ctx.drawImage(img, 0, 0, width, height)

// 添加水印文字
ctx.setFontSize(32)
ctx.setFillStyle('rgba(255,255,255,0.8)')
ctx.fillText('AI Generated', x, y)

// 导出为临时文件
wx.canvasToTempFilePath({ canvas })
```

---

### 2. 作品详情页集成

**文件**: `miniprogram/pages/work-detail/work-detail.js`

**逻辑**:
1. 用户点击作品查看详情
2. `downloadImageToTemp()` 下载图片到临时路径
3. 检测是否为AI生成图片（URL包含 `/photography/` 或 `/fitting/`）
4. 如果是，调用 `WatermarkUtil.addTextWatermark()` 添加水印
5. 返回带水印的临时文件路径
6. 显示在页面上

**关键代码**:
```javascript
// 如果是AI生成的图片，添加水印
const isAIGenerated = imageUrl.includes('/photography/') || imageUrl.includes('/fitting/')
if (isAIGenerated) {
  const watermarkedPath = await WatermarkUtil.addTextWatermark(tempFilePath, {
    text: 'AI Generated',
    fontSize: 32,
    position: 'bottom-right'
  })
  return watermarkedPath
}
```

---

### 3. 缩略图不添加水印

**原因**:
- 缩略图很小，水印不清晰
- 批量添加水印会影响列表加载性能
- 用户查看详情时再添加水印即可

**文件**: `miniprogram/pages/works/works.js`

已移除 imageMogr2 水印代码。

---

## 水印配置

### 默认配置

```javascript
{
  text: 'AI Generated',       // 水印文字
  fontSize: 32,                // 字体大小
  color: 'rgba(255,255,255,0.8)', // 白色半透明
  position: 'bottom-right',    // 右下角
  padding: 20                  // 边距 20px
}
```

### 支持的位置

- `top-left` - 左上角
- `top-right` - 右上角
- `bottom-left` - 左下角
- `bottom-right` - 右下角（默认）
- `center` - 居中

---

## 测试步骤

1. 编译并运行小程序
2. 生成一张AI摄影作品
3. 在作品列表点击查看详情
4. **检查大图右下角是否有 "AI Generated" 水印**

---

## 常见问题

### Q: 水印模糊？
A: 可以调整 `fontSize`（增大字号）或 `strokeWidth`（增加描边）

### Q: 水印颜色不明显？
A: 修改 `color` 为深色（如黑色）：`'rgba(0,0,0,0.8)'`

### Q: 想更改水印文字？
A: 修改 `work-detail.js:98` 的 `text` 参数

### Q: 能否在缩略图也显示水印？
A: 可以，但会影响列表加载性能。需要在 `works.js` 的图片处理逻辑中集成

---

## 性能优化

1. ✅ **离屏Canvas**: 使用 `wx.createOffscreenCanvas`，不需要在wxml中定义
2. ✅ **懒加载**: 只在用户查看详情时添加水印
3. ✅ **错误降级**: 水印失败时返回原图，不影响用户查看
4. ✅ **缓存**: 临时文件路径可以复用，减少重复处理

---

## 未来扩展

1. **批量下载带水印**: 用户下载多张图片时批量添加水印
2. **自定义水印**: 允许用户设置个人专属水印
3. **水印模板**: 提供多种水印样式供用户选择
4. **图片水印**: 支持添加Logo图片水印
