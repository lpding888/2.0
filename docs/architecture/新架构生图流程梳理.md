# 新架构生图流程梳理

## 🎯 改造后的流程

### 完整调用链

```
┌─────────────────────────────────────────────────────────────────┐
│  步骤1: 小程序前端                                                   │
│  - 用户提交生图任务                                                  │
│  - wx.cloud.callFunction('photography', { action: 'generate' })  │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  步骤2: photography 云函数 (60秒超时)                               │
│  - 验证用户积分                                                      │
│  - 扣除积分                                                         │
│  - 创建 task_queue (status='pending', _id=taskId)                │
│  - 创建 works (status='pending', task_id=taskId)                 │
│  - 立即返回 { task_id, work_id }                                  │
│  ⏱️ 耗时: ~1-2秒                                                   │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  步骤3: 数据库触发器 (自动触发，0延迟)                                 │
│  - 监听 task_queue 集合的创建事件                                   │
│  - 触发 task-processor 云函数                                      │
│  - 传递参数: { docId, doc, eventType: 'create' }                 │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  步骤4: task-processor 云函数 (60秒超时) ❌ 关键节点                  │
│  - 判断触发类型                                                     │
│  - 检查任务状态 (只处理 pending)                                     │
│  - 生成提示词 (调用 prompt 云函数)                                   │
│  - ⚠️ await cloud.callFunction('aimodels', ...)                  │
│    └─> 🚨 这里会同步等待 aimodels 完成！                             │
│  - 如果超过60秒，云函数超时 ❌                                        │
│  ⏱️ 耗时: 取决于 aimodels 执行时间                                   │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  步骤5: aimodels 云函数 (60秒超时) ❌ 关键节点                        │
│  - action: 'generateFromFileIds'                                │
│  - 执行 WorkflowOrchestrator.executeGenerationWorkflow()        │
│                                                                   │
│  子步骤:                                                           │
│  ├─> 5.1: 更新状态 → 'processing'                                 │
│  ├─> 5.2: 下载并处理输入图片 (~5-10秒)                              │
│  ├─> 5.3: 选择 AI 模型 (~1秒)                                     │
│  ├─> 5.4: 更新状态 → 'ai_processing'                              │
│  ├─> 5.5: ⚠️ await generateAIImages()                            │
│  │        └─> await callExternalAI()                            │
│  │            └─> 🚨 调用外部 AI 服务 (30-120秒)                   │
│  │                └─> ❌ 如果超过60秒，整个链路超时！                 │
│  ├─> 5.6: 添加水印 (~5秒)                                         │
│  ├─> 5.7: 上传到云存储 (~5-10秒)                                   │
│  ├─> 5.8: 更新数据库                                              │
│  │        - works.status = 'completed'                          │
│  │        - works.images = [...]                                │
│  │        - task_queue.status = 'completed'                     │
│  └─> 返回 { success: true, data: {...} }                         │
│                                                                   │
│  ⏱️ 耗时: 40-150秒 (取决于 AI 服务)                                │
│  🚨 风险: 如果 > 60秒，会触发云函数超时                               │
└─────────────────────────────────────────────────────────────────┘
                            ↓
                       超时后 ↓
┌─────────────────────────────────────────────────────────────────┐
│  步骤6: 定时触发器兜底 (每3分钟运行)                                  │
│  - taskCleanup 触发器                                             │
│  - 查找 status='pending' 或 'processing' 且 > 10分钟的任务          │
│  - 重新提交到 aimodels                                             │
│  - ⏱️ 延迟: 最多10分钟                                             │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  步骤7: 前端获取结果                                                 │
│  - 方式1: 轮询 photography.getProgress()                          │
│  - 方式2: 实时监听 watch(works)                                    │
│  - 获取 status='completed' 的作品                                  │
│  - 显示生成的图片                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🚨 核心问题

### 问题: 60秒超时仍然存在

**问题链**:
```
task-processor (60s)
   └─> await aimodels (60s)
         └─> await AI服务 (30-120s)
               └─> ❌ 超时！
```

**原因**:
1. `task-processor` 使用 `await cloud.callFunction()` **同步等待**
2. `aimodels` 中的工作流是**完全同步**执行
3. 没有实现真正的**异步后台任务**

**证据**:
```javascript
// task-processor/index.js:76
const result = await cloud.callFunction({  // ❌ 阻塞等待
  name: 'aimodels',
  data: { ... }
})

// workflowOrchestrator.js:52
const aiResult = await this.generateAIImages({ ... })  // ❌ 阻塞等待

// aiCaller.js:22
const aiResult = await this.callExternalAI(modelConfig, params)  // ❌ 阻塞等待
```

---

## 📊 时间分析

### 各步骤耗时估算

| 步骤 | 操作 | 耗时 | 是否可能超时 |
|------|------|------|-------------|
| 1 | 前端提交 | ~100ms | ✅ 不会 |
| 2 | photography 云函数 | ~1-2s | ✅ 不会 |
| 3 | 数据库触发器 | ~0ms | ✅ 不会 |
| 4 | task-processor | 取决于步骤5 | ⚠️ 可能 |
| 5.1-5.2 | 下载处理图片 | ~5-10s | ✅ 不会 |
| 5.3-5.4 | 选择模型 | ~1s | ✅ 不会 |
| **5.5** | **AI 生成** | **30-120s** | **❌ 高风险** |
| 5.6 | 添加水印 | ~5s | ✅ 不会 |
| 5.7 | 上传云存储 | ~5-10s | ✅ 不会 |
| 5.8 | 更新数据库 | ~1s | ✅ 不会 |

**总耗时**: 47-149秒

**超时风险**:
- AI 服务 < 40秒: ✅ 不会超时 (总耗时 < 60秒)
- AI 服务 40-60秒: ⚠️ 可能超时 (边缘情况)
- AI 服务 > 60秒: ❌ 必然超时

---

## 🔄 实际运行场景

### 场景1: AI 服务快速响应 (< 40秒)

```
用户提交
   ↓ (2秒)
task_queue created
   ↓ (立即)
task-processor 触发
   ↓ (50秒, AI 40秒)
aimodels 完成
   ↓
works.status = 'completed'
   ↓
用户看到结果 ✅
```

**结果**: ✅ **成功**
**总耗时**: ~50秒
**用户体验**: 良好

---

### 场景2: AI 服务中速响应 (40-60秒)

```
用户提交
   ↓ (2秒)
task_queue created
   ↓ (立即)
task-processor 触发
   ↓ (60秒)
⏰ task-processor 超时！
   - aimodels 可能还在运行
   - task_queue.status = 'processing'
   ↓ (等待3分钟)
定时触发器运行
   ↓
查找卡住的任务
   ↓
重新提交到 aimodels
   ↓ (50秒)
aimodels 完成
   ↓
works.status = 'completed'
```

**结果**: ⚠️ **最终成功，但延迟高**
**总耗时**: ~3-4分钟
**用户体验**: 较差

---

### 场景3: AI 服务慢速响应 (> 60秒)

```
用户提交
   ↓ (2秒)
task_queue created
   ↓ (立即)
task-processor 触发
   ↓ (60秒)
⏰ task-processor 超时！
   - aimodels 超时
   - task_queue.status = 'pending' 或 'processing'
   ↓ (等待3分钟)
定时触发器运行
   ↓
重新提交到 aimodels
   ↓ (60秒)
⏰ 再次超时！
   ↓ (等待3分钟)
定时触发器再次运行
   ↓
可能需要多次重试...
```

**结果**: ❌ **可能失败，或延迟极高**
**总耗时**: 6-15分钟
**用户体验**: 很差

---

## 📈 成功率预估

假设 AI 服务响应时间分布：

| AI 响应时间 | 概率 | 是否成功 | 延迟 |
|-----------|------|---------|------|
| < 40秒 | 60% | ✅ 成功 | 正常 |
| 40-60秒 | 25% | ⚠️ 延迟成功 | 3-4分钟 |
| > 60秒 | 15% | ❌ 可能失败 | 6-15分钟 |

**预估指标**:
- **首次成功率**: 60%
- **最终成功率**: 85% (经过重试)
- **平均延迟**: ~2分钟
- **用户满意度**: 中等

---

## ✅ 架构优势

尽管存在超时问题，新架构仍有以下优势：

1. **前端不阻塞** ✅
   - photography 云函数立即返回
   - 用户不需要等待

2. **自动重试** ✅
   - 定时触发器提供兜底
   - 卡住的任务会自动重试

3. **代码清晰** ✅
   - 职责分离
   - 易于维护

4. **监控友好** ✅
   - 状态流转清晰
   - 易于追踪问题

---

## ⚠️ 架构劣势

1. **仍然受60秒限制** ❌
   - 核心问题未解决
   - 慢速 AI 服务会超时

2. **依赖重试机制** ❌
   - 延迟高
   - 用户体验差

3. **资源浪费** ❌
   - 超时后的云函数调用浪费
   - 可能产生额外费用

---

## 🎯 结论

### 当前架构能否保证生图功能可用？

**✅ 短期可用**:
- 如果大部分 AI 请求能在 40 秒内完成
- 可以依赖定时触发器兜底
- 功能基本可用

**⚠️ 长期有风险**:
- AI 服务响应慢时，用户体验差
- 可能需要多次重试
- 成功率和延迟都不理想

### 建议

**立即部署测试**:
1. 先部署当前方案
2. 观察实际 AI 响应时间
3. 统计超时率和重试次数

**根据测试结果决定**:
- 超时率 < 5%: 当前方案可接受
- 超时率 5-10%: 需要优化（调整重试频率）
- 超时率 > 10%: 需要重新设计架构

**紧急优化措施**:
1. 缩短定时触发器间隔（改为每分钟）
2. 缩短重试判断时间（改为5分钟）
3. 选择更快的 AI 服务提供商

**长期解决方案**:
1. 实现 webhook 回调机制
2. 考虑迁移到腾讯云 SCF（900秒超时）
3. 实现状态机模式
