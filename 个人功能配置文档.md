# 个人功能配置文档

## 一、数据库集合配置

### 1. users 集合（已有，需确认字段）

**用途**：存储用户信息和积分
**权限**：仅用户本人可读写

**必需字段**：
```javascript
{
  "_id": "自动生成",
  "openid": "用户OpenID",
  "credits": 10,              // 用户积分余额
  "create_time": Date,        // 创建时间
  "last_login_time": Date     // 最后登录时间
}
```

### 2. works 集合（已有，需支持新类型）

**用途**：存储所有作品记录
**权限**：仅用户本人可读写

**必需字段**（针对个人功能）：
```javascript
{
  "_id": "自动生成",
  "user_openid": "用户OpenID",
  "type": "fitting-personal 或 travel",  // 作品类型
  "status": "processing/completed/failed", // 作品状态
  "task_id": "关联的任务ID",

  // 个人试衣专用字段
  "user_photo": {
    "fileId": "云存储文件ID",
    "url": "临时访问URL"
  },
  "body_params": {
    "height": "身高",
    "weight": "体重",
    "skin_tone": "肤色"
  },
  "clothing_images": [
    {
      "fileId": "服装图片云存储ID",
      "url": "临时访问URL"
    }
  ],
  "clothing_description": "服装描述",

  // 全球旅行专用字段
  "destination": {
    "id": "目的地ID",
    "name": "目的地名称",
    "country": "国家",
    "prompt": "场景提示词"
  },
  "custom_description": "自定义描述",

  // 通用结果字段
  "result": {
    "images": [
      {
        "fileId": "结果图片云存储ID",
        "url": "临时访问URL"
      }
    ]
  },
  "thumbnail": "缩略图URL",
  "create_time": Date,
  "update_time": Date
}
```

**索引建议**：
- `user_openid + type + create_time`（复合索引，用于按类型查询作品列表）
- `user_openid + status`（复合索引，用于查询进行中的任务）

### 3. task_queue 集合（已有，需支持新任务类型）

**用途**：存储异步任务队列
**权限**：仅云函数可读写

**必需字段**（针对个人功能）：
```javascript
{
  "_id": "任务ID（格式：fitting_personal_时间戳_随机数 或 travel_时间戳_随机数）",
  "user_openid": "用户OpenID",
  "type": "fitting-personal 或 travel",
  "status": "pending/processing/completed/failed", // 任务状态
  "state": "pending/downloading_user_photo/converting_user_photo/downloading_clothing/converting_clothing/preparing_prompt/calling_ai/ai_processing/uploading/completed/failed", // 详细状态
  "progress": 0-100,           // 进度百分比
  "message": "当前状态消息",
  "error_message": "错误信息（失败时）",

  // 任务参数（与works相同结构）
  "params": {
    "userPhoto": {},
    "bodyParams": {},
    "clothingImages": [],
    "clothingDescription": "",
    "background": "",
    // 或
    "destination": {},
    "customDescription": ""
  },

  // 结果数据
  "result": {
    "images": [
      {
        "fileId": "云存储ID",
        "url": "访问URL"
      }
    ]
  },

  "create_time": Date,
  "update_time": Date,
  "complete_time": Date        // 完成时间
}
```

**索引建议**：
- `user_openid + status`（用于查询用户进行中的任务）
- `type + status + create_time`（用于监控任务队列）

### 4. credit_records 集合（已有，需支持新消费类型）

**用途**：记录积分变动历史
**权限**：仅用户本人可读

**必需字段**（针对个人功能）：
```javascript
{
  "_id": "自动生成",
  "user_openid": "用户OpenID",
  "type": "expense/refund",    // 支出或退款
  "amount": -1 或 1,           // 积分变动（个人试衣-1，全球旅行-1）
  "balance": 9,                // 变动后余额
  "reason": "fitting-personal 或 travel 或 fitting-personal-refund 或 travel-refund",
  "related_task_id": "关联任务ID",
  "related_work_id": "关联作品ID",
  "description": "个人试衣 或 全球旅行 或 个人试衣退款 或 全球旅行退款",
  "create_time": Date
}
```

**索引建议**：
- `user_openid + create_time`（用于查询用户积分记录）

### 5. api_configs 集合（已有，需确认AI模型配置）

**用途**：存储AI模型配置
**权限**：仅管理员可写，云函数可读

**必需字段**：
```javascript
{
  "_id": "自动生成",
  "provider": "google",        // AI服务商
  "model_name": "gemini-2.0-flash-exp",
  "model_type": "text-to-image",
  "capabilities": ["image-generation"],
  "max_images": 16,            // 最大支持图片数
  "pricing": {
    "cost_per_request": 0.0001 // 每次请求成本
  },
  "api_config": {
    "api_key": "环境变量名（如GEMINI_API_KEY_1）"
  },
  "enabled": true,
  "priority": 1,               // 优先级（数字越小越优先）
  "create_time": Date
}
```

---

## 二、提示词配置

### 1. 个人试衣提示词模板

**位置**：`cloudfunctions/personal-worker/index.js` 的 `buildFittingPersonalPrompt()` 函数

**当前提示词**：
```javascript
const basePrompt = `
为一位真人进行虚拟试衣：
- 用户照片：${userPhotoDesc}
- 身体参数：身高${bodyParams.height}，体重${bodyParams.weight}，肤色${bodyParams.skin_tone}
- 服装图片：${clothingImagesDesc}
- 服装描述：${params.clothingDescription}
- 背景：${params.background || '简约白色背景'}

要求：
1. 保持用户的面部特征、肤色、发型完全一致
2. 将服装自然地穿在用户身上，注意服装的垂坠感和版型
3. 根据身体参数调整服装尺寸和比例
4. 保持服装的颜色、图案、细节完全一致
5. 背景简洁自然，突出试衣效果
6. 光影自然，整体协调
7. 输出高清、写实的照片效果

生成一张专业的虚拟试衣照片。
`
```

**可调整参数**：
- 背景风格（简约白色背景、室内场景、户外场景等）
- 拍摄角度（全身、半身、特写等）
- 光线效果（自然光、柔和光、摄影棚光等）

### 2. 全球旅行提示词模板

**位置**：`cloudfunctions/personal-worker/index.js` 的 `buildTravelPrompt()` 函数

**当前提示词**：
```javascript
const basePrompt = `
将一位真人融入旅游目的地场景：
- 人物照片：${userPhotoDesc}
- 目的地：${params.destination.name}（${params.destination.country}）
- 场景描述：${scenePrompt}
${customDesc}

要求：
1. 保持人物的面部特征、肤色、发型完全一致
2. 将人物自然融入目的地场景，注意透视、比例、光线的协调
3. 场景应体现目的地的标志性特征和氛围
4. 人物的服装、姿态应与旅游场景相符
5. 整体画面真实自然，如同旅游摄影作品
6. 光影协调，色彩鲜明
7. 输出高清、写实的照片效果

生成一张专业的旅游照片。
`
```

**可调整参数**：
- 天气效果（晴天、阴天、日落、夜景等）
- 季节特征（春夏秋冬）
- 拍摄距离（远景、中景、近景）
- 人物姿态（站立、行走、互动等）

### 3. 目的地场景提示词

**位置**：需要在数据库中配置目的地场景数据

**建议字段结构**：
```javascript
// destinations 集合（需新建）
{
  "_id": "destination_001",
  "name": "埃菲尔铁塔",
  "country": "法国",
  "prompt": "巴黎埃菲尔铁塔前的战神广场，标志性的铁塔建筑，欧式建筑背景，浪漫的巴黎氛围",
  "thumbnail": "缩略图URL",
  "category": "landmarks",     // 分类：landmarks/nature/urban/beach等
  "tags": ["欧洲", "地标", "浪漫"],
  "enabled": true
}
```

---

## 三、环境变量配置

### 云环境变量（使用 setup-env-vars.ps1 配置）

**必需环境变量**：
```bash
# Google Gemini API密钥（至少配置1个，最多8个）
GEMINI_API_KEY_1=your_api_key_here
GEMINI_API_KEY_2=your_api_key_here
# ... 最多到 GEMINI_API_KEY_8

# 其他AI服务商（可选）
OPENAI_API_KEY=your_openai_key
ANTHROPIC_API_KEY=your_anthropic_key
```

**配置方法**：
```powershell
# 在项目根目录运行
.\setup-env-vars.ps1

# 或手动在微信开发者工具中配置：
# 云开发控制台 → 设置 → 环境变量 → 添加变量
```

---

## 四、积分消费配置

### 当前积分定价

| 功能类型 | 消费积分 | 代码位置 |
|---------|---------|---------|
| 个人试衣 | 1积分/次 | personal/index.js:createFittingPersonalTask() |
| 全球旅行 | 1积分/次 | personal/index.js:createTravelTask() |

### 退款规则

- **自动退款**：任务失败时自动退还积分
- **退款记录**：在credit_records中记录type='refund'
- **退款原因**：fitting-personal-refund 或 travel-refund

---

## 五、部署检查清单

### 1. 云函数部署
```powershell
# 部署个人功能云函数
.\deploy-cloudfunctions.ps1

# 检查部署状态
.\deployment-checklist.ps1
```

### 2. 数据库权限配置

**users 集合权限**：
```json
{
  "read": "doc.openid == auth.openid",
  "write": "doc.openid == auth.openid"
}
```

**works 集合权限**：
```json
{
  "read": "doc.user_openid == auth.openid",
  "write": "doc.user_openid == auth.openid"
}
```

**task_queue 集合权限**：
```json
{
  "read": false,
  "write": false
}
```
（仅云函数访问，前端无权限）

**credit_records 集合权限**：
```json
{
  "read": "doc.user_openid == auth.openid",
  "write": false
}
```
（仅云函数写入，用户只读）

### 3. 云存储配置

**存储桶**：使用默认云存储
**文件命名规范**：
- 用户照片：`user-photos/{openid}/{timestamp}.jpg`
- 服装图片：`clothing-images/{openid}/{timestamp}.jpg`
- 结果图片：`generated-works/{type}/{task_id}/{index}.jpg`

### 4. AI模型配置检查

运行调试脚本验证AI配置：
```powershell
.\debug-auth-aimodels.ps1
```

确认api_configs集合中至少有一个启用的text-to-image模型。

---

## 六、测试步骤

### 1. 个人试衣测试流程
1. 上传用户照片
2. 填写身体参数
3. 上传服装图片
4. 点击生成
5. 查看进度页面（57秒超时检测）
6. 完成后跳转作品页（个人试衣tab）

### 2. 全球旅行测试流程
1. 上传用户照片
2. 选择目的地
3. 填写自定义描述（可选）
4. 点击生成
5. 查看进度页面（57秒超时检测）
6. 完成后跳转作品页（全球旅行tab）

### 3. 积分测试
- 测试积分不足时的拦截
- 测试任务失败时的自动退款
- 测试积分记录的正确性

---

## 七、监控与维护

### 1. 任务队列监控
定期检查task_queue集合中status='processing'的长时间未完成任务：
```javascript
db.collection('task_queue')
  .where({
    status: 'processing',
    create_time: _.lt(new Date(Date.now() - 10 * 60 * 1000)) // 超过10分钟
  })
  .get()
```

### 2. 失败任务分析
统计失败原因分布：
```javascript
db.collection('task_queue')
  .where({
    status: 'failed',
    type: 'fitting-personal' // 或 'travel'
  })
  .field({
    error_message: true,
    state: true
  })
  .get()
```

### 3. AI成本监控
统计每日AI调用次数和成本：
```javascript
db.collection('task_queue')
  .where({
    status: 'completed',
    state: 'completed',
    create_time: _.gte(startOfDay).and(_.lt(endOfDay))
  })
  .count()
```

---

## 八、常见问题排查

### 问题1：AI生成失败
**排查步骤**：
1. 检查环境变量中的API密钥是否有效
2. 检查api_configs集合中是否有启用的模型
3. 查看task_queue中的error_message
4. 运行 `debug-auth-aimodels.ps1` 测试AI连接

### 问题2：积分未扣除或未退款
**排查步骤**：
1. 检查users集合中的credits字段
2. 检查credit_records集合中是否有对应记录
3. 查看云函数日志中的积分操作记录

### 问题3：进度页面卡住
**排查步骤**：
1. 检查task_queue中任务的当前state
2. 查看personal-worker云函数的执行日志
3. 确认是否触发了57秒超时机制

### 问题4：作品图片无法访问
**排查步骤**：
1. 检查云存储中的文件是否存在
2. 确认临时URL是否过期（2小时有效期）
3. 查看works集合中的result.images数据

---

## 九、性能优化建议

1. **图片预处理**：前端使用base64Mode上传（已实现）
2. **并发控制**：限制同一用户同时进行的任务数（建议1-2个）
3. **缓存机制**：对相同参数的生成结果进行缓存（可选）
4. **CDN加速**：为云存储配置CDN（提升图片加载速度）
5. **批量处理**：支持批量生成多张图片（需扩展功能）

---

**配置文档版本**：v1.0
**最后更新时间**：2025-10-11
**负责人**：开发团队
