# AI摄影系统 - 无感迁移方案

## 📋 方案概述

**目标**: 从微信云开发平滑迁移到自建服务器,用户完全无感知
**策略**: 双轨并行 → 灰度切换 → 完全迁移
**时间**: 预计 2-4周
**风险**: 极低 (可随时回滚)

---

## 🔍 当前架构分析

### 现有技术栈
```
小程序端:
├── app.js                  # 云开发初始化
├── utils/api.js            # 云函数调用封装
└── pages/                  # 各页面直接调用云函数

云开发端:
├── cloudfunctions/
│   ├── user/              # 用户管理
│   ├── photography/       # 摄影生成
│   ├── fitting/           # 试衣生成
│   ├── payment/           # 积分支付
│   ├── api/               # 作品管理
│   └── scene/             # 场景管理
└── 数据库: 微信云数据库
```

### 核心依赖
1. ✅ `wx.cloud.callFunction()` - 云函数调用
2. ✅ `wx.cloud.uploadFile()` - 文件上传
3. ✅ `wx.cloud.database()` - 数据库 (后端调用)
4. ✅ `cloud.getWXContext()` - 获取OPENID

---

## 🎯 无感迁移策略

### 核心思路:适配器模式

```
┌─────────────┐
│  小程序页面  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  API适配层   │ ← 关键!统一接口
└──────┬──────┘
       │
   ┌───┴───┐
   ▼       ▼
┌────┐  ┌────┐
│云开发│  │自建│
└────┘  └────┘
```

**优势**:
- ✅ 小程序代码**零改动**
- ✅ 可灰度切换 (部分用户用新服务器)
- ✅ 可随时回滚
- ✅ 用户完全无感知

---

## 📝 详细迁移步骤

### 阶段一: 准备阶段 (1-2天)

#### 1.1 部署自建服务器
```bash
# 在服务器上运行
cd ai-photo-system
chmod +x deploy/deploy.sh
./deploy/deploy.sh
```

**检查项**:
- ✅ MySQL 数据库运行
- ✅ Redis 缓存运行
- ✅ 后端API启动 (3000端口)
- ✅ n8n 工作流配置
- ✅ Nginx 反向代理配置

#### 1.2 数据迁移

```javascript
// 云函数: data-migration.js
exports.main = async (event, context) => {
  const db = cloud.database()
  const axios = require('axios')

  // 1. 导出用户数据
  const users = await db.collection('users').get()
  await axios.post('https://api.yourdomain.com/migrate/users', {
    data: users.data
  })

  // 2. 导出作品数据
  const works = await db.collection('works').get()
  await axios.post('https://api.yourdomain.com/migrate/works', {
    data: works.data
  })

  // 3. 导出场景数据
  const scenes = await db.collection('scenes').get()
  await axios.post('https://api.yourdomain.com/migrate/scenes', {
    data: scenes.data
  })

  return { success: true, migrated: users.data.length + works.data.length }
}
```

---

### 阶段二: 适配层开发 (1-2天)

#### 2.1 创建 API适配器

**新建文件**: `miniprogram/utils/api-adapter.js`

```javascript
// API适配器 - 统一接口,双后端支持
class ApiAdapter {
  constructor() {
    // 后端类型: 'cloud' | 'server'
    this.backendType = 'cloud' // 默认云开发
    this.serverBaseUrl = 'https://api.yourdomain.com'

    // 从云端获取配置
    this.loadConfig()
  }

  /**
   * 动态加载后端配置
   */
  async loadConfig() {
    try {
      // 从云数据库读取配置
      const db = wx.cloud.database()
      const config = await db.collection('system_config')
        .doc('backend_config')
        .get()

      if (config.data) {
        this.backendType = config.data.backend_type || 'cloud'
        this.serverBaseUrl = config.data.server_url || this.serverBaseUrl

        // 灰度策略: 根据用户ID分流
        if (config.data.gray_release) {
          const { OPENID } = await wx.cloud.callFunction({ name: 'login' })
          const hash = this.hashCode(OPENID)
          const grayPercent = config.data.gray_percent || 0

          if (hash % 100 < grayPercent) {
            this.backendType = 'server' // 灰度用户走新服务器
            console.log('🎲 灰度用户,使用自建服务器')
          }
        }
      }
    } catch (error) {
      console.warn('加载后端配置失败,使用默认云开发', error)
    }
  }

  /**
   * 统一调用接口
   */
  async callFunction(name, data) {
    if (this.backendType === 'server') {
      return await this.callServerAPI(name, data)
    } else {
      return await this.callCloudFunction(name, data)
    }
  }

  /**
   * 调用云函数 (原有方式)
   */
  async callCloudFunction(name, data) {
    const res = await wx.cloud.callFunction({ name, data })
    return res.result
  }

  /**
   * 调用自建服务器API
   */
  async callServerAPI(name, data) {
    // 获取token
    const token = wx.getStorageSync('server_token')

    // 映射云函数到API接口
    const endpoint = this.mapFunctionToEndpoint(name, data.action)

    const res = await wx.request({
      url: `${this.serverBaseUrl}${endpoint}`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: data
    })

    return res.data
  }

  /**
   * 云函数名映射到API路径
   */
  mapFunctionToEndpoint(functionName, action) {
    const mapping = {
      'user': {
        'register': '/api/auth/register',
        'getUserInfo': '/api/users/me'
      },
      'photography': {
        'generate': '/api/tasks/photography',
        'getProgress': '/api/tasks/progress'
      },
      'fitting': {
        'generate': '/api/tasks/fitting'
      },
      'api': {
        'getWorkList': '/api/works',
        'toggleFavorite': '/api/works/favorite'
      },
      'payment': {
        'dailyCheckin': '/api/credits/checkin',
        'getPackages': '/api/credits/packages'
      }
    }

    return mapping[functionName]?.[action] || `/api/${functionName}/${action}`
  }

  /**
   * 字符串哈希 (用于灰度分流)
   */
  hashCode(str) {
    let hash = 0
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i)
      hash = hash & hash
    }
    return Math.abs(hash)
  }
}

module.exports = new ApiAdapter()
```

#### 2.2 修改 api.js (最小改动)

```javascript
// utils/api.js - 只需改一行!
const adapter = require('./api-adapter.js')

class ApiService {
  async callCloudFunction(functionName, data = {}) {
    // 原来: wx.cloud.callFunction({ name: functionName, data })
    // 现在: 通过适配器调用 (自动分流)
    return await adapter.callFunction(functionName, data)
  }

  // 其他方法保持不变...
}
```

---

### 阶段三: 灰度发布 (3-7天)

#### 3.1 配置灰度策略

在云数据库创建配置:

```javascript
// 云开发数据库 system_config 集合
{
  "_id": "backend_config",
  "backend_type": "cloud",  // cloud | server | auto
  "server_url": "https://api.yourdomain.com",
  "gray_release": true,     // 开启灰度
  "gray_percent": 5,        // 5%用户走新服务器
  "white_list": [           // 白名单用户(测试用)
    "openid_xxx",
    "openid_yyy"
  ],
  "black_list": [],         // 黑名单(强制云开发)
  "updated_at": "2025-10-12"
}
```

#### 3.2 灰度流程

**第1天**: 5% 灰度
```javascript
{ "gray_percent": 5 }  // 5%用户
```

**第3天**: 监控无异常,扩大到20%
```javascript
{ "gray_percent": 20 }
```

**第5天**: 50%
```javascript
{ "gray_percent": 50 }
```

**第7天**: 100% (完全切换)
```javascript
{
  "backend_type": "server",
  "gray_release": false
}
```

#### 3.3 监控指标

**关键指标**:
- ✅ 接口成功率 (目标: >99%)
- ✅ 平均响应时间 (目标: <500ms)
- ✅ 错误率 (目标: <1%)
- ✅ 用户反馈

**监控代码**:
```javascript
// 后端添加监控
app.use((req, res, next) => {
  const start = Date.now()
  res.on('finish', () => {
    const duration = Date.now() - start
    logger.info({
      path: req.path,
      method: req.method,
      status: res.statusCode,
      duration,
      user: req.user?.openid
    })
  })
  next()
})
```

---

### 阶段四: 完全切换 (1天)

#### 4.1 最终切换

```javascript
// 更新云数据库配置
{
  "backend_type": "server",  // 强制使用自建服务器
  "gray_release": false,     // 关闭灰度
  "gray_percent": 0
}
```

#### 4.2 小程序更新 (可选)

**版本1**: 通过适配器 (当前)
```javascript
// 不改代码,配置切换
```

**版本2**: 直接调用 (后续优化)
```javascript
// 移除适配器,直接调用自建API
// 需要发布新版小程序
```

---

## 🔄 回滚方案

### 一键回滚

**任何时候都可以回滚!**

```javascript
// 立即回滚到云开发
{
  "backend_type": "cloud",
  "gray_release": false
}
```

**操作步骤**:
1. 登录云开发控制台
2. 打开数据库 `system_config` 集合
3. 修改 `backend_config` 文档
4. 保存 (立即生效,无需发布小程序)

---

## 💰 成本对比

### 云开发成本 (当前)
```
- 云函数调用: ¥0.0133/万次
- 云数据库: ¥0.07/GB/天
- 云存储: ¥0.18/GB/月
- 月流量: 假设10万次调用,10GB数据

月成本: ¥300-500 (波动)
```

### 自建服务器成本 (迁移后)
```
- 服务器: ¥100-200/月 (固定)
- 域名: ¥50/年
- SSL证书: 免费 (Let's Encrypt)
- 带宽: 包含在服务器费用中

月成本: ¥100-200 (固定)
节省: 50-70%
```

---

## ⚠️ 注意事项

### 1. OpenID 获取

**云开发**: 自动
```javascript
const { OPENID } = cloud.getWXContext()
```

**自建服务器**: 需要code换取
```javascript
// 小程序端
wx.login({
  success: res => {
    // 发送res.code到后端
    wx.request({
      url: 'https://api.yourdomain.com/auth/wechat',
      method: 'POST',
      data: { code: res.code }
    })
  }
})

// 后端
const response = await axios.get(`https://api.weixin.qq.com/sns/jscode2session`, {
  params: {
    appid: WECHAT_APPID,
    secret: WECHAT_SECRET,
    js_code: code,
    grant_type: 'authorization_code'
  }
})
const openid = response.data.openid
```

### 2. 文件上传

**云开发**: 直传云存储
```javascript
wx.cloud.uploadFile({
  cloudPath: 'xxx.jpg',
  filePath: tempFilePath
})
```

**自建服务器**: 需要中转
```javascript
// 方案A: 仍用云存储
wx.cloud.uploadFile() // 保持不变

// 方案B: 对象存储 (OSS/COS)
wx.uploadFile({
  url: 'https://api.yourdomain.com/upload',
  filePath: tempFilePath
})
```

### 3. 数据同步

**迁移期间**:
- ✅ 双写 (云开发+自建)
- ✅ 异步同步
- ✅ 数据校验

**完全切换后**:
- ✅ 只写自建
- ✅ 定期备份

---

## 📊 迁移时间表

| 阶段 | 时间 | 任务 | 负责人 |
|------|------|------|--------|
| 准备 | D1-D2 | 服务器部署+数据迁移 | 运维 |
| 开发 | D3-D4 | 适配器开发+测试 | 开发 |
| 灰度 | D5 | 5%灰度 | 产品 |
| 灰度 | D7 | 20%灰度 | 产品 |
| 灰度 | D10 | 50%灰度 | 产品 |
| 切换 | D14 | 100%切换 | 全员 |
| 优化 | D15-D21 | 代码优化+监控 | 开发 |

---

## ✅ 检查清单

### 迁移前
- [ ] 自建服务器部署完成
- [ ] 数据库迁移完成
- [ ] API接口测试通过
- [ ] 适配器开发完成
- [ ] 监控系统就绪

### 迁移中
- [ ] 灰度配置生效
- [ ] 监控数据正常
- [ ] 用户反馈收集
- [ ] 性能指标达标
- [ ] 错误率<1%

### 迁移后
- [ ] 100%用户切换
- [ ] 云开发关闭(保留备份)
- [ ] 成本对比确认
- [ ] 文档更新完成

---

## 🎯 总结

### 核心优势
1. ✅ **用户无感知** - 零影响
2. ✅ **可随时回滚** - 零风险
3. ✅ **灰度发布** - 平滑过渡
4. ✅ **成本降低** - 50-70%
5. ✅ **性能提升** - 自建更快

### 关键技术
- 🎯 适配器模式
- 🎲 灰度发布
- 📊 实时监控
- 🔄 双写同步
- ⚡ 一键回滚

### 预期效果
- 迁移周期: 2-4周
- 用户投诉: 0次
- 服务中断: 0秒
- 成本节省: 50-70%

---

**开始时间**: 随时可以开始
**风险等级**: ⭐ 极低
**推荐指数**: ⭐⭐⭐⭐⭐
