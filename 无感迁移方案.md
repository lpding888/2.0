# AIæ‘„å½±ç³»ç»Ÿ - æ— æ„Ÿè¿ç§»æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**: ä»å¾®ä¿¡äº‘å¼€å‘å¹³æ»‘è¿ç§»åˆ°è‡ªå»ºæœåŠ¡å™¨,ç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥
**ç­–ç•¥**: åŒè½¨å¹¶è¡Œ â†’ ç°åº¦åˆ‡æ¢ â†’ å®Œå…¨è¿ç§»
**æ—¶é—´**: é¢„è®¡ 2-4å‘¨
**é£é™©**: æä½ (å¯éšæ—¶å›æ»š)

---

## ğŸ” å½“å‰æ¶æ„åˆ†æ

### ç°æœ‰æŠ€æœ¯æ ˆ
```
å°ç¨‹åºç«¯:
â”œâ”€â”€ app.js                  # äº‘å¼€å‘åˆå§‹åŒ–
â”œâ”€â”€ utils/api.js            # äº‘å‡½æ•°è°ƒç”¨å°è£…
â””â”€â”€ pages/                  # å„é¡µé¢ç›´æ¥è°ƒç”¨äº‘å‡½æ•°

äº‘å¼€å‘ç«¯:
â”œâ”€â”€ cloudfunctions/
â”‚   â”œâ”€â”€ user/              # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ photography/       # æ‘„å½±ç”Ÿæˆ
â”‚   â”œâ”€â”€ fitting/           # è¯•è¡£ç”Ÿæˆ
â”‚   â”œâ”€â”€ payment/           # ç§¯åˆ†æ”¯ä»˜
â”‚   â”œâ”€â”€ api/               # ä½œå“ç®¡ç†
â”‚   â””â”€â”€ scene/             # åœºæ™¯ç®¡ç†
â””â”€â”€ æ•°æ®åº“: å¾®ä¿¡äº‘æ•°æ®åº“
```

### æ ¸å¿ƒä¾èµ–
1. âœ… `wx.cloud.callFunction()` - äº‘å‡½æ•°è°ƒç”¨
2. âœ… `wx.cloud.uploadFile()` - æ–‡ä»¶ä¸Šä¼ 
3. âœ… `wx.cloud.database()` - æ•°æ®åº“ (åç«¯è°ƒç”¨)
4. âœ… `cloud.getWXContext()` - è·å–OPENID

---

## ğŸ¯ æ— æ„Ÿè¿ç§»ç­–ç•¥

### æ ¸å¿ƒæ€è·¯:é€‚é…å™¨æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å°ç¨‹åºé¡µé¢  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIé€‚é…å±‚   â”‚ â† å…³é”®!ç»Ÿä¸€æ¥å£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â–¼       â–¼
â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚äº‘å¼€å‘â”‚  â”‚è‡ªå»ºâ”‚
â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**:
- âœ… å°ç¨‹åºä»£ç **é›¶æ”¹åŠ¨**
- âœ… å¯ç°åº¦åˆ‡æ¢ (éƒ¨åˆ†ç”¨æˆ·ç”¨æ–°æœåŠ¡å™¨)
- âœ… å¯éšæ—¶å›æ»š
- âœ… ç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥

---

## ğŸ“ è¯¦ç»†è¿ç§»æ­¥éª¤

### é˜¶æ®µä¸€: å‡†å¤‡é˜¶æ®µ (1-2å¤©)

#### 1.1 éƒ¨ç½²è‡ªå»ºæœåŠ¡å™¨
```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
cd ai-photo-system
chmod +x deploy/deploy.sh
./deploy/deploy.sh
```

**æ£€æŸ¥é¡¹**:
- âœ… MySQL æ•°æ®åº“è¿è¡Œ
- âœ… Redis ç¼“å­˜è¿è¡Œ
- âœ… åç«¯APIå¯åŠ¨ (3000ç«¯å£)
- âœ… n8n å·¥ä½œæµé…ç½®
- âœ… Nginx åå‘ä»£ç†é…ç½®

#### 1.2 æ•°æ®è¿ç§»

```javascript
// äº‘å‡½æ•°: data-migration.js
exports.main = async (event, context) => {
  const db = cloud.database()
  const axios = require('axios')

  // 1. å¯¼å‡ºç”¨æˆ·æ•°æ®
  const users = await db.collection('users').get()
  await axios.post('https://api.yourdomain.com/migrate/users', {
    data: users.data
  })

  // 2. å¯¼å‡ºä½œå“æ•°æ®
  const works = await db.collection('works').get()
  await axios.post('https://api.yourdomain.com/migrate/works', {
    data: works.data
  })

  // 3. å¯¼å‡ºåœºæ™¯æ•°æ®
  const scenes = await db.collection('scenes').get()
  await axios.post('https://api.yourdomain.com/migrate/scenes', {
    data: scenes.data
  })

  return { success: true, migrated: users.data.length + works.data.length }
}
```

---

### é˜¶æ®µäºŒ: é€‚é…å±‚å¼€å‘ (1-2å¤©)

#### 2.1 åˆ›å»º APIé€‚é…å™¨

**æ–°å»ºæ–‡ä»¶**: `miniprogram/utils/api-adapter.js`

```javascript
// APIé€‚é…å™¨ - ç»Ÿä¸€æ¥å£,åŒåç«¯æ”¯æŒ
class ApiAdapter {
  constructor() {
    // åç«¯ç±»å‹: 'cloud' | 'server'
    this.backendType = 'cloud' // é»˜è®¤äº‘å¼€å‘
    this.serverBaseUrl = 'https://api.yourdomain.com'

    // ä»äº‘ç«¯è·å–é…ç½®
    this.loadConfig()
  }

  /**
   * åŠ¨æ€åŠ è½½åç«¯é…ç½®
   */
  async loadConfig() {
    try {
      // ä»äº‘æ•°æ®åº“è¯»å–é…ç½®
      const db = wx.cloud.database()
      const config = await db.collection('system_config')
        .doc('backend_config')
        .get()

      if (config.data) {
        this.backendType = config.data.backend_type || 'cloud'
        this.serverBaseUrl = config.data.server_url || this.serverBaseUrl

        // ç°åº¦ç­–ç•¥: æ ¹æ®ç”¨æˆ·IDåˆ†æµ
        if (config.data.gray_release) {
          const { OPENID } = await wx.cloud.callFunction({ name: 'login' })
          const hash = this.hashCode(OPENID)
          const grayPercent = config.data.gray_percent || 0

          if (hash % 100 < grayPercent) {
            this.backendType = 'server' // ç°åº¦ç”¨æˆ·èµ°æ–°æœåŠ¡å™¨
            console.log('ğŸ² ç°åº¦ç”¨æˆ·,ä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨')
          }
        }
      }
    } catch (error) {
      console.warn('åŠ è½½åç«¯é…ç½®å¤±è´¥,ä½¿ç”¨é»˜è®¤äº‘å¼€å‘', error)
    }
  }

  /**
   * ç»Ÿä¸€è°ƒç”¨æ¥å£
   */
  async callFunction(name, data) {
    if (this.backendType === 'server') {
      return await this.callServerAPI(name, data)
    } else {
      return await this.callCloudFunction(name, data)
    }
  }

  /**
   * è°ƒç”¨äº‘å‡½æ•° (åŸæœ‰æ–¹å¼)
   */
  async callCloudFunction(name, data) {
    const res = await wx.cloud.callFunction({ name, data })
    return res.result
  }

  /**
   * è°ƒç”¨è‡ªå»ºæœåŠ¡å™¨API
   */
  async callServerAPI(name, data) {
    // è·å–token
    const token = wx.getStorageSync('server_token')

    // æ˜ å°„äº‘å‡½æ•°åˆ°APIæ¥å£
    const endpoint = this.mapFunctionToEndpoint(name, data.action)

    const res = await wx.request({
      url: `${this.serverBaseUrl}${endpoint}`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: data
    })

    return res.data
  }

  /**
   * äº‘å‡½æ•°åæ˜ å°„åˆ°APIè·¯å¾„
   */
  mapFunctionToEndpoint(functionName, action) {
    const mapping = {
      'user': {
        'register': '/api/auth/register',
        'getUserInfo': '/api/users/me'
      },
      'photography': {
        'generate': '/api/tasks/photography',
        'getProgress': '/api/tasks/progress'
      },
      'fitting': {
        'generate': '/api/tasks/fitting'
      },
      'api': {
        'getWorkList': '/api/works',
        'toggleFavorite': '/api/works/favorite'
      },
      'payment': {
        'dailyCheckin': '/api/credits/checkin',
        'getPackages': '/api/credits/packages'
      }
    }

    return mapping[functionName]?.[action] || `/api/${functionName}/${action}`
  }

  /**
   * å­—ç¬¦ä¸²å“ˆå¸Œ (ç”¨äºç°åº¦åˆ†æµ)
   */
  hashCode(str) {
    let hash = 0
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i)
      hash = hash & hash
    }
    return Math.abs(hash)
  }
}

module.exports = new ApiAdapter()
```

#### 2.2 ä¿®æ”¹ api.js (æœ€å°æ”¹åŠ¨)

```javascript
// utils/api.js - åªéœ€æ”¹ä¸€è¡Œ!
const adapter = require('./api-adapter.js')

class ApiService {
  async callCloudFunction(functionName, data = {}) {
    // åŸæ¥: wx.cloud.callFunction({ name: functionName, data })
    // ç°åœ¨: é€šè¿‡é€‚é…å™¨è°ƒç”¨ (è‡ªåŠ¨åˆ†æµ)
    return await adapter.callFunction(functionName, data)
  }

  // å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜...
}
```

---

### é˜¶æ®µä¸‰: ç°åº¦å‘å¸ƒ (3-7å¤©)

#### 3.1 é…ç½®ç°åº¦ç­–ç•¥

åœ¨äº‘æ•°æ®åº“åˆ›å»ºé…ç½®:

```javascript
// äº‘å¼€å‘æ•°æ®åº“ system_config é›†åˆ
{
  "_id": "backend_config",
  "backend_type": "cloud",  // cloud | server | auto
  "server_url": "https://api.yourdomain.com",
  "gray_release": true,     // å¼€å¯ç°åº¦
  "gray_percent": 5,        // 5%ç”¨æˆ·èµ°æ–°æœåŠ¡å™¨
  "white_list": [           // ç™½åå•ç”¨æˆ·(æµ‹è¯•ç”¨)
    "openid_xxx",
    "openid_yyy"
  ],
  "black_list": [],         // é»‘åå•(å¼ºåˆ¶äº‘å¼€å‘)
  "updated_at": "2025-10-12"
}
```

#### 3.2 ç°åº¦æµç¨‹

**ç¬¬1å¤©**: 5% ç°åº¦
```javascript
{ "gray_percent": 5 }  // 5%ç”¨æˆ·
```

**ç¬¬3å¤©**: ç›‘æ§æ— å¼‚å¸¸,æ‰©å¤§åˆ°20%
```javascript
{ "gray_percent": 20 }
```

**ç¬¬5å¤©**: 50%
```javascript
{ "gray_percent": 50 }
```

**ç¬¬7å¤©**: 100% (å®Œå…¨åˆ‡æ¢)
```javascript
{
  "backend_type": "server",
  "gray_release": false
}
```

#### 3.3 ç›‘æ§æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**:
- âœ… æ¥å£æˆåŠŸç‡ (ç›®æ ‡: >99%)
- âœ… å¹³å‡å“åº”æ—¶é—´ (ç›®æ ‡: <500ms)
- âœ… é”™è¯¯ç‡ (ç›®æ ‡: <1%)
- âœ… ç”¨æˆ·åé¦ˆ

**ç›‘æ§ä»£ç **:
```javascript
// åç«¯æ·»åŠ ç›‘æ§
app.use((req, res, next) => {
  const start = Date.now()
  res.on('finish', () => {
    const duration = Date.now() - start
    logger.info({
      path: req.path,
      method: req.method,
      status: res.statusCode,
      duration,
      user: req.user?.openid
    })
  })
  next()
})
```

---

### é˜¶æ®µå››: å®Œå…¨åˆ‡æ¢ (1å¤©)

#### 4.1 æœ€ç»ˆåˆ‡æ¢

```javascript
// æ›´æ–°äº‘æ•°æ®åº“é…ç½®
{
  "backend_type": "server",  // å¼ºåˆ¶ä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨
  "gray_release": false,     // å…³é—­ç°åº¦
  "gray_percent": 0
}
```

#### 4.2 å°ç¨‹åºæ›´æ–° (å¯é€‰)

**ç‰ˆæœ¬1**: é€šè¿‡é€‚é…å™¨ (å½“å‰)
```javascript
// ä¸æ”¹ä»£ç ,é…ç½®åˆ‡æ¢
```

**ç‰ˆæœ¬2**: ç›´æ¥è°ƒç”¨ (åç»­ä¼˜åŒ–)
```javascript
// ç§»é™¤é€‚é…å™¨,ç›´æ¥è°ƒç”¨è‡ªå»ºAPI
// éœ€è¦å‘å¸ƒæ–°ç‰ˆå°ç¨‹åº
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

### ä¸€é”®å›æ»š

**ä»»ä½•æ—¶å€™éƒ½å¯ä»¥å›æ»š!**

```javascript
// ç«‹å³å›æ»šåˆ°äº‘å¼€å‘
{
  "backend_type": "cloud",
  "gray_release": false
}
```

**æ“ä½œæ­¥éª¤**:
1. ç™»å½•äº‘å¼€å‘æ§åˆ¶å°
2. æ‰“å¼€æ•°æ®åº“ `system_config` é›†åˆ
3. ä¿®æ”¹ `backend_config` æ–‡æ¡£
4. ä¿å­˜ (ç«‹å³ç”Ÿæ•ˆ,æ— éœ€å‘å¸ƒå°ç¨‹åº)

---

## ğŸ’° æˆæœ¬å¯¹æ¯”

### äº‘å¼€å‘æˆæœ¬ (å½“å‰)
```
- äº‘å‡½æ•°è°ƒç”¨: Â¥0.0133/ä¸‡æ¬¡
- äº‘æ•°æ®åº“: Â¥0.07/GB/å¤©
- äº‘å­˜å‚¨: Â¥0.18/GB/æœˆ
- æœˆæµé‡: å‡è®¾10ä¸‡æ¬¡è°ƒç”¨,10GBæ•°æ®

æœˆæˆæœ¬: Â¥300-500 (æ³¢åŠ¨)
```

### è‡ªå»ºæœåŠ¡å™¨æˆæœ¬ (è¿ç§»å)
```
- æœåŠ¡å™¨: Â¥100-200/æœˆ (å›ºå®š)
- åŸŸå: Â¥50/å¹´
- SSLè¯ä¹¦: å…è´¹ (Let's Encrypt)
- å¸¦å®½: åŒ…å«åœ¨æœåŠ¡å™¨è´¹ç”¨ä¸­

æœˆæˆæœ¬: Â¥100-200 (å›ºå®š)
èŠ‚çœ: 50-70%
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. OpenID è·å–

**äº‘å¼€å‘**: è‡ªåŠ¨
```javascript
const { OPENID } = cloud.getWXContext()
```

**è‡ªå»ºæœåŠ¡å™¨**: éœ€è¦codeæ¢å–
```javascript
// å°ç¨‹åºç«¯
wx.login({
  success: res => {
    // å‘é€res.codeåˆ°åç«¯
    wx.request({
      url: 'https://api.yourdomain.com/auth/wechat',
      method: 'POST',
      data: { code: res.code }
    })
  }
})

// åç«¯
const response = await axios.get(`https://api.weixin.qq.com/sns/jscode2session`, {
  params: {
    appid: WECHAT_APPID,
    secret: WECHAT_SECRET,
    js_code: code,
    grant_type: 'authorization_code'
  }
})
const openid = response.data.openid
```

### 2. æ–‡ä»¶ä¸Šä¼ 

**äº‘å¼€å‘**: ç›´ä¼ äº‘å­˜å‚¨
```javascript
wx.cloud.uploadFile({
  cloudPath: 'xxx.jpg',
  filePath: tempFilePath
})
```

**è‡ªå»ºæœåŠ¡å™¨**: éœ€è¦ä¸­è½¬
```javascript
// æ–¹æ¡ˆA: ä»ç”¨äº‘å­˜å‚¨
wx.cloud.uploadFile() // ä¿æŒä¸å˜

// æ–¹æ¡ˆB: å¯¹è±¡å­˜å‚¨ (OSS/COS)
wx.uploadFile({
  url: 'https://api.yourdomain.com/upload',
  filePath: tempFilePath
})
```

### 3. æ•°æ®åŒæ­¥

**è¿ç§»æœŸé—´**:
- âœ… åŒå†™ (äº‘å¼€å‘+è‡ªå»º)
- âœ… å¼‚æ­¥åŒæ­¥
- âœ… æ•°æ®æ ¡éªŒ

**å®Œå…¨åˆ‡æ¢å**:
- âœ… åªå†™è‡ªå»º
- âœ… å®šæœŸå¤‡ä»½

---

## ğŸ“Š è¿ç§»æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ | è´Ÿè´£äºº |
|------|------|------|--------|
| å‡†å¤‡ | D1-D2 | æœåŠ¡å™¨éƒ¨ç½²+æ•°æ®è¿ç§» | è¿ç»´ |
| å¼€å‘ | D3-D4 | é€‚é…å™¨å¼€å‘+æµ‹è¯• | å¼€å‘ |
| ç°åº¦ | D5 | 5%ç°åº¦ | äº§å“ |
| ç°åº¦ | D7 | 20%ç°åº¦ | äº§å“ |
| ç°åº¦ | D10 | 50%ç°åº¦ | äº§å“ |
| åˆ‡æ¢ | D14 | 100%åˆ‡æ¢ | å…¨å‘˜ |
| ä¼˜åŒ– | D15-D21 | ä»£ç ä¼˜åŒ–+ç›‘æ§ | å¼€å‘ |

---

## âœ… æ£€æŸ¥æ¸…å•

### è¿ç§»å‰
- [ ] è‡ªå»ºæœåŠ¡å™¨éƒ¨ç½²å®Œæˆ
- [ ] æ•°æ®åº“è¿ç§»å®Œæˆ
- [ ] APIæ¥å£æµ‹è¯•é€šè¿‡
- [ ] é€‚é…å™¨å¼€å‘å®Œæˆ
- [ ] ç›‘æ§ç³»ç»Ÿå°±ç»ª

### è¿ç§»ä¸­
- [ ] ç°åº¦é…ç½®ç”Ÿæ•ˆ
- [ ] ç›‘æ§æ•°æ®æ­£å¸¸
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- [ ] é”™è¯¯ç‡<1%

### è¿ç§»å
- [ ] 100%ç”¨æˆ·åˆ‡æ¢
- [ ] äº‘å¼€å‘å…³é—­(ä¿ç•™å¤‡ä»½)
- [ ] æˆæœ¬å¯¹æ¯”ç¡®è®¤
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
1. âœ… **ç”¨æˆ·æ— æ„ŸçŸ¥** - é›¶å½±å“
2. âœ… **å¯éšæ—¶å›æ»š** - é›¶é£é™©
3. âœ… **ç°åº¦å‘å¸ƒ** - å¹³æ»‘è¿‡æ¸¡
4. âœ… **æˆæœ¬é™ä½** - 50-70%
5. âœ… **æ€§èƒ½æå‡** - è‡ªå»ºæ›´å¿«

### å…³é”®æŠ€æœ¯
- ğŸ¯ é€‚é…å™¨æ¨¡å¼
- ğŸ² ç°åº¦å‘å¸ƒ
- ğŸ“Š å®æ—¶ç›‘æ§
- ğŸ”„ åŒå†™åŒæ­¥
- âš¡ ä¸€é”®å›æ»š

### é¢„æœŸæ•ˆæœ
- è¿ç§»å‘¨æœŸ: 2-4å‘¨
- ç”¨æˆ·æŠ•è¯‰: 0æ¬¡
- æœåŠ¡ä¸­æ–­: 0ç§’
- æˆæœ¬èŠ‚çœ: 50-70%

---

**å¼€å§‹æ—¶é—´**: éšæ—¶å¯ä»¥å¼€å§‹
**é£é™©ç­‰çº§**: â­ æä½
**æ¨èæŒ‡æ•°**: â­â­â­â­â­
