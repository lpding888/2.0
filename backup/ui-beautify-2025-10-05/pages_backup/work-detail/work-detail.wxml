<!--ä½œå“è¯¦æƒ…é¡µé¢ - ç°ä»£åŒ–è®¾è®¡-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <block wx:if="{{loading}}">
    <state loading="{{true}}" empty="{{false}}" errorText="" skeleton="{{true}}" variant="detail"></state>
  </block>

  <block wx:else>
    <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
    <view class="hero-section">
      <swiper
        class="hero-swiper"
        indicator-dots="{{work.images.length > 1}}"
        indicator-color="rgba(255,255,255,0.4)"
        indicator-active-color="#4A90E2"
        circular="{{work.images.length > 1}}"
        bindchange="onImageChange"
      >
        <block wx:for="{{work.images}}" wx:key="index">
          <swiper-item>
            <image
              src="{{item.temp_url || item.url}}"
              mode="aspectFit"
              class="hero-image"
              data-index="{{index}}"
              bindtap="openImageViewer"
              bindlongpress="onImageLongPress"
              bindload="onImageLoad"
              binderror="onImageError"
              lazy-load="true"
            />
          </swiper-item>
        </block>
      </swiper>

      <!-- å›¾ç‰‡æµ®å±‚ä¿¡æ¯ -->
      <view class="hero-overlay">
        <!-- å›¾ç‰‡è®¡æ•° -->
        <view class="image-counter" wx:if="{{work.images.length > 1}}">
          <text>{{currentImageIndex + 1}} / {{work.images.length}}</text>
        </view>

        <!-- å¿«æ·æ“ä½œ -->
        <view class="quick-actions">
          <button class="quick-btn" bindtap="enterFullscreen">
            <text class="iconfont icon-search"></text>
            <text>å…¨å±</text>
          </button>
          <button class="quick-btn {{work.is_favorite ? 'active' : ''}}" bindtap="toggleFavorite">
            <text class="iconfont {{work.is_favorite ? 'icon-heart-fill' : 'icon-heart'}}"></text>
            <text>{{work.is_favorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
          </button>
        </view>
      </view>
    </view>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <view class="content-area">
      <!-- ä½œå“ä¿¡æ¯å¡ç‰‡ -->
      <view class="info-card">
        <view class="work-header">
          <view class="title-section">
            <view class="title-container">
              <text class="work-title" wx:if="{{!editingTitle}}" bindtap="startEditTitle">{{work.title || 'ç‚¹å‡»è®¾ç½®ä½œå“åç§°'}}</text>
              <input class="title-input" wx:else value="{{editingTitleValue}}" bindinput="onTitleInput" bindblur="finishEditTitle" bindconfirm="finishEditTitle" placeholder="è¯·è¾“å…¥ä½œå“åç§°" auto-focus="true" />
              <button class="edit-title-btn" wx:if="{{!editingTitle}}" bindtap="startEditTitle">
                <text class="iconfont icon-edit"></text>
              </button>
            </view>
            <view class="work-tags">
              <text class="tag primary">
                {{work.type === 'photography' ? 'AIæ‘„å½±' : 'AIè¯•è¡£'}}
              </text>
              <text class="tag {{work.status === 'completed' ? 'success' : 'warning'}}" wx:if="{{work.status}}">
                {{work.status === 'completed' ? 'å·²å®Œæˆ' : work.status}}
              </text>
            </view>
          </view>

          <view class="work-meta">
            <view class="meta-item">
              <text class="iconfont icon-time"></text>
              <text>{{formatTime(work.created_at)}}</text>
            </view>
            <view class="meta-item" wx:if="{{work.scene_name}}">
              <text class="iconfont icon-location"></text>
              <text>{{work.scene_name}}</text>
            </view>
          </view>
        </view>

        <!-- æ‘„å½±å¸ˆè¯´ï¼ˆAIè¿”å›çš„æ–‡å­—æè¿°ï¼‰ -->
        <view wx:if="{{work.ai_description}}" class="ai-section">
          <view class="section-header">
            <view class="header-left">
              <text class="iconfont icon-robot"></text>
              <text>æ‘„å½±å¸ˆè¯´</text>
            </view>
            <button class="copy-btn" bindtap="copyAIDescription">
              <text class="iconfont icon-copy"></text>
              <text>å¤åˆ¶</text>
            </button>
          </view>
          <view class="ai-content">
            <text>{{work.ai_description}}</text>
          </view>
        </view>

        <!-- åŸå›¾å¯¹æ¯” -->
        <view wx:if="{{originalImagesUrls && originalImagesUrls.length > 0}}" class="original-images-section">
          <view class="section-header">
            <view class="header-left">
              <text class="iconfont icon-image"></text>
              <text>åŸå›¾å‚è€ƒ</text>
            </view>
            <text class="image-count">{{originalImagesUrls.length}}å¼ </text>
          </view>
          <view class="original-images-grid">
            <block wx:for="{{originalImagesUrls}}" wx:key="index">
              <view class="original-image-item" bindtap="previewOriginalImage" data-index="{{index}}">
                <image
                  src="{{item.url}}"
                  mode="aspectFill"
                  class="original-image"
                  lazy-load="true"
                />
                <view class="image-type-tag" wx:if="{{item.typeLabel}}">{{item.typeLabel}}</view>
              </view>
            </block>
          </view>
        </view>

        <!-- ç”Ÿæˆå‚æ•° -->
        <view wx:if="{{work.parameters}}" class="info-group">
          <view class="info-group-header" bindtap="toggleParams">
            <view class="info-group-title">
              <text class="iconfont icon-settings"></text>
              <text>ç”Ÿæˆå‚æ•°</text>
            </view>
            <view class="info-group-summary">
              <text wx:if="{{!showParams}}">ç‚¹å‡»æŸ¥çœ‹</text>
              <text class="iconfont {{showParams ? 'icon-up' : 'icon-down'}}"></text>
            </view>
          </view>
          <view wx:if="{{showParams}}" class="info-group-content">
            <view class="params-grid">
              <!-- æ‘„å½±å‚æ•° -->
              <block wx:if="{{work.type === 'photography'}}">
                <view class="param-chip" wx:if="{{work.parameters.gender}}">
                  <text class="param-label">æ€§åˆ«</text>
                  <text class="param-value">{{work.parameters.gender === 'female' ? 'å¥³æ€§' : 'ç”·æ€§'}}</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.age}}">
                  <text class="param-label">å¹´é¾„</text>
                  <text class="param-value">{{work.parameters.age}}å²</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.height}}">
                  <text class="param-label">èº«é«˜</text>
                  <text class="param-value">{{work.parameters.height}}cm</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.nationality}}">
                  <text class="param-label">ç±»å‹</text>
                  <text class="param-value">{{work.parameters.nationality}}</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.location}}">
                  <text class="param-label">åœºæ™¯</text>
                  <text class="param-value">{{work.parameters.location}}</text>
                </view>
              </block>

              <!-- è¯•è¡£å‚æ•° -->
              <block wx:elif="{{work.type === 'fitting'}}">
                <view class="param-chip" wx:if="{{work.parameters.overall_clothing_material}}">
                  <text class="param-label">æè´¨</text>
                  <text class="param-value">{{work.parameters.overall_clothing_material}}</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.pose_adjustment}}">
                  <text class="param-label">å§¿æ€</text>
                  <text class="param-value">{{work.parameters.pose_adjustment}}</text>
                </view>
              </block>
            </view>
          </view>
        </view>

        <!-- æŠ€æœ¯ä¿¡æ¯ï¼ˆç®€åŒ–ï¼‰ -->
        <view class="info-group" wx:if="{{work.images[0].width || work.api_provider}}">
          <view class="info-group-header" bindtap="toggleTechInfo">
            <view class="info-group-title">
              <text class="iconfont icon-info"></text>
              <text>æŠ€æœ¯ä¿¡æ¯</text>
            </view>
            <view class="info-group-summary">
              <text wx:if="{{!showTechExpanded}}">{{work.images[0].width}}Ã—{{work.images[0].height}}</text>
              <text class="iconfont {{showTechExpanded ? 'icon-up' : 'icon-down'}}"></text>
            </view>
          </view>
          <view wx:if="{{showTechExpanded}}" class="info-group-content">
            <view class="tech-grid">
              <view class="tech-chip" wx:if="{{work.images[0].width}}">
                <text class="tech-label">åˆ†è¾¨ç‡</text>
                <text class="tech-value">{{work.images[0].width}}Ã—{{work.images[0].height}}</text>
              </view>
              <view class="tech-chip" wx:if="{{work.api_provider}}">
                <text class="tech-label">AIå¼•æ“</text>
                <text class="tech-value">{{work.api_provider}}</text>
              </view>
              <view class="tech-chip" wx:if="{{work.generation_time}}">
                <text class="tech-label">ç”Ÿæˆæ—¶é—´</text>
                <text class="tech-value">{{work.generation_time}}ç§’</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
    <view class="action-area">
      <view class="primary-actions">
        <button class="action-btn primary" bindtap="regenerate">
          <text class="iconfont icon-refresh"></text>
          <text>åŒæ¬¾å†ç”Ÿ</text>
        </button>

        <button class="action-btn highlight" bindtap="showPoseVariationModal">
          <text class="iconfont">ğŸ­</text>
          <text>å§¿åŠ¿è£‚å˜</text>
        </button>

        <button class="action-btn secondary" bindtap="saveToAlbum">
          <text class="iconfont icon-download"></text>
          <text>ä¿å­˜å›¾ç‰‡</text>
        </button>
      </view>

      <view class="secondary-actions">
        <button class="action-btn ghost" open-type="share">
          <text class="iconfont icon-share"></text>
          <text>åˆ†äº«</text>
        </button>

        <button class="action-btn ghost" bindtap="generateSharePoster">
          <text class="iconfont icon-image"></text>
          <text>ç”Ÿæˆæµ·æŠ¥</text>
        </button>

        <button class="action-btn ghost" bindtap="submitFeedback">
          <text class="iconfont icon-edit"></text>
          <text>åé¦ˆ</text>
        </button>

        <button class="action-btn danger" bindtap="deleteWork">
          <text class="iconfont icon-delete"></text>
          <text>åˆ é™¤</text>
        </button>
      </view>
    </view>

    <!-- å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨ -->
    <view class="image-viewer" wx:if="{{showImageViewer}}" bindtap="closeImageViewer">
      <view class="viewer-container" catchtap="stopPropagation">
        <swiper
          class="viewer-swiper"
          indicator-dots="{{imageViewerUrls.length > 1}}"
          indicator-color="rgba(255,255,255,0.5)"
          indicator-active-color="#fff"
          circular="{{imageViewerUrls.length > 1}}"
          current="{{currentImageIndex}}"
          bindchange="onImageChange"
        >
          <block wx:for="{{imageViewerUrls}}" wx:key="index">
            <swiper-item>
              <image
                src="{{item}}"
                mode="aspectFit"
                class="viewer-image"
                data-index="{{index}}"
                bindlongpress="onImageLongPress"
              />
            </swiper-item>
          </block>
        </swiper>

        <!-- å…³é—­æŒ‰é’® -->
        <button class="close-btn" bindtap="closeImageViewer">âœ•</button>
      </view>
    </view>

    <!-- ğŸ­ å§¿åŠ¿è£‚å˜å¼¹çª— -->
    <view class="pose-variation-modal" wx:if="{{showPoseModal}}" bindtap="closePoseModal">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-header">
          <text class="modal-title">ğŸ­ å§¿åŠ¿è£‚å˜</text>
          <text class="modal-subtitle">ç”ŸæˆåŒæ¬¾æ¨¡ç‰¹çš„ä¸åŒå§¿åŠ¿</text>
        </view>

        <view class="modal-body">
          <!-- æ¨¡å¼é€‰æ‹© -->
          <view class="mode-selector">
            <view
              class="mode-option {{poseMode === 'preset' ? 'active' : ''}}"
              bindtap="selectPoseMode"
              data-mode="preset"
            >
              <text class="mode-icon">ğŸ“‹</text>
              <text class="mode-name">é€‰æ‹©å§¿åŠ¿</text>
            </view>
            <view
              class="mode-option {{poseMode === 'custom' ? 'active' : ''}}"
              bindtap="selectPoseMode"
              data-mode="custom"
            >
              <text class="mode-icon">âœï¸</text>
              <text class="mode-name">è‡ªå®šä¹‰</text>
            </view>
          </view>

          <!-- é¢„è®¾å§¿åŠ¿åˆ—è¡¨ -->
          <view class="pose-presets" wx:if="{{poseMode === 'preset'}}">
            <view wx:if="{{loadingPoses}}" class="loading-poses">
              <text>åŠ è½½å§¿åŠ¿åˆ—è¡¨ä¸­...</text>
            </view>
            <scroll-view wx:else scroll-y class="pose-scroll">
              <view
                class="pose-item {{selectedPoseId === item._id ? 'selected' : ''}}"
                wx:for="{{posePresets}}"
                wx:key="_id"
                bindtap="selectPose"
                data-id="{{item._id}}"
                data-name="{{item.name}}"
              >
                <text class="pose-emoji">{{item.icon_emoji}}</text>
                <view class="pose-info">
                  <text class="pose-name">{{item.name}}</text>
                  <text class="pose-desc">{{item.description}}</text>
                </view>
                <text class="iconfont icon-check" wx:if="{{selectedPoseId === item._id}}"></text>
              </view>
            </scroll-view>
          </view>

          <!-- è‡ªå®šä¹‰è¾“å…¥ -->
          <view class="custom-input" wx:if="{{poseMode === 'custom'}}">
            <textarea
              class="pose-textarea"
              placeholder="è¯·æè¿°æƒ³è¦çš„å§¿åŠ¿ï¼Œä¾‹å¦‚ï¼š&#10;&#10;æ¨¡ç‰¹ååœ¨ç™½è‰²æ–¹å‡³ä¸Šï¼ŒåŒè…¿ä¼˜é›…äº¤å ï¼Œä¸€åªæ‰‹è½»æ‰˜ä¸‹å·´ï¼Œå±•ç°æ€è€ƒçš„å§¿æ€..."
              value="{{customPoseDescription}}"
              bindinput="onCustomPoseInput"
              maxlength="500"
              show-confirm-bar="{{false}}"
            />
            <text class="char-count">{{customPoseDescription.length}}/500</text>
          </view>

          <!-- ç§¯åˆ†æç¤º -->
          <view class="credit-info">
            <text class="iconfont icon-coin"></text>
            <text>æ¶ˆè€— 1 ç§¯åˆ†</text>
          </view>
        </view>

        <view class="modal-footer">
          <button class="modal-btn cancel" bindtap="closePoseModal">å–æ¶ˆ</button>
          <button class="modal-btn confirm" bindtap="confirmPoseVariation" disabled="{{!canConfirm}}">
            å¼€å§‹è£‚å˜
          </button>
        </view>
      </view>
    </view>
  </block>
</view>