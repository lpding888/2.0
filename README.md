# AIæ‘„å½±å¸ˆå°ç¨‹åº

ä¸€æ¬¾åŸºäºå¾®ä¿¡äº‘å¼€å‘çš„AIæœè£…æ‘„å½±ä¸è™šæ‹Ÿè¯•è¡£å°ç¨‹åº,é€šè¿‡AIæŠ€æœ¯ä¸ºæœè£…å•†å®¶å’Œä¸ªäººç”¨æˆ·æä¾›ä¸“ä¸šçº§çš„å•†å“å±•ç¤ºç…§ç‰‡ã€‚

## é¡¹ç›®ç®€ä»‹

### æ ¸å¿ƒåŠŸèƒ½

AIæ‘„å½±å¸ˆå°ç¨‹åºä¸ºç”µå•†å–å®¶ã€æœè£…è®¾è®¡å¸ˆã€ä¸ªäººç”¨æˆ·æä¾›AIé©±åŠ¨çš„æœè£…æ‹æ‘„è§£å†³æ–¹æ¡ˆ,æ— éœ€å®æ‹ã€æ— éœ€æ£šæ‹,å³å¯è·å¾—ä¸“ä¸šçº§æ¨¡ç‰¹å±•ç¤ºæ•ˆæœã€‚

**ä¸»è¦ä½¿ç”¨åœºæ™¯:**
- ğŸ“¸ **ç”µå•†å–å®¶**: å¿«é€Ÿç”Ÿæˆå¤šåœºæ™¯å•†å“å›¾,æå‡è½¬åŒ–ç‡
- ğŸ‘” **æœè£…è®¾è®¡å¸ˆ**: å±•ç¤ºè®¾è®¡ä½œå“,èŠ‚çœæ‹æ‘„æˆæœ¬
- ğŸ›ï¸ **ä¸ªäººç”¨æˆ·**: è™šæ‹Ÿè¯•è¡£,æŸ¥çœ‹ä¸Šèº«æ•ˆæœ
- ğŸ¨ **è¥é”€å›¢é˜Ÿ**: æ‰¹é‡ç”Ÿæˆå¤šé£æ ¼ç´ æ,æ»¡è¶³å¤šæ¸ é“éœ€æ±‚

### æŠ€æœ¯ç‰¹ç‚¹

- âœ… **Serverlessæ¶æ„**: åŸºäºå¾®ä¿¡äº‘å¼€å‘,é›¶æœåŠ¡å™¨è¿ç»´
- âœ… **Fire-and-Forgetæ¨¡å¼**: å¼‚æ­¥Workerå¤„ç†,é¿å…è¶…æ—¶
- âœ… **Base64é¢„å¤„ç†**: å‰ç«¯é¢„å¤„ç†å›¾ç‰‡,é™ä½äº‘å‡½æ•°å†…å­˜å‹åŠ›
- âœ… **åŸå­æ“ä½œ**: æ•°æ®åº“åŸå­é€’å¢/é€’å‡,ä¿è¯å¹¶å‘å®‰å…¨
- âœ… **äº‘å‡½æ•°é¢„çƒ­**: å®šæ—¶pingé˜²æ­¢å†·å¯åŠ¨
- âœ… **æ™ºèƒ½ç¼“å­˜**: 5åˆ†é’ŸTTLç¼“å­˜,å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- âœ… **iOSæ”¯ä»˜é™åˆ¶**: è‡ªåŠ¨æ£€æµ‹iOSå¹³å°å¹¶å¼•å¯¼ç”¨æˆ·

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. AIæœè£…æ‘„å½±

ä¸Šä¼ æœè£…å›¾ç‰‡(å¹³é“ºå›¾/æŒ‚æ‹å›¾/æ¨¡ç‰¹å›¾),é€‰æ‹©æ‹æ‘„åœºæ™¯å’Œæ¨¡ç‰¹å‚æ•°,AIè‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçº§å•†å“å±•ç¤ºç…§ã€‚

**åŠŸèƒ½ç‰¹æ€§:**
- æ”¯æŒä¸Šä¼ 1-3å¼ æœè£…å›¾ç‰‡
- è‡ªå®šä¹‰åœºæ™¯æè¿°(æœ€å¤š500å­—)æˆ–é€‰æ‹©é¢„è®¾åœºæ™¯
- æ¨¡ç‰¹å‚æ•°å¯è°ƒ: æ€§åˆ«ã€å¹´é¾„ã€èº«é«˜ã€å›½ç±ã€è‚¤è‰²
- é«˜çº§é€‰é¡¹: åŠ¨ä½œå§¿åŠ¿ã€æœè£…æè´¨ã€æ­é…é£æ ¼ã€é…é¥°ã€æ°›å›´ã€å…‰çº¿
- å‚æ•°é¢„è®¾: ä¿å­˜å¸¸ç”¨é…ç½®,ä¸€é”®åŠ è½½
- æ¯æ¬¡ç”Ÿæˆæ¶ˆè€—1ç§¯åˆ†

**å®ç°è·¯å¾„:** `miniprogram/pages/photography/` + `cloudfunctions/photography/` + `cloudfunctions/photography-worker/`

### 2. AIè™šæ‹Ÿè¯•è¡£

ä¸Šä¼ äººç‰©ç…§ç‰‡å’Œæœè£…å›¾ç‰‡,AIè‡ªåŠ¨å°†æœè£…"ç©¿"åˆ°äººç‰©èº«ä¸Š,å®ç°è™šæ‹Ÿè¯•è¡£æ•ˆæœã€‚

**åŠŸèƒ½ç‰¹æ€§:**
- ä¸Šä¼ 1å¼ äººç‰©ç…§ç‰‡ + 1-3å¼ æœè£…å›¾ç‰‡
- æ”¯æŒè‡ªå®šä¹‰åœºæ™¯å’Œé¢„è®¾åœºæ™¯
- æ¯æ¬¡ç”Ÿæˆæ¶ˆè€—1ç§¯åˆ†

**å®ç°è·¯å¾„:** `miniprogram/pages/fitting/` + `cloudfunctions/fitting/` + `cloudfunctions/fitting-worker/`

### 3. å§¿åŠ¿è£‚å˜

åŸºäºå·²æœ‰ä½œå“,ä¿æŒæœè£…å’Œåœºæ™¯ä¸å˜,ä»…æ”¹å˜æ¨¡ç‰¹å§¿åŠ¿,å¿«é€Ÿç”Ÿæˆå¤šç»„ä¸åŒåŠ¨ä½œçš„ç…§ç‰‡ã€‚

**åŠŸèƒ½ç‰¹æ€§:**
- ä»ç°æœ‰ä½œå“å‘èµ·è£‚å˜
- è‡ªå®šä¹‰å§¿åŠ¿æè¿°æˆ–é€‰æ‹©é¢„è®¾å§¿åŠ¿
- å¤ç”¨åŸä½œå“çš„æœè£…å’Œåœºæ™¯ä¿¡æ¯
- æ¯æ¬¡ç”Ÿæˆæ¶ˆè€—1ç§¯åˆ†

**å®ç°è·¯å¾„:** `miniprogram/pages/work-detail/` â†’ `photography` äº‘å‡½æ•°(`mode: 'pose_variation'`)

### 4. æˆ‘çš„ä½œå“

ç®¡ç†æ‰€æœ‰AIç”Ÿæˆçš„ä½œå“,æ”¯æŒæŸ¥çœ‹ã€ä¸‹è½½ã€æ”¶è—ã€åˆ é™¤ç­‰æ“ä½œã€‚

**åŠŸèƒ½ç‰¹æ€§:**
- ç€‘å¸ƒæµå±•ç¤º,åˆ†é¡µåŠ è½½(æ¯é¡µ20æ¡)
- ç­›é€‰: å…¨éƒ¨/æœè£…æ‘„å½±/è™šæ‹Ÿè¯•è¡£/æ”¶è—
- ä½œå“è¯¦æƒ…: æŸ¥çœ‹ç”Ÿæˆå‚æ•°ã€åŸå›¾ã€ä¸‹è½½ã€åˆ é™¤ã€æ”¶è—
- åˆ†äº«æµ·æŠ¥: ç”Ÿæˆå¸¦æ°´å°çš„åˆ†äº«å›¾(å¯é…ç½®æ°´å°å¼€å…³)
- å§¿åŠ¿è£‚å˜å…¥å£

**å®ç°è·¯å¾„:** `miniprogram/pages/works/` + `miniprogram/pages/work-detail/` + `cloudfunctions/api/`

### 5. ç§¯åˆ†ç³»ç»Ÿ

å®Œæ•´çš„ç§¯åˆ†å……å€¼ã€æ¶ˆè´¹ã€è®°å½•ç®¡ç†ä½“ç³»ã€‚

**ç§¯åˆ†è·å–:**
- ğŸ æ–°ç”¨æˆ·æ³¨å†Œ: +10 ç§¯åˆ†
- ğŸ“… æ¯æ—¥ç­¾åˆ°: +5 ç§¯åˆ†
- ğŸ¤ é‚€è¯·å¥½å‹: æ¯é‚€è¯·1äºº +10 ç§¯åˆ†(è¢«é‚€è¯·è€…ä¹Ÿè·å¾— +10)
- ğŸ’³ å……å€¼å¥—é¤:
  - 25ç§¯åˆ† = Â¥9.9
  - 60ç§¯åˆ† = Â¥19.9
  - 100ç§¯åˆ† = Â¥29.9
  - 300ç§¯åˆ† = Â¥79.9

**ç§¯åˆ†æ¶ˆè€—:**
- AIç”Ÿæˆ(æ‘„å½±/è¯•è¡£/å§¿åŠ¿è£‚å˜): æ¯å¼  -1 ç§¯åˆ†

**iOSé™åˆ¶:**
- è‡ªåŠ¨æ£€æµ‹iOSè®¾å¤‡,ç¦æ­¢è™šæ‹Ÿæ”¯ä»˜(ç¬¦åˆè‹¹æœæ”¿ç­–)
- å¼•å¯¼ç”¨æˆ·è”ç³»å®¢æœ(17620309403)æˆ–ä½¿ç”¨å®‰å“è®¾å¤‡å……å€¼

**å®ç°è·¯å¾„:** `miniprogram/pages/recharge/` + `miniprogram/pages/credits/` + `cloudfunctions/payment/` + `cloudfunctions/user/`

### 6. ç®¡ç†ä¸­å¿ƒ(éšè—åŠŸèƒ½)

ä¸ºç®¡ç†å‘˜æä¾›åå°ç®¡ç†åŠŸèƒ½,åŒ…æ‹¬åœºæ™¯ç®¡ç†ã€AIæ¨¡å‹é…ç½®ç­‰ã€‚

**æ¿€æ´»æ–¹å¼:** ä¸ªäººä¸­å¿ƒé¡µé¢,è¿ç»­ç‚¹å‡»å¤´åƒ15æ¬¡

**ç®¡ç†åŠŸèƒ½:**
- åœºæ™¯ç®¡ç†: ä¸Šä¼ åœºæ™¯å›¾ç‰‡ã€é…ç½®å‚æ•°
- AIæ¨¡å‹ç®¡ç†: é…ç½®å¤šä¸ªAPIå¯†é’¥ã€é€‰æ‹©AIæä¾›å•†
- ç”¨æˆ·ç®¡ç†: æŸ¥çœ‹ç”¨æˆ·æ•°æ®ã€è°ƒæ•´ç§¯åˆ†
- æƒé™æ§åˆ¶: åŸºäº `admin_users` é›†åˆçš„è§’è‰²éªŒè¯

**å®ç°è·¯å¾„:** `miniprogram/pages/subPackageAdmin/` + `cloudfunctions/scene/` + `cloudfunctions/aimodels/`

## æŠ€æœ¯æ¶æ„

### äº‘å‡½æ•°åˆ—è¡¨(16ä¸ª)

**æ ¸å¿ƒäº‘å‡½æ•°:**
- `user` - ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç§¯åˆ†æŸ¥è¯¢
- `api` - ä½œå“æŸ¥è¯¢ã€æ”¶è—ã€åˆ é™¤(ç»Ÿä¸€å…¥å£)
- `payment` - å……å€¼è®¢å•ã€å¥—é¤ç®¡ç†ã€æ”¯ä»˜å›è°ƒ
- `photography` - AIæ‘„å½±ä»»åŠ¡è°ƒåº¦(Fire-and-Forget)
- `fitting` - AIè¯•è¡£ä»»åŠ¡è°ƒåº¦(Fire-and-Forget)

**Workeräº‘å‡½æ•°:**
- `photography-worker` - æ‰§è¡ŒAIå›¾ç‰‡ç”Ÿæˆ(60-120s)
- `fitting-worker` - æ‰§è¡ŒAIè¯•è¡£ç”Ÿæˆ(60-120s)

**è¾…åŠ©äº‘å‡½æ•°:**
- `scene` - åœºæ™¯æ•°æ®ç®¡ç†
- `prompt` - AIæç¤ºè¯æ¨¡æ¿ç®¡ç†
- `storage` - äº‘å­˜å‚¨æ–‡ä»¶ç®¡ç†ã€å»é‡
- `aimodels` - AIæ¨¡å‹é…ç½®ã€å¯†é’¥è½®æ¢
- `auth` - æƒé™éªŒè¯ã€ç®¡ç†å‘˜æ£€æŸ¥
- `task-processor` - å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨
- `database-init` - æ•°æ®åº“åˆå§‹åŒ–
- `debug-scenes` - è°ƒè¯•åœºæ™¯æ•°æ®
- `force-admin` - å¼ºåˆ¶è®¾ç½®ç®¡ç†å‘˜æƒé™

### Fire-and-Forgetå¼‚æ­¥æ¨¡å¼

AIå›¾ç‰‡ç”Ÿæˆè€—æ—¶è¾ƒé•¿(60-120ç§’),å¾®ä¿¡äº‘å‡½æ•°æœ‰60ç§’è¶…æ—¶é™åˆ¶ã€‚é‡‡ç”¨**Fire-and-Forget**æ¨¡å¼è§£å†³:

```
ç”¨æˆ·å‘èµ·ç”Ÿæˆè¯·æ±‚
    â†“
photography äº‘å‡½æ•°(ä¸»å‡½æ•°)
    â”œâ”€ æ‰£é™¤ç§¯åˆ†(-1)
    â”œâ”€ åˆ›å»ºä»»åŠ¡è®°å½•(task_queue)
    â”œâ”€ åˆ›å»ºä½œå“è®°å½•(works, status=generating)
    â”œâ”€ å¼‚æ­¥è°ƒç”¨ photography-worker(ä¸ç­‰å¾…)
    â””â”€ ç«‹å³è¿”å› task_id å’Œ work_id(< 3ç§’)
         â†“
    ç”¨æˆ·æ”¶åˆ°å“åº”,è·³è½¬åˆ°ä½œå“é¡µ
         â€–
         â€–  (å¹¶è¡Œæ‰§è¡Œ,ä¸é˜»å¡ç”¨æˆ·)
         â€–
    photography-worker äº‘å‡½æ•°(ç‹¬ç«‹å®¹å™¨)
    â”œâ”€ ä¸‹è½½æœè£…å›¾ç‰‡(æ”¯æŒBase64é¢„å¤„ç†)
    â”œâ”€ è°ƒç”¨AIæœåŠ¡å•†APIç”Ÿæˆå›¾ç‰‡
    â”œâ”€ ä¸Šä¼ ç”Ÿæˆç»“æœåˆ°äº‘å­˜å‚¨
    â”œâ”€ æ›´æ–°ä½œå“çŠ¶æ€(status=completed/failed)
    â”œâ”€ æ›´æ–°ä»»åŠ¡çŠ¶æ€
    â””â”€ å¤±è´¥æ—¶è‡ªåŠ¨é€€æ¬¾(db.command.inc(1))
         â†“
    å‰ç«¯è½®è¯¢æˆ–åˆ·æ–°æŸ¥çœ‹ç»“æœ
```

**å…³é”®è®¾è®¡:**
- ä¸»å‡½æ•°åªæ•è·**çœŸæ­£çš„å¤±è´¥**(étimeout),åªæœ‰çœŸå¤±è´¥æ‰é€€æ¬¾
- Workerè¶…æ—¶ä¸é€€æ¬¾(å› ä¸ºåå°å¯èƒ½ä»åœ¨æ‰§è¡Œ)
- Workerå†…éƒ¨å¤±è´¥ä¼šæ‰§è¡Œé€€æ¬¾é€»è¾‘

### Base64é¢„å¤„ç†ä¼˜åŒ–

**é—®é¢˜:** äº‘å‡½æ•°å¤„ç†å¤šå¼ å›¾ç‰‡æ—¶,é¢‘ç¹è¿›è¡Œå›¾ç‰‡ä¸‹è½½ã€æ ¼å¼è½¬æ¢,å¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜,è§¦å‘ `RequestTooLarge` é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ:** å°†å›¾ç‰‡è½¬æ¢æ“ä½œå‰ç§»åˆ°å°ç¨‹åºç«¯

```
ä¼ ç»Ÿæ¨¡å¼:
  å°ç¨‹åº â†’ ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ â†’ äº‘å­˜å‚¨ â†’ Workerä¸‹è½½ â†’ è½¬æ¢Base64 â†’ è°ƒç”¨AI

ä¼˜åŒ–æ¨¡å¼(Base64é¢„å¤„ç†):
  å°ç¨‹åº â†’ è½¬æ¢Base64 â†’ ä¸Šä¼ Base64å­—ç¬¦ä¸² â†’ äº‘å­˜å‚¨ â†’ Workerç›´æ¥è¯»å– â†’ è°ƒç”¨AI
```

**å®ç°ç»†èŠ‚:**
- `miniprogram/utils/upload.js`: å¢åŠ  `base64Mode` å‚æ•°
- Workerå‡½æ•°æ£€æµ‹æ–‡ä»¶å†…å®¹:
  ```javascript
  const fileContent = downloadResult.fileContent.toString('utf8')
  if (fileContent.startsWith('data:image/')) {
    // Base64é¢„å¤„ç†æ¨¡å¼,ç›´æ¥ä½¿ç”¨
    const matches = fileContent.match(/^data:image\/([^;]+);base64,(.+)$/)
    base64Data = matches[2]
  } else {
    // å…¼å®¹æ—§æ¨¡å¼,è½¬æ¢äºŒè¿›åˆ¶æ•°æ®
    base64Data = downloadResult.fileContent.toString('base64')
  }
  ```

**æ•ˆæœ:**
- äº‘å‡½æ•°å†…å­˜å ç”¨é™ä½ 60%+
- ç”ŸæˆæˆåŠŸç‡æå‡è‡³ 95%+
- æ”¯æŒæ—§æ•°æ®å…¼å®¹

### äº‘å‡½æ•°é¢„çƒ­æœºåˆ¶

é˜²æ­¢å†·å¯åŠ¨å¯¼è‡´é¦–æ¬¡è°ƒç”¨å»¶è¿Ÿè¿‡é«˜ã€‚

**å®ç°:** `miniprogram/app.js`
```javascript
// æ¯4åˆ†é’Ÿé¢„çƒ­ä¸€æ¬¡
this.warmUpTimer = setInterval(() => {
  wx.cloud.callFunction({
    name: 'api',
    data: { action: 'ping', __noLoading: true }
  })
}, 4 * 60 * 1000)
```

## æ•°æ®åº“è®¾è®¡

### é›†åˆåˆ—è¡¨(14ä¸ª)

| é›†åˆå | è¯´æ˜ | ä¸»è¦å­—æ®µ |
|--------|------|----------|
| `users` | ç”¨æˆ·ä¿¡æ¯ | openid, nickname, avatar, credits, total_earned_credits, invite_code |
| `works` | AIç”Ÿæˆä½œå“ | work_id, user_openid, type, status, images, parameters, scene_id |
| `task_queue` | ä»»åŠ¡é˜Ÿåˆ— | task_id, user_openid, status, work_id, parameters, created_at |
| `credit_records` | ç§¯åˆ†è®°å½• | user_openid, type, amount, description, balance_after, created_at |
| `orders` | å……å€¼è®¢å• | order_id, user_openid, package_id, amount, status, payment_result |
| `packages` | å……å€¼å¥—é¤ | package_id, credits, price, name, description, enabled |
| `scenes` | æ‹æ‘„åœºæ™¯ | scene_id, name, thumbnail_url, category, parameters, enabled |
| `prompt_templates` | AIæç¤ºè¯æ¨¡æ¿ | template_id, name, template, variables, category |
| `aimodels` | AIæ¨¡å‹é…ç½® | model_id, provider, api_key, model_name, enabled, priority |
| `daily_checkins` | ç­¾åˆ°è®°å½• | user_openid, checkin_date, created_at |
| `invite_records` | é‚€è¯·è®°å½• | inviter_openid, invitee_openid, invite_code, reward_status |
| `pose_presets` | å§¿åŠ¿é¢„è®¾ | preset_id, name, description, category, thumbnail_url |
| `admin_users` | ç®¡ç†å‘˜ | openid, role, permissions, created_at |
| `logs` | ç³»ç»Ÿæ—¥å¿— | log_id, level, message, function_name, created_at |

### æ ¸å¿ƒé›†åˆè¯¦è§£

#### users(ç”¨æˆ·è¡¨)

```javascript
{
  "_id": "auto",
  "openid": "oXXXX",              // å¾®ä¿¡openid(å”¯ä¸€)
  "nickname": "ç”¨æˆ·æ˜µç§°",
  "avatar": "https://...",        // å¤´åƒURL
  "credits": 120,                 // å½“å‰ç§¯åˆ†ä½™é¢
  "total_earned_credits": 150,    // ç´¯è®¡è·å¾—ç§¯åˆ†
  "total_spent_credits": 30,      // ç´¯è®¡æ¶ˆè´¹ç§¯åˆ†
  "invite_code": "ABC123",        // é‚€è¯·ç (6ä½éšæœº)
  "invited_by": "oYYYY",          // é‚€è¯·äººopenid
  "created_at": Date,             // æ³¨å†Œæ—¶é—´
  "last_login_at": Date           // æœ€åç™»å½•æ—¶é—´
}
```

#### works(ä½œå“è¡¨)

```javascript
{
  "_id": "auto",
  "work_id": "work_1234567890",   // ä½œå“ID
  "user_openid": "oXXXX",         // åˆ›å»ºè€…
  "type": "photography",          // ç±»å‹: photography / fitting / pose_variation
  "status": "completed",          // çŠ¶æ€: generating / completed / failed
  "mode": "normal",               // æ¨¡å¼: normal / pose_variation

  // è¾“å…¥æ•°æ®
  "images": [                     // åŸå§‹å›¾ç‰‡URLæ•°ç»„
    { "url": "cloud://...", "type": "clothing" }
  ],
  "parameters": {                 // ç”Ÿæˆå‚æ•°
    "gender": "female",
    "age": 25,
    "height": 170,
    "nationality": "asian",
    "skin_tone": "fair",
    "location": "æˆ·å¤–Â·æ¹–è¾¹æœ¨æ ˆé“",
    "pose_type": "è‡ªç„¶ç«™å§¿",
    // ... å…¶ä»–å‚æ•°
  },
  "scene_id": "scene_123",        // åœºæ™¯ID(å¦‚æœä½¿ç”¨é¢„è®¾åœºæ™¯)
  "scene_info": { ... },          // åœºæ™¯è¯¦ç»†ä¿¡æ¯

  // è¾“å‡ºæ•°æ®
  "generated_images": [           // ç”Ÿæˆçš„å›¾ç‰‡URLæ•°ç»„
    {
      "url": "cloud://...",
      "size": 1024000,
      "format": "png"
    }
  ],

  // å…ƒæ•°æ®
  "task_id": "task_123",          // å…³è”ä»»åŠ¡ID
  "ai_model": "model_456",        // ä½¿ç”¨çš„AIæ¨¡å‹
  "generation_time": 45000,       // ç”Ÿæˆè€—æ—¶(æ¯«ç§’)
  "is_favorite": false,           // æ˜¯å¦æ”¶è—
  "created_at": Date,             // åˆ›å»ºæ—¶é—´
  "updated_at": Date              // æ›´æ–°æ—¶é—´
}
```

#### credit_records(ç§¯åˆ†è®°å½•è¡¨)

```javascript
{
  "_id": "auto",
  "user_openid": "oXXXX",
  "type": "consume",              // ç±»å‹: earn / consume / refund
  "amount": 1,                    // ç§¯åˆ†æ•°é‡(æ­£æ•°)
  "description": "AIæ‘„å½±ç”Ÿæˆ",    // æè¿°
  "balance_after": 119,           // æ“ä½œåä½™é¢
  "order_id": "order_123",        // å…³è”è®¢å•ID(å……å€¼æ—¶)
  "work_id": "work_456",          // å…³è”ä½œå“ID(æ¶ˆè´¹/é€€æ¬¾æ—¶)
  "task_id": "task_789",          // å…³è”ä»»åŠ¡ID
  "created_at": Date
}
```

**ç§¯åˆ†ç±»å‹(type):**
- `signup_bonus` - æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ± (+10)
- `daily_checkin` - æ¯æ—¥ç­¾åˆ° (+5)
- `invite_reward` - é‚€è¯·å¥–åŠ± (+10)
- `recharge` - å……å€¼è·å¾—
- `consume` - ç”Ÿæˆæ¶ˆè´¹ (-1)
- `refund` - ç”Ÿæˆå¤±è´¥é€€æ¬¾ (+1)

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **å¾®ä¿¡å¼€å‘è€…å·¥å…·**: æœ€æ–°ç¨³å®šç‰ˆ
- **Node.js**: v14+ (ç”¨äºäº‘å‡½æ•°å¼€å‘)
- **å¾®ä¿¡äº‘å¼€å‘è´¦å·**: å·²å¼€é€šäº‘å¼€å‘æœåŠ¡
- **äº‘ç¯å¢ƒID**: cloudbase-0gu1afji26f514d2

### æœ¬åœ°å¼€å‘

1. **é…ç½®äº‘ç¯å¢ƒ**
   - ä¿®æ”¹ `miniprogram/app.js` ä¸­çš„äº‘ç¯å¢ƒID(å¦‚éœ€æ›´æ¢)

2. **å®‰è£…äº‘å‡½æ•°ä¾èµ–**
   ```bash
   # ä¸ºæ¯ä¸ªäº‘å‡½æ•°å®‰è£…ä¾èµ–
   cd cloudfunctions/user
   npm install
   # ... é‡å¤å…¶ä»–äº‘å‡½æ•°
   ```

3. **ä¸Šä¼ äº‘å‡½æ•°**
   - ä½¿ç”¨éƒ¨ç½²è„šæœ¬:
     ```powershell
     .\scripts\deploy\deploy-cloudfunctions.ps1
     ```
   - æˆ–åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰‹åŠ¨ä¸Šä¼ 

4. **åˆå§‹åŒ–æ•°æ®åº“**
   ```bash
   node scripts/setup/database-init.js
   ```

5. **é…ç½®ç¯å¢ƒå˜é‡**
   - åœ¨äº‘å¼€å‘æ§åˆ¶å°é…ç½®:
     - `ADMIN_OPENIDS`: ç®¡ç†å‘˜openidåˆ—è¡¨
     - `WATERMARK_ENABLED`: æ˜¯å¦å¯ç”¨æ°´å°
     - `WECHAT_PAY_MCHID`: å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·
     - `WECHAT_PAY_KEY`: å¾®ä¿¡æ”¯ä»˜APIå¯†é’¥

### é…ç½®AIæ¨¡å‹

1. ç™»å½•ç®¡ç†åå°(ä¸ªäººä¸­å¿ƒè¿ç»­ç‚¹å‡»å¤´åƒ15æ¬¡)
2. è¿›å…¥"AIæ¨¡å‹ç®¡ç†"
3. æ·»åŠ AI APIå¯†é’¥(Google/OpenAI/Anthropic)

### é…ç½®åœºæ™¯æ•°æ®

1. åœ¨ç®¡ç†åå°"åœºæ™¯ç®¡ç†"ä¸­æ·»åŠ åœºæ™¯
2. æˆ–ä½¿ç”¨è„šæœ¬å¯¼å…¥é»˜è®¤åœºæ™¯

## éƒ¨ç½²æ¸…å•

- [ ] å·²ä¸Šä¼ æ‰€æœ‰äº‘å‡½æ•°
- [ ] å·²åˆå§‹åŒ–æ•°æ®åº“é›†åˆå’Œç´¢å¼•
- [ ] å·²é…ç½®AIæ¨¡å‹APIå¯†é’¥
- [ ] å·²é…ç½®å¾®ä¿¡æ”¯ä»˜å‚æ•°
- [ ] å·²ä¸Šä¼ æ‹æ‘„åœºæ™¯
- [ ] å·²è®¾ç½®ç®¡ç†å‘˜è´¦å·
- [ ] å·²é…ç½®äº‘å­˜å‚¨å®‰å…¨è§„åˆ™
- [ ] å·²é…ç½®æ•°æ®åº“æƒé™è§„åˆ™

## ç»´æŠ¤æ‰‹å†Œ

### å¸¸è§é—®é¢˜å¤„ç†

#### 1. ç”¨æˆ·ç§¯åˆ†å¼‚å¸¸

æŸ¥è¯¢ç§¯åˆ†è®°å½•:
```javascript
db.collection('credit_records')
  .where({ user_openid: '<openid>' })
  .orderBy('created_at', 'desc')
  .limit(50)
  .get()
```

#### 2. AIç”Ÿæˆå¤±è´¥ç‡é«˜

- æŸ¥çœ‹Workeräº‘å‡½æ•°æ—¥å¿—
- æ£€æŸ¥AIæ¨¡å‹é…ç½®
- æ£€æŸ¥APIå¯†é’¥æ˜¯å¦è¿‡æœŸ
- æ·»åŠ å¤‡ç”¨APIå¯†é’¥

#### 3. æ”¯ä»˜å›è°ƒæœªè§¦å‘

- æŸ¥è¯¢è®¢å•çŠ¶æ€
- æ£€æŸ¥paymentäº‘å‡½æ•°æ—¥å¿—
- æ‰‹åŠ¨è§¦å‘æ”¯ä»˜å›è°ƒ

### æ•°æ®åº“ç»´æŠ¤

1. **æ¸…ç†è¿‡æœŸè®¢å•**(å»ºè®®æ¯å‘¨)
2. **æ¸…ç†å¤±è´¥ä»»åŠ¡**(å»ºè®®æ¯å¤©)
3. **æ•°æ®å¤‡ä»½**(å»ºè®®æ¯å¤©)

## å¸¸è§é—®é¢˜ FAQ

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„ç®¡ç†å‘˜?

```bash
node scripts/setup/setup-admin-user.js --openid=<user_openid>
```

### Q2: å¦‚ä½•ä¿®æ”¹å……å€¼å¥—é¤ä»·æ ¼?

åœ¨æ•°æ®åº“ `packages` é›†åˆä¸­ç›´æ¥ä¿®æ”¹

### Q3: å¦‚ä½•å…³é—­æ°´å°åŠŸèƒ½?

åœ¨äº‘å¼€å‘æ§åˆ¶å°è®¾ç½®ç¯å¢ƒå˜é‡ `WATERMARK_ENABLED = false`

### Q4: ä¸ºä»€ä¹ˆiOSè®¾å¤‡æ— æ³•å……å€¼?

æ ¹æ®è‹¹æœæ”¿ç­–,iOSåº”ç”¨å†…è´­ä¹°è™šæ‹Ÿå•†å“å¿…é¡»ä½¿ç”¨è‹¹æœIAP,ä¸å…è®¸ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜ã€‚å·²è‡ªåŠ¨æ£€æµ‹iOSå¹³å°å¹¶é˜»æ­¢æ”¯ä»˜ã€‚

### Q5: å¦‚ä½•å¤‡ä»½å’Œæ¢å¤æ•°æ®?

```bash
# å¤‡ä»½
tcb db export -e <env-id> -c users,works,orders --file-path ./backup

# æ¢å¤
tcb db import -e <env-id> -c users --file-path ./backup/users.json
```

## æŠ€æœ¯æ”¯æŒ

**å®¢æœç”µè¯/å¾®ä¿¡**: 17620309403
**å·¥ä½œæ—¶é—´**: 9:00 - 22:00

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-10-05)

**æ–°åŠŸèƒ½:**
- âœ… å®Œæ•´çš„AIæœè£…æ‘„å½±å’Œè™šæ‹Ÿè¯•è¡£åŠŸèƒ½
- âœ… å§¿åŠ¿è£‚å˜åŠŸèƒ½
- âœ… ç§¯åˆ†ç³»ç»Ÿ(å……å€¼ã€æ¶ˆè´¹ã€ç­¾åˆ°ã€é‚€è¯·)
- âœ… iOSæ”¯ä»˜é™åˆ¶æ£€æµ‹
- âœ… ç®¡ç†åå°(åœºæ™¯ç®¡ç†ã€AIæ¨¡å‹ç®¡ç†)
- âœ… è‡ªå®šä¹‰åœºæ™¯æ”¯æŒ500å­—æè¿°

**æŠ€æœ¯ä¼˜åŒ–:**
- âœ… Fire-and-Forgetå¼‚æ­¥æ¨¡å¼
- âœ… Base64é¢„å¤„ç†ä¼˜åŒ–
- âœ… äº‘å‡½æ•°é¢„çƒ­æœºåˆ¶
- âœ… æ™ºèƒ½ç¼“å­˜(5åˆ†é’ŸTTL)
- âœ… åŸå­æ“ä½œä¿è¯å¹¶å‘å®‰å…¨

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-10-05
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0
**ç»´æŠ¤è€…**: AIæ‘„å½±å¸ˆå¼€å‘å›¢é˜Ÿ
